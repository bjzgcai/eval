{
  "cached_at": "2025-12-22T15:32:06.793399",
  "commit_sha": "73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
  "repo": "shuxueshuxue/SpexFlow",
  "data": {
    "sha": "73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
    "node_id": "C_kwDOQnjG49oAKDczYmMwZjUyN2U0ZTk1YTMzN2ZlMWNkMTc2MzZjMWJjN2Y4MWQzMGU",
    "commit": {
      "author": {
        "name": "shuxueshuxue",
        "email": "lexicalmathical@gmail.com",
        "date": "2025-12-15T08:01:15Z"
      },
      "committer": {
        "name": "shuxueshuxue",
        "email": "lexicalmathical@gmail.com",
        "date": "2025-12-15T08:01:15Z"
      },
      "message": "change default settings",
      "tree": {
        "sha": "660fa6751b44c90059d883608c584ea3344779ac",
        "url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/git/trees/660fa6751b44c90059d883608c584ea3344779ac"
      },
      "url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/git/commits/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null,
        "verified_at": null
      }
    },
    "url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/commits/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
    "html_url": "https://github.com/shuxueshuxue/SpexFlow/commit/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
    "comments_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/commits/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/comments",
    "author": null,
    "committer": null,
    "parents": [
      {
        "sha": "0d665fb171cdf0c6e701f553b057a0b686bc3bf7",
        "url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/commits/0d665fb171cdf0c6e701f553b057a0b686bc3bf7",
        "html_url": "https://github.com/shuxueshuxue/SpexFlow/commit/0d665fb171cdf0c6e701f553b057a0b686bc3bf7"
      }
    ],
    "stats": {
      "total": 541,
      "additions": 252,
      "deletions": 289
    },
    "files": [
      {
        "sha": "44fcbdd2b6e4c83f059dd096b138a72d3bc8cef0",
        "filename": ".gitignore",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/shuxueshuxue/SpexFlow/blob/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/.gitignore",
        "raw_url": "https://github.com/shuxueshuxue/SpexFlow/raw/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/.gitignore",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/contents/.gitignore?ref=73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
        "patch": "@@ -26,4 +26,4 @@ dist-ssr\n .apikey\n .llmkey\n data.json\n-.llmkey\n+backup/*"
      },
      {
        "sha": "1e317b95867ba1fc39cc5a966cf74510ddc8b564",
        "filename": "server/appData.ts",
        "status": "modified",
        "additions": 13,
        "deletions": 113,
        "changes": 126,
        "blob_url": "https://github.com/shuxueshuxue/SpexFlow/blob/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/server%2FappData.ts",
        "raw_url": "https://github.com/shuxueshuxue/SpexFlow/raw/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/server%2FappData.ts",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/contents/server%2FappData.ts?ref=73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
        "patch": "@@ -1,5 +1,6 @@\n import { readFile, writeFile } from 'node:fs/promises'\n import path from 'node:path'\n+import { defaultAPISettings, defaultAppData } from './defaultData.js'\n import type {\n   APISettings,\n   AppData as AppDataBase,\n@@ -238,43 +239,6 @@ function normalizeNode(raw: unknown): AppNode | null {\n   }\n }\n \n-function defaultAPISettings(): APISettings {\n-  return {\n-    codeSearch: {\n-      activeProvider: 'relace',\n-      providers: [\n-        { id: 'relace', name: 'Relace', apiKey: '' }\n-      ]\n-    },\n-    llm: {\n-      providers: [\n-        {\n-          id: 'openai',\n-          name: 'OpenAI',\n-          endpoint: 'https://api.openai.com/v1',\n-          apiKey: '',\n-          models: [\n-            { id: 'openai-gpt-4', name: 'GPT-4' },\n-            { id: 'openai-gpt-4-turbo', name: 'GPT-4 Turbo' },\n-            { id: 'openai-gpt-3.5-turbo', name: 'GPT-3.5 Turbo' },\n-          ]\n-        },\n-        {\n-          id: 'anthropic',\n-          name: 'Anthropic',\n-          endpoint: 'https://api.anthropic.com/v1',\n-          apiKey: '',\n-          models: [\n-            { id: 'anthropic-claude-3-opus', name: 'Claude 3 Opus' },\n-            { id: 'anthropic-claude-3-sonnet', name: 'Claude 3 Sonnet' },\n-            { id: 'anthropic-claude-3-haiku', name: 'Claude 3 Haiku' },\n-          ]\n-        }\n-      ]\n-    }\n-  }\n-}\n-\n function normalizeAPISettings(raw: unknown): APISettings {\n   const defaults = defaultAPISettings()\n   const obj = asRecord(raw)\n@@ -402,9 +366,11 @@ function normalizeAppData(raw: unknown): AppData {\n     })\n     .filter(isNonNull)\n \n-  const activeTabId = normalizeString(root.activeTabId) || (tabs[0]?.id ?? null)\n+  const activeTabIdRaw = normalizeString(root.activeTabId)\n+  const activeTabId = tabs.some((t) => t.id === activeTabIdRaw) ? activeTabIdRaw : (tabs[0]?.id ?? null)\n   const apiSettings = normalizeAPISettings(root.apiSettings)\n   const ui = normalizeUISettings(root.ui)\n+  if (tabs.length === 0) return { ...defaultAppData(), apiSettings, ui }\n   return {\n     version: typeof root.version === 'number' ? root.version : 1,\n     tabs,\n@@ -414,90 +380,24 @@ function normalizeAppData(raw: unknown): AppData {\n   }\n }\n \n-export function defaultAppData(): AppData {\n-  const now = new Date().toISOString()\n-  return {\n-    version: 1,\n-    activeTabId: 'tab_1',\n-    tabs: [\n-      {\n-        id: 'tab_1',\n-        name: 'Canvas 1',\n-        createdAt: now,\n-        canvas: {\n-          nodes: [\n-            {\n-              id: 'n_search',\n-              type: 'code-search',\n-              position: { x: 60, y: 80 },\n-              data: {\n-                title: 'Code Search',\n-                status: 'idle',\n-                error: null,\n-                locked: false,\n-                muted: false,\n-                repoPath: 'examples/example-repo',\n-                query: 'How is user authentication handled in this codebase?',\n-                debugMessages: false,\n-                output: null,\n-              },\n-            },\n-            {\n-              id: 'n_ctx',\n-              type: 'context-converter',\n-              position: { x: 420, y: 80 },\n-              data: {\n-                title: 'Context',\n-                status: 'idle',\n-                error: null,\n-                locked: false,\n-                muted: false,\n-                fullFile: true,\n-                output: null,\n-              },\n-            },\n-            {\n-              id: 'n_llm',\n-              type: 'llm',\n-              position: { x: 800, y: 80 },\n-              data: {\n-                title: 'LLM',\n-                status: 'idle',\n-                error: null,\n-                locked: false,\n-                muted: false,\n-                model: 'x-ai/grok-4.1-fast',\n-                systemPrompt:\n-                  'You are a senior software engineer. Given code context, propose a concrete implementation plan and the key files to edit.',\n-                query: 'Propose a plan to improve this authentication design.',\n-                output: null,\n-              },\n-            },\n-          ],\n-          edges: [\n-            { id: 'e_search_ctx', source: 'n_search', target: 'n_ctx' },\n-            { id: 'e_ctx_llm', source: 'n_ctx', target: 'n_llm' },\n-          ],\n-          viewport: { x: 0, y: 0, zoom: 1 },\n-        },\n-      },\n-    ],\n-    apiSettings: defaultAPISettings(),\n-    ui: { language: 'en' },\n-  }\n-}\n-\n const dataPath = path.join(process.cwd(), 'data.json')\n \n export async function loadAppData(): Promise<AppData> {\n+  let raw: string\n   try {\n-    const raw = await readFile(dataPath, 'utf-8')\n-    return normalizeAppData(JSON.parse(raw))\n+    raw = await readFile(dataPath, 'utf-8')\n   } catch (err: unknown) {\n     const code = (err as NodeJS.ErrnoException).code\n     if (code === 'ENOENT') return defaultAppData()\n     throw err\n   }\n+\n+  try {\n+    return normalizeAppData(JSON.parse(raw))\n+  } catch (err: unknown) {\n+    console.error(err)\n+    return defaultAppData()\n+  }\n }\n \n export async function saveAppData(data: AppData): Promise<void> {"
      },
      {
        "sha": "59fc91e3abe5b3e0166ab05b83129cb8ed1ae88f",
        "filename": "server/defaultData.ts",
        "status": "added",
        "additions": 120,
        "deletions": 0,
        "changes": 120,
        "blob_url": "https://github.com/shuxueshuxue/SpexFlow/blob/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/server%2FdefaultData.ts",
        "raw_url": "https://github.com/shuxueshuxue/SpexFlow/raw/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/server%2FdefaultData.ts",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/contents/server%2FdefaultData.ts?ref=73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
        "patch": "@@ -0,0 +1,120 @@\n+import type { APISettings } from '../shared/appDataTypes.js'\n+import type { AppData, Canvas } from './appData.js'\n+\n+function nowIso() {\n+  return new Date().toISOString()\n+}\n+\n+export function defaultAPISettings(): APISettings {\n+  return {\n+    codeSearch: {\n+      activeProvider: 'relace',\n+      providers: [\n+        { id: 'relace', name: 'Relace', apiKey: '' },\n+      ],\n+    },\n+    llm: {\n+      providers: [\n+        {\n+          id: 'openai',\n+          name: 'OpenAI',\n+          endpoint: 'https://api.openai.com/v1',\n+          apiKey: '',\n+          models: [\n+            { id: 'gpt-4o', name: 'GPT-4o' },\n+            { id: 'gpt-5.2', name: 'GPT-5.2' },\n+          ],\n+        },\n+        {\n+          id: 'openrouter',\n+          name: 'OpenRouter',\n+          endpoint: 'https://openrouter.ai/api/v1',\n+          apiKey: '',\n+          models: [\n+            { id: 'openai/gpt-4o', name: 'openai/gpt-4o' },\n+            { id: 'openai/gpt-5.2', name: 'openai/gpt-5.2' },\n+            { id: 'x-ai/grok-4.1-fast', name: 'x-ai/grok-4.1-fast' },\n+            { id: 'deepseek/deepseek-v3.2', name: 'deepseek/deepseek-v3.2' },\n+          ],\n+        },\n+      ],\n+    },\n+  }\n+}\n+\n+export function defaultCanvas(): Canvas {\n+  return {\n+    nodes: [\n+      {\n+        id: 'n_search',\n+        type: 'code-search',\n+        position: { x: 60, y: 80 },\n+        data: {\n+          title: 'Code Search',\n+          status: 'idle',\n+          error: null,\n+          locked: false,\n+          muted: false,\n+          repoPath: 'examples/example-repo',\n+          query: 'How is user authentication handled in this codebase?',\n+          debugMessages: false,\n+          output: null,\n+        },\n+      },\n+      {\n+        id: 'n_ctx',\n+        type: 'context-converter',\n+        position: { x: 420, y: 80 },\n+        data: {\n+          title: 'Context',\n+          status: 'idle',\n+          error: null,\n+          locked: false,\n+          muted: false,\n+          fullFile: true,\n+          output: null,\n+        },\n+      },\n+      {\n+        id: 'n_llm',\n+        type: 'llm',\n+        position: { x: 800, y: 80 },\n+        data: {\n+          title: 'LLM',\n+          status: 'idle',\n+          error: null,\n+          locked: false,\n+          muted: false,\n+          model: 'x-ai/grok-4.1-fast',\n+          systemPrompt:\n+            'You are a senior software engineer. Given code context, propose a concrete implementation plan and the key files to edit.',\n+          query: 'Propose a plan to improve this authentication design.',\n+          output: null,\n+        },\n+      },\n+    ],\n+    edges: [\n+      { id: 'e_search_ctx', source: 'n_search', target: 'n_ctx' },\n+      { id: 'e_ctx_llm', source: 'n_ctx', target: 'n_llm' },\n+    ],\n+    viewport: { x: 0, y: 0, zoom: 1 },\n+  }\n+}\n+\n+export function defaultAppData(): AppData {\n+  const now = nowIso()\n+  return {\n+    version: 1,\n+    activeTabId: 'tab_1',\n+    tabs: [\n+      {\n+        id: 'tab_1',\n+        name: 'Canvas 1',\n+        createdAt: now,\n+        canvas: defaultCanvas(),\n+      },\n+    ],\n+    apiSettings: defaultAPISettings(),\n+    ui: { language: 'en' },\n+  }\n+}"
      },
      {
        "sha": "aa15fb0dd8a45c74293ffcf8ec5eae574b747279",
        "filename": "server/openRouter.ts",
        "status": "modified",
        "additions": 11,
        "deletions": 4,
        "changes": 15,
        "blob_url": "https://github.com/shuxueshuxue/SpexFlow/blob/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/server%2FopenRouter.ts",
        "raw_url": "https://github.com/shuxueshuxue/SpexFlow/raw/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/server%2FopenRouter.ts",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/contents/server%2FopenRouter.ts?ref=73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
        "patch": "@@ -2,7 +2,15 @@ import { readFile } from 'node:fs/promises'\n import path from 'node:path'\n import { getLLMProviderByModel } from './appData.js'\n \n-const OPENROUTER_ENDPOINT = 'https://openrouter.ai/api/v1/chat/completions'\n+const OPENROUTER_BASE_ENDPOINT = 'https://openrouter.ai/api/v1'\n+\n+function isOpenRouterEndpoint(endpoint: string) {\n+  try {\n+    return new URL(endpoint).hostname === 'openrouter.ai'\n+  } catch {\n+    return false\n+  }\n+}\n \n async function readKeyFromDotfile() {\n   const keyPath = path.join(process.cwd(), '.llmkey')\n@@ -30,7 +38,7 @@ export async function runOpenRouterChat(args: {\n     modelId = args.model\n   } else {\n     // Fall back to OpenRouter with .llmkey file\n-    endpoint = OPENROUTER_ENDPOINT\n+    endpoint = OPENROUTER_BASE_ENDPOINT\n     apiKey = await readKeyFromDotfile()\n     modelId = args.model\n   }\n@@ -46,7 +54,7 @@ export async function runOpenRouterChat(args: {\n   }\n \n   // Add OpenRouter-specific headers only for OpenRouter\n-  if (endpoint === OPENROUTER_ENDPOINT) {\n+  if (isOpenRouterEndpoint(endpoint)) {\n     headers['HTTP-Referer'] = 'http://localhost:5173'\n     headers['X-Title'] = 'SpecFlow'\n   }\n@@ -74,4 +82,3 @@ export async function runOpenRouterChat(args: {\n   }\n   return content\n }\n-"
      },
      {
        "sha": "03da18f7e48632418a11e70482605d038939f4e1",
        "filename": "src/App.css",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/shuxueshuxue/SpexFlow/blob/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/src%2FApp.css",
        "raw_url": "https://github.com/shuxueshuxue/SpexFlow/raw/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/src%2FApp.css",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/contents/src%2FApp.css?ref=73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
        "patch": "@@ -7,6 +7,16 @@\n     'Segoe UI', Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';\n }\n \n+.sfLoading {\n+  width: 100vw;\n+  height: 100vh;\n+  display: flex;\n+  align-items: center;\n+  justify-content: center;\n+  padding: 24px;\n+  font-size: 12px;\n+}\n+\n /* ===== Modern Tab Bar ===== */\n .sfTabs {\n   height: 48px;"
      },
      {
        "sha": "1deec6d146d1fcfa13a3628fdbd2287533a6c6f9",
        "filename": "src/specflow/SpecFlowApp.tsx",
        "status": "modified",
        "additions": 34,
        "deletions": 8,
        "changes": 42,
        "blob_url": "https://github.com/shuxueshuxue/SpexFlow/blob/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/src%2Fspecflow%2FSpecFlowApp.tsx",
        "raw_url": "https://github.com/shuxueshuxue/SpexFlow/raw/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/src%2Fspecflow%2FSpecFlowApp.tsx",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/contents/src%2Fspecflow%2FSpecFlowApp.tsx?ref=73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
        "patch": "@@ -4,7 +4,8 @@ import '@xyflow/react/dist/style.css'\n \n import { useAppData, useNodeRunner, useChainRunner, useClipboard, useHotkeys } from './hooks'\n import { NodeSidebar, ToolbarButton, MultiSelectInfo, APISettingsModal, SettingsIcon } from './components'\n-import type { APISettings, Viewport } from './types'\n+import type { APISettings, AppData, Viewport } from './types'\n+import type { Dispatch, RefObject, SetStateAction } from 'react'\n import {\n   HandIcon,\n   SelectIcon,\n@@ -29,10 +30,24 @@ import {\n } from './nodes'\n \n export function SpecFlowApp() {\n+  const app = useAppData()\n+  if (app.isLoading) return <div className=\"sfLoading\">Loading...</div>\n+  if (app.loadError || !app.appData || !app.activeTab) {\n+    const msg = app.loadError ?? 'Invalid app data'\n+    return (\n+      <div className=\"sfLoading\">\n+        <div className=\"sfError\">Failed to load: {msg}</div>\n+      </div>\n+    )\n+  }\n+\n+  return <SpecFlowAppLoaded {...app} appData={app.appData} activeTab={app.activeTab} />\n+}\n+\n+function SpecFlowAppLoaded(props: ReturnType<typeof useAppData> & { appData: AppData; activeTab: NonNullable<ReturnType<typeof useAppData>['activeTab']> }) {\n   const {\n     appData,\n     setAppData,\n-    appDataRef,\n     activeTab,\n     rfNodes,\n     selected,\n@@ -52,7 +67,18 @@ export function SpecFlowApp() {\n     addNode,\n     patchSelectedNode,\n     patchNodeById,\n-  } = useAppData()\n+  } = props\n+\n+  const appDataRef = props.appDataRef as RefObject<AppData>\n+  const setAppDataStrict: Dispatch<SetStateAction<AppData>> = useCallback(\n+    (next) => {\n+      setAppData((prev) => {\n+        if (!prev) throw new Error('App data not loaded')\n+        return typeof next === 'function' ? (next as (p: AppData) => AppData)(prev) : next\n+      })\n+    },\n+    [setAppData],\n+  )\n \n   const { inFlightRuns, runNode, nodeToLocalOutput } = useNodeRunner(appDataRef, patchNodeById)\n \n@@ -67,7 +93,7 @@ export function SpecFlowApp() {\n   const { copySelectedNodes, pasteClipboard } = useClipboard(\n     appDataRef,\n     selectedRef,\n-    setAppData,\n+    setAppDataStrict,\n     setSelected,\n   )\n \n@@ -129,21 +155,21 @@ export function SpecFlowApp() {\n   }, [])\n \n   const updateAPISettings = useCallback((newSettings: APISettings) => {\n-    setAppData(prev => ({\n+    setAppDataStrict(prev => ({\n       ...prev,\n       apiSettings: newSettings\n     }))\n-  }, [setAppData])\n+  }, [setAppDataStrict])\n \n   const updateLanguage = useCallback((next: typeof language) => {\n-    setAppData((prev) => ({\n+    setAppDataStrict((prev) => ({\n       ...prev,\n       ui: {\n         ...prev.ui,\n         language: next,\n       },\n     }))\n-  }, [setAppData])\n+  }, [setAppDataStrict])\n \n   const nodeTypes = useMemo(\n     () => ({"
      },
      {
        "sha": "c5dc8c2aa9e64a288055e5c917bbca6c25a178e1",
        "filename": "src/specflow/defaultData.ts",
        "status": "removed",
        "additions": 0,
        "deletions": 122,
        "changes": 122,
        "blob_url": "https://github.com/shuxueshuxue/SpexFlow/blob/0d665fb171cdf0c6e701f553b057a0b686bc3bf7/src%2Fspecflow%2FdefaultData.ts",
        "raw_url": "https://github.com/shuxueshuxue/SpexFlow/raw/0d665fb171cdf0c6e701f553b057a0b686bc3bf7/src%2Fspecflow%2FdefaultData.ts",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/contents/src%2Fspecflow%2FdefaultData.ts?ref=0d665fb171cdf0c6e701f553b057a0b686bc3bf7",
        "patch": "@@ -1,122 +0,0 @@\n-import type { APISettings, AppData, AppNode, Canvas } from './types'\n-\n-function nowIso() {\n-  return new Date().toISOString()\n-}\n-\n-export function defaultAPISettings(): APISettings {\n-  return {\n-    codeSearch: {\n-      activeProvider: 'relace',\n-      providers: [\n-        { id: 'relace', name: 'Relace', apiKey: '' }\n-      ]\n-    },\n-    llm: {\n-      providers: [\n-        {\n-          id: 'openai',\n-          name: 'OpenAI',\n-          endpoint: 'https://api.openai.com/v1',\n-          apiKey: '',\n-          models: [\n-            { id: 'openai-gpt-4', name: 'GPT-4' },\n-            { id: 'openai-gpt-4-turbo', name: 'GPT-4 Turbo' },\n-            { id: 'openai-gpt-3.5-turbo', name: 'GPT-3.5 Turbo' },\n-          ]\n-        },\n-        {\n-          id: 'anthropic',\n-          name: 'Anthropic',\n-          endpoint: 'https://api.anthropic.com/v1',\n-          apiKey: '',\n-          models: [\n-            { id: 'anthropic-claude-3-opus', name: 'Claude 3 Opus' },\n-            { id: 'anthropic-claude-3-sonnet', name: 'Claude 3 Sonnet' },\n-            { id: 'anthropic-claude-3-haiku', name: 'Claude 3 Haiku' },\n-          ]\n-        }\n-      ]\n-    }\n-  }\n-}\n-\n-export function defaultAppData(): AppData {\n-  const canvas = defaultCanvas()\n-\n-  return {\n-    version: 1,\n-    activeTabId: 'tab_1',\n-    tabs: [\n-      {\n-        id: 'tab_1',\n-        name: 'Canvas 1',\n-        createdAt: nowIso(),\n-        canvas,\n-      },\n-    ],\n-    apiSettings: defaultAPISettings(),\n-    ui: { language: 'en' },\n-  }\n-}\n-\n-export function defaultCanvas(): Canvas {\n-  const nodes: AppNode[] = [\n-    {\n-      id: 'n_search',\n-      type: 'code-search',\n-      position: { x: 60, y: 80 },\n-      data: {\n-        title: 'Code Search',\n-        status: 'idle',\n-        error: null,\n-        locked: false,\n-        muted: false,\n-        repoPath: 'examples/example-repo',\n-        query: 'How is user authentication handled in this codebase?',\n-        debugMessages: false,\n-        output: null,\n-      },\n-    },\n-    {\n-      id: 'n_ctx',\n-      type: 'context-converter',\n-      position: { x: 420, y: 80 },\n-      data: {\n-        title: 'Context',\n-        status: 'idle',\n-        error: null,\n-        locked: false,\n-        muted: false,\n-        fullFile: false,\n-        output: null,\n-      },\n-    },\n-    {\n-      id: 'n_llm',\n-      type: 'llm',\n-      position: { x: 800, y: 80 },\n-      data: {\n-        title: 'LLM',\n-        status: 'idle',\n-        error: null,\n-        locked: false,\n-        muted: false,\n-        model: 'x-ai/grok-4.1-fast',\n-        systemPrompt:\n-          'You are a senior software engineer. Given code context, propose a concrete implementation plan and the key files to edit.',\n-        query: 'Propose a plan to improve this authentication design.',\n-        output: null,\n-      },\n-    },\n-  ]\n-\n-  return {\n-    nodes,\n-    edges: [\n-      { id: 'e_search_ctx', source: 'n_search', target: 'n_ctx' },\n-      { id: 'e_ctx_llm', source: 'n_ctx', target: 'n_llm' },\n-    ],\n-    viewport: { x: 0, y: 0, zoom: 1 },\n-  }\n-}"
      },
      {
        "sha": "cde12dd23db426570aff61b904aa741d930a5356",
        "filename": "src/specflow/hooks/useAppData.ts",
        "status": "modified",
        "additions": 63,
        "deletions": 41,
        "changes": 104,
        "blob_url": "https://github.com/shuxueshuxue/SpexFlow/blob/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/src%2Fspecflow%2Fhooks%2FuseAppData.ts",
        "raw_url": "https://github.com/shuxueshuxue/SpexFlow/raw/73bc0f527e4e95a337fe1cd17636c1bc7f81d30e/src%2Fspecflow%2Fhooks%2FuseAppData.ts",
        "contents_url": "https://api.github.com/repos/shuxueshuxue/SpexFlow/contents/src%2Fspecflow%2Fhooks%2FuseAppData.ts?ref=73bc0f527e4e95a337fe1cd17636c1bc7f81d30e",
        "patch": "@@ -2,29 +2,33 @@ import { useCallback, useEffect, useMemo, useRef, useState } from 'react'\n import type { Edge } from '@xyflow/react'\n import { addEdge, applyEdgeChanges, applyNodeChanges } from '@xyflow/react'\n import type { Connection, EdgeChange, NodeChange } from '@xyflow/react'\n-import { defaultAppData, defaultCanvas, defaultAPISettings } from '../defaultData'\n-import type { AppData, AppNode, Tab, Viewport } from '../types'\n+import type { AppData, AppNode, Canvas, Tab, Viewport } from '../types'\n import { fetchAppData, saveAppData } from '../api'\n-import { getActiveTab, isValidConnection, migrateNodeData, uid, updateNode } from '../utils'\n+import { getActiveTab, isValidConnection, uid, updateNode } from '../utils'\n \n export type Selected = { nodeIds: string[]; primaryId: string } | null\n \n+function emptyCanvas(): Canvas {\n+  return { nodes: [], edges: [], viewport: { x: 0, y: 0, zoom: 1 } }\n+}\n+\n export function useAppData() {\n-  const [appData, setAppData] = useState<AppData>(() => defaultAppData())\n-  const appDataRef = useRef(appData)\n+  const [appData, setAppData] = useState<AppData | null>(null)\n+  const appDataRef = useRef<AppData | null>(appData)\n   const [selected, setSelected] = useState<Selected>(null)\n   const selectedRef = useRef<Selected>(selected)\n   const [loadError, setLoadError] = useState<string | null>(null)\n+  const [isLoading, setIsLoading] = useState(true)\n   const saveTimer = useRef<number | null>(null)\n \n-  const activeTab = useMemo(() => getActiveTab(appData), [appData])\n+  const activeTab = useMemo(() => (appData ? getActiveTab(appData) : null), [appData])\n   const rfNodes = useMemo(\n     () =>\n-      activeTab.canvas.nodes.map((n) => ({\n+      (activeTab?.canvas.nodes ?? []).map((n) => ({\n         ...n,\n         draggable: !n.data.locked,\n       })),\n-    [activeTab.canvas.nodes],\n+    [activeTab?.canvas.nodes],\n   )\n \n   useEffect(() => {\n@@ -38,30 +42,27 @@ export function useAppData() {\n   // Load data on mount\n   useEffect(() => {\n     let alive = true\n+    setIsLoading(true)\n+    setLoadError(null)\n     fetchAppData()\n       .then((data) => {\n         if (!alive) return\n-        // Ensure apiSettings exists (migration for old data)\n-        if (!data.apiSettings) {\n-          data.apiSettings = defaultAPISettings()\n-        }\n-        // Ensure ui exists (migration for old data)\n-        if (!data.ui || typeof data.ui.language !== 'string') {\n-          data.ui = { language: 'en' }\n-        }\n-        // Migrate node data to ensure all properties exist (locked, muted, etc.)\n-        for (const tab of data.tabs) {\n-          tab.canvas.nodes = tab.canvas.nodes.map(migrateNodeData)\n-          // Ensure viewport exists (migration for old data)\n-          if (!tab.canvas.viewport) {\n-            tab.canvas.viewport = { x: 0, y: 0, zoom: 1 }\n-          }\n+        if (!data || !Array.isArray(data.tabs) || data.tabs.length === 0) {\n+          throw new Error('Invalid app data: missing tabs')\n         }\n+        getActiveTab(data)\n+        appDataRef.current = data\n         setAppData(data)\n       })\n       .catch((e) => {\n         if (!alive) return\n         setLoadError(String(e?.message ?? e))\n+        appDataRef.current = null\n+        setAppData(null)\n+      })\n+      .finally(() => {\n+        if (!alive) return\n+        setIsLoading(false)\n       })\n     return () => {\n       alive = false\n@@ -70,6 +71,7 @@ export function useAppData() {\n \n   // Auto-save\n   useEffect(() => {\n+    if (!appData) return\n     if (saveTimer.current) window.clearTimeout(saveTimer.current)\n     saveTimer.current = window.setTimeout(() => {\n       saveAppData(appData).catch((e) => {\n@@ -83,13 +85,15 @@ export function useAppData() {\n \n   const updateActiveCanvas = useCallback((patch: (tab: Tab) => Tab) => {\n     setAppData((d) => {\n+      if (!d) throw new Error('App data not loaded')\n       const nextTabs = d.tabs.map((t) => (t.id === d.activeTabId ? patch(t) : t))\n       return { ...d, tabs: nextTabs }\n     })\n   }, [])\n \n   const updateActiveViewport = useCallback((viewport: Viewport) => {\n     setAppData((d) => {\n+      if (!d) throw new Error('App data not loaded')\n       const nextTabs = d.tabs.map((t) => {\n         if (t.id !== d.activeTabId) return t\n         return {\n@@ -106,33 +110,45 @@ export function useAppData() {\n \n   const setActiveTabId = useCallback((tabId: string) => {\n     setSelected(null)\n-    setAppData((d) => ({ ...d, activeTabId: tabId }))\n+    setAppData((d) => {\n+      if (!d) throw new Error('App data not loaded')\n+      return { ...d, activeTabId: tabId }\n+    })\n   }, [])\n \n   const addTab = useCallback(() => {\n     const id = uid('tab')\n-    const tab: Tab = {\n-      id,\n-      name: `Canvas ${appData.tabs.length + 1}`,\n-      createdAt: new Date().toISOString(),\n-      canvas: defaultCanvas(),\n-    }\n-    setAppData((d) => ({ ...d, tabs: [...d.tabs, tab], activeTabId: id }))\n-  }, [appData.tabs.length])\n+    setAppData((d) => {\n+      if (!d) throw new Error('App data not loaded')\n+      const tab: Tab = {\n+        id,\n+        name: `Canvas ${d.tabs.length + 1}`,\n+        createdAt: new Date().toISOString(),\n+        canvas: emptyCanvas(),\n+      }\n+      return { ...d, tabs: [...d.tabs, tab], activeTabId: id }\n+    })\n+  }, [])\n \n   const renameTab = useCallback((tabId: string) => {\n-    const tab = appDataRef.current.tabs.find((t) => t.id === tabId)\n+    const snap = appDataRef.current\n+    if (!snap) throw new Error('App data not loaded')\n+    const tab = snap.tabs.find((t) => t.id === tabId)\n     if (!tab) return\n     const nextName = window.prompt('Canvas name?', tab.name) ?? ''\n     if (!nextName.trim()) return\n-    setAppData((d) => ({\n-      ...d,\n-      tabs: d.tabs.map((t) => (t.id === tabId ? { ...t, name: nextName.trim() } : t)),\n-    }))\n+    setAppData((d) => {\n+      if (!d) throw new Error('App data not loaded')\n+      return {\n+        ...d,\n+        tabs: d.tabs.map((t) => (t.id === tabId ? { ...t, name: nextName.trim() } : t)),\n+      }\n+    })\n   }, [])\n \n   const closeTab = useCallback((tabId: string) => {\n     setAppData((d) => {\n+      if (!d) throw new Error('App data not loaded')\n       const nextTabs = d.tabs.filter((t) => t.id !== tabId)\n       const nextActive = d.activeTabId === tabId ? (nextTabs[0]?.id ?? null) : d.activeTabId\n       return { ...d, tabs: nextTabs, activeTabId: nextActive }\n@@ -178,7 +194,9 @@ export function useAppData() {\n \n   const onConnect = useCallback(\n     (params: Connection) => {\n-      const tab = getActiveTab(appDataRef.current)\n+      const snap = appDataRef.current\n+      if (!snap) throw new Error('App data not loaded')\n+      const tab = getActiveTab(snap)\n       const sourceNode = tab.canvas.nodes.find((n) => n.id === params.source)\n       const targetNode = tab.canvas.nodes.find((n) => n.id === params.target)\n       if (!sourceNode || !targetNode) return\n@@ -199,13 +217,16 @@ export function useAppData() {\n \n   const addNode = useCallback(\n     (type: AppNode['type'], liveViewport?: Viewport) => {\n+      const snap = appDataRef.current\n+      if (!snap) throw new Error('App data not loaded')\n+      const tabSnap = getActiveTab(snap)\n       const id = uid('n')\n       // Place new node at viewport center (use live viewport if provided, else fall back to saved)\n-      const viewport = liveViewport ?? activeTab.canvas.viewport ?? { x: 0, y: 0, zoom: 1 }\n+      const viewport = liveViewport ?? tabSnap.canvas.viewport ?? { x: 0, y: 0, zoom: 1 }\n       const centerX = (-viewport.x + 400) / viewport.zoom\n       const centerY = (-viewport.y + 300) / viewport.zoom\n       // Add small offset based on existing node count to avoid stacking\n-      const offset = (activeTab.canvas.nodes.length % 5) * 30\n+      const offset = (tabSnap.canvas.nodes.length % 5) * 30\n       const base = {\n         id,\n         type,\n@@ -311,7 +332,7 @@ export function useAppData() {\n       }))\n       setSelected({ nodeIds: [id], primaryId: id })\n     },\n-    [activeTab.canvas.nodes.length, updateActiveCanvas],\n+    [updateActiveCanvas],\n   )\n \n   const patchSelectedNode = useCallback(\n@@ -346,6 +367,7 @@ export function useAppData() {\n     appData,\n     setAppData,\n     appDataRef,\n+    isLoading,\n     activeTab,\n     rfNodes,\n     selected,"
      }
    ]
  }
}