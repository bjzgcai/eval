{
  "sha": "f76dac9f96494069d1c0fec2a8faf0db7e8624aa",
  "node_id": "C_kwDOP2Zrm9oAKGY3NmRhYzlmOTY0OTQwNjlkMWMwZmVjMmE4ZmFmMGRiN2U4NjI0YWE",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-02T05:56:07Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-02T05:56:07Z"
    },
    "message": "Fix critical auth bugs: data loading and user profile\n\nFixes two critical issues after migration:\n\n1. **Data not loading after migration**:\n   - App now loads from database when authenticated\n   - Loads current/most recent session on mount\n   - Loads pictures from database (not localStorage)\n   - Loads user preferences (voice configs, selected state)\n   - Auto-saves to database every 3 seconds (authenticated users)\n   - Guest mode still uses localStorage\n\n2. **User profile button not working**:\n   - Added onClick handler to profile button\n   - Shows dropdown menu with user info and logout\n   - Displays first letter of name/email as avatar\n   - Clean dropdown UI with backdrop\n\nTechnical changes:\n- App.tsx: Load data from database on mount if authenticated\n- App.tsx: Auto-save to database with 3s debounce\n- App.tsx: Only save to localStorage in guest mode\n- CollectionsView.tsx: Load pictures from database\n- LeftSidebar.tsx: Add user menu dropdown with logout\n\nDatabase is now the source of truth for authenticated users!\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>",
    "tree": {
      "sha": "40c4cc608be7883c3edae6fa9244a3151a5482bd",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/40c4cc608be7883c3edae6fa9244a3151a5482bd"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/f76dac9f96494069d1c0fec2a8faf0db7e8624aa",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/f76dac9f96494069d1c0fec2a8faf0db7e8624aa",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/f76dac9f96494069d1c0fec2a8faf0db7e8624aa",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/f76dac9f96494069d1c0fec2a8faf0db7e8624aa/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef"
    }
  ],
  "stats": {
    "total": 330,
    "additions": 260,
    "deletions": 70
  },
  "files": [
    {
      "sha": "e92db19b2c9e4c7c5d3f5217d9c8f0e85bdd3019",
      "filename": "frontend/src/App.tsx",
      "status": "modified",
      "additions": 104,
      "deletions": 20,
      "changes": 124,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/f76dac9f96494069d1c0fec2a8faf0db7e8624aa/frontend%2Fsrc%2FApp.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/f76dac9f96494069d1c0fec2a8faf0db7e8624aa/frontend%2Fsrc%2FApp.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=f76dac9f96494069d1c0fec2a8faf0db7e8624aa",
      "patch": "@@ -388,29 +388,96 @@ export default function App() {\n \n     engine.subscribe((newState) => {\n       setState({ ...newState });\n-      localStorage.setItem('ink_memory_state', JSON.stringify(newState));\n+      // Only save to localStorage if not authenticated (guest mode)\n+      if (!isAuthenticated) {\n+        localStorage.setItem('ink_memory_state', JSON.stringify(newState));\n+      }\n     });\n \n-    const saved = localStorage.getItem('ink_memory_state');\n-    if (saved) {\n-      try {\n-        const parsed = JSON.parse(saved);\n-        engine.loadState(parsed);\n-        setState(engine.getState());\n-\n-        // Initialize localTexts from loaded state\n-        const texts = new Map<string, string>();\n-        parsed.cells?.filter((c: any) => c.type === 'text').forEach((c: any) => {\n-          texts.set(c.id, c.content || '');\n-        });\n-        setLocalTexts(texts);\n-      } catch (e) {\n-        console.error('Failed to load saved state:', e);\n+    // Load initial state\n+    const loadInitialState = async () => {\n+      if (isAuthenticated) {\n+        // @@@ Load from database if authenticated\n+        try {\n+          const { listSessions, getSession, getPreferences } = await import('./api/voiceApi');\n+\n+          // Get list of sessions\n+          const sessions = await listSessions();\n+\n+          // Load the most recent session or current session\n+          let sessionToLoad = null;\n+          const currentSessionId = 'current-session';\n+          const currentSession = sessions.find(s => s.id === currentSessionId);\n+\n+          if (currentSession) {\n+            // Load current session\n+            const fullSession = await getSession(currentSessionId);\n+            sessionToLoad = fullSession.editor_state;\n+          } else if (sessions.length > 0) {\n+            // Load most recent session\n+            const mostRecent = sessions.sort((a, b) =>\n+              new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime()\n+            )[0];\n+            const fullSession = await getSession(mostRecent.id);\n+            sessionToLoad = fullSession.editor_state;\n+          }\n+\n+          if (sessionToLoad) {\n+            engine.loadState(sessionToLoad);\n+            setState(engine.getState());\n+\n+            // Initialize localTexts from loaded state\n+            const texts = new Map<string, string>();\n+            sessionToLoad.cells?.filter((c: any) => c.type === 'text').forEach((c: any) => {\n+              texts.set(c.id, c.content || '');\n+            });\n+            setLocalTexts(texts);\n+          } else {\n+            setState(engine.getState());\n+          }\n+\n+          // Load preferences\n+          try {\n+            const prefs = await getPreferences();\n+            if (prefs.voice_configs) {\n+              setVoiceConfigs(prefs.voice_configs);\n+            }\n+            if (prefs.selected_state) {\n+              setSelectedState(prefs.selected_state);\n+            }\n+          } catch (err) {\n+            console.log('No preferences found, using defaults');\n+          }\n+        } catch (error) {\n+          console.error('Failed to load from database:', error);\n+          setState(engine.getState());\n+        }\n+      } else {\n+        // Load from localStorage for guest mode\n+        const saved = localStorage.getItem('ink_memory_state');\n+        if (saved) {\n+          try {\n+            const parsed = JSON.parse(saved);\n+            engine.loadState(parsed);\n+            setState(engine.getState());\n+\n+            // Initialize localTexts from loaded state\n+            const texts = new Map<string, string>();\n+            parsed.cells?.filter((c: any) => c.type === 'text').forEach((c: any) => {\n+              texts.set(c.id, c.content || '');\n+            });\n+            setLocalTexts(texts);\n+          } catch (e) {\n+            console.error('Failed to load saved state:', e);\n+          }\n+        } else {\n+          setState(engine.getState());\n+        }\n       }\n-    } else {\n-      setState(engine.getState());\n-    }\n-  }, []);\n+    };\n+\n+    loadInitialState();\n+  }, [isAuthenticated]);\n \n   // @@@ Sync localTexts from state when not composing\n   useEffect(() => {\n@@ -429,6 +496,23 @@ export default function App() {\n     }\n   }, [state, composingCells]);\n \n+  // @@@ Auto-save to database for authenticated users\n+  useEffect(() => {\n+    if (!isAuthenticated || !state) return;\n+\n+    const autoSaveTimer = setTimeout(async () => {\n+      try {\n+        const { saveSession } = await import('./api/voiceApi');\n+        await saveSession('current-session', state, 'Current Session');\n+        console.log('Auto-saved to database');\n+      } catch (error) {\n+        console.error('Auto-save failed:', error);\n+      }\n+    }, 3000); // Save 3 seconds after last change\n+\n+    return () => clearTimeout(autoSaveTimer);\n+  }, [state, isAuthenticated]);\n+\n   // @@@ Group comments by 2-row blocks, accounting for widgets between cells\n   const commentGroups = useMemo(() => {\n     const groups = new Map<string, {"
    },
    {
      "sha": "3bfb80a2bd70056e7ecb4fa20e80967e3abf6d90",
      "filename": "frontend/src/components/CollectionsView.tsx",
      "status": "modified",
      "additions": 54,
      "deletions": 23,
      "changes": 77,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/f76dac9f96494069d1c0fec2a8faf0db7e8624aa/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/f76dac9f96494069d1c0fec2a8faf0db7e8624aa/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx?ref=f76dac9f96494069d1c0fec2a8faf0db7e8624aa",
      "patch": "@@ -194,30 +194,60 @@ function TimelinePage() {\n   const scrollContainerRef = useRef<HTMLDivElement | null>(null);\n \n   useEffect(() => {\n-    // Load starred comments\n-    const savedState = localStorage.getItem('ink_memory_state');\n-    if (savedState) {\n-      try {\n-        const state = JSON.parse(savedState);\n-        const starred = state.commentors?.filter((c: Commentor) => c.feedback === 'star') || [];\n-        setStarredComments(starred);\n-      } catch (e) {\n-        console.error('Failed to load starred comments:', e);\n+    const loadData = async () => {\n+      // Load starred comments from localStorage (not migrated yet)\n+      const savedState = localStorage.getItem('ink_memory_state');\n+      if (savedState) {\n+        try {\n+          const state = JSON.parse(savedState);\n+          const starred = state.commentors?.filter((c: Commentor) => c.feedback === 'star') || [];\n+          setStarredComments(starred);\n+        } catch (e) {\n+          console.error('Failed to load starred comments:', e);\n+        }\n       }\n-    }\n \n-    // Load pictures\n-    const savedPictures = localStorage.getItem('daily-pictures');\n-    if (savedPictures) {\n-      try {\n-        setPictures(JSON.parse(savedPictures));\n-      } catch (e) {\n-        console.error('Failed to load pictures:', e);\n+      // @@@ Load pictures from database if authenticated\n+      if (isAuthenticated) {\n+        try {\n+          const { getDailyPictures } = await import('../api/voiceApi');\n+          const dbPictures = await getDailyPictures(30);\n+          // Convert database format to app format\n+          const formattedPictures = dbPictures.map(p => ({\n+            date: p.date,\n+            base64: p.image_base64,\n+            prompt: p.prompt || ''\n+          }));\n+          setPictures(formattedPictures);\n+        } catch (error) {\n+          console.error('Failed to load pictures from database:', error);\n+          // Fallback to localStorage\n+          const savedPictures = localStorage.getItem('daily-pictures');\n+          if (savedPictures) {\n+            try {\n+              setPictures(JSON.parse(savedPictures));\n+            } catch (e) {\n+              console.error('Failed to load pictures:', e);\n+            }\n+          }\n+        }\n+      } else {\n+        // Guest mode: load from localStorage\n+        const savedPictures = localStorage.getItem('daily-pictures');\n+        if (savedPictures) {\n+          try {\n+            setPictures(JSON.parse(savedPictures));\n+          } catch (e) {\n+            console.error('Failed to load pictures:', e);\n+          }\n+        }\n       }\n-    }\n \n-    setInitialLoading(false);\n-  }, []);\n+      setInitialLoading(false);\n+    };\n+\n+    loadData();\n+  }, [isAuthenticated]);\n \n   // @@@ Group items by date\n   const timelineByDate = new Map<string, { picture?: any; comments: Commentor[] }>();\n@@ -289,14 +319,15 @@ function TimelinePage() {\n       const pictureDate = new Date(newPicture.date).toISOString().split('T')[0]; // YYYY-MM-DD format\n       await saveDailyPicture(pictureDate, image_base64, prompt);\n \n-      // @@@ Overwrite existing picture for this date instead of adding new\n+      // @@@ Update local state\n       const normalizedNewDate = formatDate(newPicture.date);\n-\n       const updated = pictures.filter(p => formatDate(p.date) !== normalizedNewDate);\n \n       updated.unshift(newPicture);\n       setPictures(updated);\n-      localStorage.setItem('daily-pictures', JSON.stringify(updated));\n+\n+      // Don't save to localStorage for authenticated users (database is source of truth)\n+      // localStorage.setItem('daily-pictures', JSON.stringify(updated));\n     } catch (error) {\n       console.error('Image generation failed:', error);\n       alert('Failed to generate image. Please try again.');"
    },
    {
      "sha": "8a37ecba1252d29e8f46476183348e595ec5d5f9",
      "filename": "frontend/src/components/LeftSidebar.tsx",
      "status": "modified",
      "additions": 102,
      "deletions": 27,
      "changes": 129,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/f76dac9f96494069d1c0fec2a8faf0db7e8624aa/frontend%2Fsrc%2Fcomponents%2FLeftSidebar.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/f76dac9f96494069d1c0fec2a8faf0db7e8624aa/frontend%2Fsrc%2Fcomponents%2FLeftSidebar.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FLeftSidebar.tsx?ref=f76dac9f96494069d1c0fec2a8faf0db7e8624aa",
      "patch": "@@ -1,9 +1,14 @@\n+import { useState } from 'react';\n+import { useAuth } from '../contexts/AuthContext';\n+\n interface Props {\n   currentView: 'writing' | 'settings' | 'timeline' | 'analysis' | 'about';\n   onViewChange: (view: 'writing' | 'settings' | 'timeline' | 'analysis' | 'about') => void;\n }\n \n export default function LeftSidebar({ currentView, onViewChange }: Props) {\n+  const { user, logout } = useAuth();\n+  const [showUserMenu, setShowUserMenu] = useState(false);\n   const buttonStyle = (isActive: boolean) => ({\n     height: '100%',\n     padding: '0 20px',\n@@ -182,33 +187,103 @@ export default function LeftSidebar({ currentView, onViewChange }: Props) {\n         </svg>\n       </button>\n \n-      <button\n-        style={{\n-          width: 28,\n-          height: 28,\n-          borderRadius: 14,\n-          display: 'flex',\n-          alignItems: 'center',\n-          justifyContent: 'center',\n-          background: '#4CAF50',\n-          border: 'none',\n-          cursor: 'pointer',\n-          transition: 'all 0.2s',\n-          color: '#fff',\n-          fontSize: 12,\n-          fontWeight: 600,\n-          fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif'\n-        }}\n-        onMouseEnter={e => {\n-          e.currentTarget.style.background = '#45a049';\n-        }}\n-        onMouseLeave={e => {\n-          e.currentTarget.style.background = '#4CAF50';\n-        }}\n-        title=\"User Profile\"\n-      >\n-        U\n-      </button>\n+      <div style={{ position: 'relative' }}>\n+        <button\n+          onClick={() => setShowUserMenu(!showUserMenu)}\n+          style={{\n+            width: 28,\n+            height: 28,\n+            borderRadius: 14,\n+            display: 'flex',\n+            alignItems: 'center',\n+            justifyContent: 'center',\n+            background: '#4CAF50',\n+            border: 'none',\n+            cursor: 'pointer',\n+            transition: 'all 0.2s',\n+            color: '#fff',\n+            fontSize: 12,\n+            fontWeight: 600,\n+            fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif'\n+          }}\n+          onMouseEnter={e => {\n+            e.currentTarget.style.background = '#45a049';\n+          }}\n+          onMouseLeave={e => {\n+            e.currentTarget.style.background = '#4CAF50';\n+          }}\n+          title=\"User Profile\"\n+        >\n+          {user?.display_name?.[0]?.toUpperCase() || user?.email?.[0]?.toUpperCase() || 'U'}\n+        </button>\n+\n+        {showUserMenu && (\n+          <>\n+            <div\n+              style={{\n+                position: 'fixed',\n+                top: 0,\n+                left: 0,\n+                right: 0,\n+                bottom: 0,\n+                zIndex: 998\n+              }}\n+              onClick={() => setShowUserMenu(false)}\n+            />\n+            <div style={{\n+              position: 'absolute',\n+              top: '100%',\n+              right: 0,\n+              marginTop: 8,\n+              width: 200,\n+              background: '#fff',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: 8,\n+              boxShadow: '0 4px 12px rgba(0,0,0,0.15)',\n+              zIndex: 999,\n+              overflow: 'hidden'\n+            }}>\n+              <div style={{\n+                padding: '12px 16px',\n+                borderBottom: '1px solid #e8e8e8',\n+                fontSize: 13\n+              }}>\n+                <div style={{ fontWeight: 600, marginBottom: 4 }}>\n+                  {user?.display_name || 'User'}\n+                </div>\n+                <div style={{ fontSize: 11, color: '#666' }}>\n+                  {user?.email}\n+                </div>\n+              </div>\n+              <button\n+                onClick={() => {\n+                  logout();\n+                  setShowUserMenu(false);\n+                }}\n+                style={{\n+                  width: '100%',\n+                  padding: '10px 16px',\n+                  border: 'none',\n+                  background: 'transparent',\n+                  textAlign: 'left',\n+                  fontSize: 13,\n+                  cursor: 'pointer',\n+                  transition: 'background 0.2s',\n+                  fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto'\n+                }}\n+                onMouseEnter={e => {\n+                  e.currentTarget.style.background = '#f5f5f5';\n+                }}\n+                onMouseLeave={e => {\n+                  e.currentTarget.style.background = 'transparent';\n+                }}\n+              >\n+                Logout\n+              </button>\n+            </div>\n+          </>\n+        )}\n+      </div>\n     </div>\n   );\n }"
    }
  ]
}