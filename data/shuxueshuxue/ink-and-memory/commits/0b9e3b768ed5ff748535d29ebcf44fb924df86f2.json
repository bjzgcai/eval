{
  "sha": "0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
  "node_id": "C_kwDOP2Zrm9oAKDBiOWUzYjc2OGVkNWZmNzQ4NTM1ZDI5ZWJjZjQ0ZmI5MjRkZjg2ZjI",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-10-29T16:18:43Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-10-29T16:18:43Z"
    },
    "message": "Fix timeline empty state and increase image generation timeout\n\nFrontend changes:\n- Increase API polling timeout from 30s to 2 minutes (accommodate China network latency)\n- Add generateDailyPicture API function\n- Remove timeline empty state check (always show timeline structure)\n- Rename \"Collections\" to \"Timeline\" in navigation\n- Fix TypeScript errors (date formatting, unused variables, type assertions)\n- Rename \"Analysis\" tab to \"Reflections\"\n\nBackend changes:\n- Add retry logic for image generation (3 attempts with 60s/90s/120s timeouts)\n- Total backend timeout: up to 270 seconds\n- Handles intermittent API slowness from Beijing server location\n\nRoot cause: Server in Beijing experiences 5.4x slower API responses (87s vs 16s locally)\ndue to Great Firewall latency when calling international image generation APIs.\n\nü§ñ Generated with Claude Code\n\nCo-Authored-By: Claude <noreply@anthropic.com>",
    "tree": {
      "sha": "72c4ffbf4a9fff09e51016901571a2830c755911",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/72c4ffbf4a9fff09e51016901571a2830c755911"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "2ac3fb07874d341f21c49fdb8e3cbb4158ad99ac",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/2ac3fb07874d341f21c49fdb8e3cbb4158ad99ac",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/2ac3fb07874d341f21c49fdb8e3cbb4158ad99ac"
    }
  ],
  "stats": {
    "total": 3834,
    "additions": 2856,
    "deletions": 978
  },
  "files": [
    {
      "sha": "245652438b80d3ca6afd04876e66f2b1e0e8dfac",
      "filename": "backend/proxy_config.py",
      "status": "added",
      "additions": 28,
      "deletions": 0,
      "changes": 28,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/backend%2Fproxy_config.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/backend%2Fproxy_config.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fproxy_config.py?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -0,0 +1,28 @@\n+\"\"\"Proxy configuration for API calls that need GFW bypass.\"\"\"\n+import os\n+\n+def get_image_api_proxies():\n+    \"\"\"\n+    Get proxy configuration for image generation API calls.\n+    \n+    Returns dict for requests.post(proxies=...) or None if no proxy configured.\n+    \n+    Configuration priority:\n+    1. Environment variable IMAGE_API_PROXY (e.g., \"socks5://localhost:7890\")\n+    2. Return None (no proxy)\n+    \n+    Usage in server.py:\n+        proxies = get_image_api_proxies()\n+        response = requests.post(url, proxies=proxies, ...)  # None is valid\n+    \"\"\"\n+    proxy_url = os.getenv('IMAGE_API_PROXY')\n+    \n+    if proxy_url:\n+        print(f\"[Proxy Config] Using proxy for image API: {proxy_url}\")\n+        return {\n+            'http': proxy_url,\n+            'https': proxy_url\n+        }\n+    else:\n+        print(\"[Proxy Config] No proxy configured for image API\")\n+        return None"
    },
    {
      "sha": "aae26d5d8907e7ee2ecb07cb6bbdbebb05c0e88e",
      "filename": "backend/server.py",
      "status": "modified",
      "additions": 159,
      "deletions": 0,
      "changes": 159,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/backend%2Fserver.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/backend%2Fserver.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -6,6 +6,7 @@\n from polycli import PolyAgent\n from stateless_analyzer import analyze_stateless\n import config\n+from proxy_config import get_image_api_proxies\n \n @session_def(\n     name=\"Chat with Voice\",\n@@ -307,6 +308,164 @@ def analyze_patterns(all_notes: str):\n     except:\n         return {\"patterns\": []}\n \n+@session_def(\n+    name=\"Generate Daily Picture\",\n+    description=\"Generate an artistic image based on user's daily notes\",\n+    params={\n+        \"all_notes\": {\"type\": \"str\"}\n+    },\n+    category=\"Creative\"\n+)\n+def generate_daily_picture(all_notes: str):\n+    \"\"\"Generate an image based on the essence of user's daily notes.\n+\n+    Uses a two-step process:\n+    1. LLM analyzes notes and creates artistic image description\n+    2. Image generation model creates the image\n+    \"\"\"\n+    print(f\"\\n{'='*60}\")\n+    print(f\"üé® generate_daily_picture() called\")\n+    print(f\"   Notes length: {len(all_notes)} chars\")\n+    print(f\"{'='*60}\\n\")\n+\n+    import requests\n+    import base64\n+\n+    API_KEY = \"sk-yz0JLc7sGbCHnwam70Bc9e29Dc684bAe904102C95dF32fB1\"\n+    ENDPOINT = \"https://api.dou.chat/v1\"\n+\n+    # @@@ Step 1: Convert notes to artistic image description using Claude Haiku\n+    import requests as req\n+\n+    CLAUDE_API_KEY = \"sk-yz0JLc7sGbCHnwam70Bc9e29Dc684bAe904102C95dF32fB1\"\n+    CLAUDE_ENDPOINT = \"https://api.dou.chat/v1\"\n+    CLAUDE_MODEL = \"anthropic/claude-haiku-4.5\"\n+\n+    description_prompt = f\"\"\"Read these personal notes and create a vivid, artistic image description that captures the essence, mood, and themes.\n+\n+Notes:\n+---\n+{all_notes}\n+---\n+\n+Create a detailed image description (2-3 sentences) that:\n+- Captures the emotional tone and atmosphere\n+- Uses visual metaphors for abstract concepts\n+- Specifies artistic style (e.g., watercolor, impressionist, minimalist)\n+- Describes colors, lighting, composition\n+\n+Be creative and interpretive. Focus on mood and feeling, not literal representation.\n+\n+Return ONLY the image description, no other text.\"\"\"\n+\n+    print(\"üß† Creating image description from notes with Claude Haiku...\")\n+\n+    # @@@ Use proxy for GFW bypass (if configured)\n+    proxies = get_image_api_proxies()\n+\n+    claude_response = req.post(\n+        f\"{CLAUDE_ENDPOINT}/chat/completions\",\n+        headers={\n+            \"Authorization\": f\"Bearer {CLAUDE_API_KEY}\",\n+            \"Content-Type\": \"application/json\"\n+        },\n+        json={\n+            \"model\": CLAUDE_MODEL,\n+            \"messages\": [{\"role\": \"user\", \"content\": description_prompt}],\n+            \"max_tokens\": 500\n+        },\n+        proxies=proxies,\n+        timeout=30\n+    )\n+\n+    if claude_response.status_code != 200:\n+        return {\"image_base64\": None, \"error\": \"Failed to create image description\"}\n+\n+    claude_data = claude_response.json()\n+    image_description = claude_data.get('choices', [{}])[0].get('message', {}).get('content', '').strip()\n+\n+    if not image_description:\n+        return {\"image_base64\": None, \"error\": \"Failed to create image description\"}\n+\n+    print(f\"üìù Image description: {image_description}\")\n+\n+    # @@@ Step 2: Generate image from description with retry logic\n+    MODEL = \"google/gemini-2.5-flash-image-preview\"\n+\n+    url = f\"{ENDPOINT}/chat/completions\"\n+    headers = {\n+        \"Authorization\": f\"Bearer {API_KEY}\",\n+        \"Content-Type\": \"application/json\"\n+    }\n+\n+    payload = {\n+        \"model\": MODEL,\n+        \"messages\": [\n+            {\n+                \"role\": \"user\",\n+                \"content\": image_description\n+            }\n+        ],\n+        \"max_tokens\": 1000\n+    }\n+\n+    # @@@ Retry logic: 3 attempts with increasing timeouts\n+    max_attempts = 3\n+    for attempt in range(1, max_attempts + 1):\n+        try:\n+            timeout_seconds = 60 + (attempt - 1) * 30  # 60s, 90s, 120s\n+            print(f\"üé® Generating image (attempt {attempt}/{max_attempts}, timeout={timeout_seconds}s)...\")\n+            response = requests.post(url, headers=headers, json=payload, proxies=proxies, timeout=timeout_seconds)\n+\n+            if response.status_code != 200:\n+                print(f\"‚ùå Error: {response.status_code}\")\n+                if attempt < max_attempts:\n+                    print(f\"‚è≥ Retrying in 2 seconds...\")\n+                    import time\n+                    time.sleep(2)\n+                    continue\n+                return {\"image_base64\": None, \"error\": \"Image generation failed\"}\n+\n+            data = response.json()\n+\n+            # Extract image from response\n+            if 'choices' in data and len(data['choices']) > 0:\n+                message = data['choices'][0].get('message', {})\n+                images = message.get('images', [])\n+\n+                if images:\n+                    image_data = images[0].get('image_url', {}).get('url', '')\n+\n+                    if image_data.startswith('data:image/png;base64,'):\n+                        # Extract base64 data (without the data URI prefix)\n+                        base64_data = image_data.split(',', 1)[1]\n+\n+                        print(f\"‚úÖ Image generated successfully\")\n+                        print(f\"   Size: {len(base64_data)} chars\")\n+\n+                        return {\n+                            \"image_base64\": base64_data,\n+                            \"prompt\": image_description  # Return the creative description\n+                        }\n+\n+            if attempt < max_attempts:\n+                print(f\"‚ö†Ô∏è No image in response, retrying...\")\n+                import time\n+                time.sleep(2)\n+                continue\n+            return {\"image_base64\": None, \"error\": \"No image in response\"}\n+\n+        except Exception as e:\n+            print(f\"‚ùå Exception on attempt {attempt}: {e}\")\n+            if attempt < max_attempts:\n+                print(f\"‚è≥ Retrying in 2 seconds...\")\n+                import time\n+                time.sleep(2)\n+                continue\n+            return {\"image_base64\": None, \"error\": str(e)}\n+\n+    return {\"image_base64\": None, \"error\": \"All retry attempts failed\"}\n+\n if __name__ == \"__main__\":\n     # Get the global registry\n     registry = get_registry()"
    },
    {
      "sha": "cb81104bd82bb5e4b39b043dce437b91fb580ab0",
      "filename": "backend/test_image_gen.py",
      "status": "added",
      "additions": 91,
      "deletions": 0,
      "changes": 91,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/backend%2Ftest_image_gen.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/backend%2Ftest_image_gen.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Ftest_image_gen.py?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -0,0 +1,91 @@\n+#!/usr/bin/env python3\n+\"\"\"Test Gemini image generation via dou.chat endpoint\"\"\"\n+\n+import requests\n+import json\n+import base64\n+from pathlib import Path\n+\n+API_KEY = \"sk-yz0JLc7sGbCHnwam70Bc9e29Dc684bAe904102C95dF32fB1\"\n+ENDPOINT = \"https://api.dou.chat/v1\"\n+MODEL = \"google/gemini-2.5-flash-image-preview\"\n+\n+def test_image_generation():\n+    \"\"\"Test if image generation works with the given model\"\"\"\n+\n+    print(f\"\\n{'='*60}\")\n+    print(f\"üé® Testing Image Generation\")\n+    print(f\"   Endpoint: {ENDPOINT}\")\n+    print(f\"   Model: {MODEL}\")\n+    print(f\"{'='*60}\\n\")\n+\n+    # Try a simple prompt\n+    prompt = \"A serene morning scene with a cup of coffee on a wooden table, sunlight streaming through a window, peaceful and contemplative mood\"\n+\n+    print(f\"Prompt: {prompt}\\n\")\n+\n+    # Make request\n+    url = f\"{ENDPOINT}/chat/completions\"\n+    headers = {\n+        \"Authorization\": f\"Bearer {API_KEY}\",\n+        \"Content-Type\": \"application/json\"\n+    }\n+\n+    payload = {\n+        \"model\": MODEL,\n+        \"messages\": [\n+            {\n+                \"role\": \"user\",\n+                \"content\": prompt\n+            }\n+        ],\n+        \"max_tokens\": 1000\n+    }\n+\n+    print(\"Sending request...\")\n+    try:\n+        response = requests.post(url, headers=headers, json=payload, timeout=60)\n+        print(f\"Status: {response.status_code}\")\n+\n+        if response.status_code == 200:\n+            data = response.json()\n+            print(\"\\n‚úÖ Success!\")\n+            print(json.dumps(data, indent=2))\n+\n+            # Check if there's image data\n+            if 'choices' in data and len(data['choices']) > 0:\n+                message = data['choices'][0].get('message', {})\n+                images = message.get('images', [])\n+\n+                if images:\n+                    print(f\"\\nüñºÔ∏è  Found {len(images)} image(s)!\")\n+\n+                    # Extract first image\n+                    image_data = images[0].get('image_url', {}).get('url', '')\n+\n+                    if image_data.startswith('data:image/png;base64,'):\n+                        # Extract base64 data\n+                        base64_data = image_data.split(',', 1)[1]\n+\n+                        # Decode and save\n+                        image_bytes = base64.b64decode(base64_data)\n+                        output_path = Path(\"/tmp/test_gemini_image.png\")\n+                        output_path.write_bytes(image_bytes)\n+\n+                        print(f\"‚úÖ Image saved to: {output_path}\")\n+                        print(f\"   Size: {len(image_bytes)} bytes\")\n+                        print(f\"\\nüí° Open with: open {output_path}\")\n+                    else:\n+                        print(f\"‚ö†Ô∏è  Unexpected image format: {image_data[:100]}...\")\n+                else:\n+                    print(\"\\n‚ùå No images found in response\")\n+\n+        else:\n+            print(f\"\\n‚ùå Error: {response.status_code}\")\n+            print(response.text)\n+\n+    except Exception as e:\n+        print(f\"\\n‚ùå Exception: {e}\")\n+\n+if __name__ == \"__main__\":\n+    test_image_generation()"
    },
    {
      "sha": "20ac8bea250d91a5e69001427b8d293ff9a71bc0",
      "filename": "frontend/src/App.tsx",
      "status": "modified",
      "additions": 6,
      "deletions": 4,
      "changes": 10,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2FApp.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2FApp.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -252,7 +252,7 @@ const colorMap: Record<string, { gradient: string; text: string; glow: string }>\n // @@@ Main App Component\n export default function App() {\n   const isMobile = useMobile();\n-  const [currentView, setCurrentView] = useState<'writing' | 'settings' | 'collections' | 'analysis' | 'about'>('writing');\n+  const [currentView, setCurrentView] = useState<'writing' | 'settings' | 'timeline' | 'analysis' | 'about'>('writing');\n   const [showCalendarPopup, setShowCalendarPopup] = useState(false);\n   const [voiceConfigs, setVoiceConfigs] = useState<Record<string, VoiceConfig>>({});\n   const [defaultVoiceConfigs, setDefaultVoiceConfigs] = useState<Record<string, VoiceConfig>>({});\n@@ -298,10 +298,12 @@ export default function App() {\n   const [expandedCommentId, setExpandedCommentId] = useState<string | null>(null);\n   const [commentChatProcessing, setCommentChatProcessing] = useState<Set<string>>(new Set());\n \n-  // @@@ Reset refs ready flag when returning to writing view\n+  // @@@ Trigger re-render when returning to writing view to recalculate comment positions\n   useEffect(() => {\n     if (currentView === 'writing') {\n-      refsReadyTriggered.current = false;\n+      // Force re-render to recalculate comment positions\n+      // Don't reset refsReadyTriggered - it should remain true after initial mount\n+      setRefsReady(prev => prev + 1);\n     }\n   }, [currentView]);\n \n@@ -1468,7 +1470,7 @@ export default function App() {\n           />\n         </div>\n       )}\n-      {currentView === 'collections' && (\n+      {currentView === 'timeline' && (\n         <div style={{\n           position: 'fixed',\n           top: 48,"
    },
    {
      "sha": "51d34f89ddfb2f0c3fba94458174c981777db2d0",
      "filename": "frontend/src/api/voiceApi.ts",
      "status": "modified",
      "additions": 36,
      "deletions": 2,
      "changes": 38,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fapi%2FvoiceApi.ts?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -36,6 +36,8 @@ interface StatusResponse {\n     echoes?: any[];  // For echoes analysis\n     traits?: any[];  // For traits analysis\n     patterns?: any[];  // For patterns analysis\n+    image_base64?: string;  // For image generation\n+    prompt?: string;  // Image generation prompt\n   };\n   error?: string;\n }\n@@ -70,8 +72,8 @@ export async function triggerAnalysis(text: string, sessionId: string, voices?:\n  * Get analysis result (polls until completed)\n  */\n export async function getAnalysisResult(exec_id: string): Promise<StatusResponse['result']> {\n-  // Poll every 500ms, max 30 seconds\n-  const maxAttempts = 60;\n+  // Poll every 500ms, max 2 minutes (enough for image generation)\n+  const maxAttempts = 240;\n   let attempts = 0;\n \n   console.log('üîÑ Starting to poll for exec_id:', exec_id);\n@@ -229,3 +231,35 @@ export async function analyzePatterns(allNotes: string): Promise<any[]> {\n   const result = await getAnalysisResult(data.exec_id);\n   return result?.patterns || [];\n }\n+\n+/**\n+ * Generate a daily picture based on user's notes\n+ */\n+export async function generateDailyPicture(allNotes: string): Promise<{ image_base64: string; prompt: string }> {\n+  console.log('üé® Sending image generation request...');\n+\n+  const response = await fetch(`${API_BASE}/api/trigger`, {\n+    method: 'POST',\n+    headers: { 'Content-Type': 'application/json' },\n+    body: JSON.stringify({\n+      session_id: 'generate_daily_picture',\n+      params: { all_notes: allNotes }\n+    })\n+  });\n+\n+  const data: TriggerResponse = await response.json();\n+  if (!data.success) {\n+    throw new Error('Failed to trigger image generation');\n+  }\n+\n+  const result = await getAnalysisResult(data.exec_id);\n+\n+  if (result?.image_base64) {\n+    return {\n+      image_base64: result.image_base64,\n+      prompt: result.prompt || 'Generated from your notes'\n+    };\n+  }\n+\n+  throw new Error('Image generation failed');\n+}"
    },
    {
      "sha": "e6e5dd9dfb6b7c608346a95362dc5a290b821bcd",
      "filename": "frontend/src/components/AnalysisView.tsx",
      "status": "modified",
      "additions": 1123,
      "deletions": 447,
      "changes": 1570,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fcomponents%2FAnalysisView.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fcomponents%2FAnalysisView.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FAnalysisView.tsx?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -3,25 +3,100 @@ import { getCalendarData } from '../utils/calendarStorage';\n import { analyzeEchoes, analyzeTraits, analyzePatterns } from '../api/voiceApi';\n import type { TextCell } from '../engine/EditorEngine';\n \n+// @@@ Constants\n+const MAX_SAVED_REPORTS = 10;\n+const LOCALSTORAGE_KEY = 'analysis-reports-history';\n+\n+// @@@ Utility Functions\n+\n+// @@@ Count words properly for mixed Chinese/English text\n+function countWords(text: string): number {\n+  let wordCount = 0;\n+\n+  // Count CJK characters (each character = 1 word)\n+  for (let i = 0; i < text.length; i++) {\n+    const code = text.charCodeAt(i);\n+    if ((code >= 0x4E00 && code <= 0x9FFF) ||   // CJK Unified Ideographs\n+        (code >= 0x3400 && code <= 0x4DBF) ||   // CJK Extension A\n+        (code >= 0x3040 && code <= 0x309F) ||   // Hiragana\n+        (code >= 0x30A0 && code <= 0x30FF)) {   // Katakana\n+      wordCount++;\n+    }\n+  }\n+\n+  // Count English words (space-separated)\n+  const englishWords = text\n+    .replace(/[\\u4E00-\\u9FFF\\u3400-\\u4DBF\\u3040-\\u309F\\u30A0-\\u30FF]/g, ' ')\n+    .split(/\\s+/)\n+    .filter(w => w.length > 0).length;\n+\n+  return wordCount + englishWords;\n+}\n+\n+// @@@ Types\n+interface Echo {\n+  title: string;\n+  description: string;\n+  examples?: string[];\n+}\n+\n+interface Trait {\n+  trait: string;\n+  strength: number;\n+  evidence: string;\n+}\n+\n+interface Pattern {\n+  pattern: string;\n+  description: string;\n+  frequency: string;\n+}\n+\n+interface AnalysisReport {\n+  id: number;\n+  echoes: Echo[];\n+  traits: Trait[];\n+  patterns: Pattern[];\n+  timestamp: number;\n+  stats: {\n+    days: number;\n+    entries: number;\n+    words: number;\n+  };\n+}\n+\n export default function AnalysisView() {\n-  const [currentPage, setCurrentPage] = useState(0);\n   const [allNotes, setAllNotes] = useState('');\n+  const [echoes, setEchoes] = useState<Echo[]>([]);\n+  const [traits, setTraits] = useState<Trait[]>([]);\n+  const [patterns, setPatterns] = useState<Pattern[]>([]);\n+  const [loading, setLoading] = useState({ echoes: false, traits: false, patterns: false });\n+  const [error, setError] = useState('');\n+  const [currentPaper, setCurrentPaper] = useState(0); // @@@ Track which paper is on top\n+  const [viewMode, setViewMode] = useState<'dashboard' | 'report'>('dashboard'); // @@@ Track dashboard vs report view\n+\n+  // Stats\n+  const [stats, setStats] = useState({\n+    totalDays: 0,\n+    totalWords: 0,\n+    totalEntries: 0\n+  });\n \n-  const pages = [\n-    { id: 0, name: 'Adventure' },\n-    { id: 1, name: 'Patterns' },\n-    { id: 2, name: 'Traits' },\n-    { id: 3, name: 'Echoes' }\n-  ];\n+  // @@@ Saved reports history\n+  const [savedReports, setSavedReports] = useState<AnalysisReport[]>([]);\n \n   // Collect all notes when component mounts\n   useEffect(() => {\n     const calendarData = getCalendarData();\n     const notes: string[] = [];\n+    let entryCount = 0;\n+    const uniqueDays = new Set<string>();\n \n     // Collect all text from all entries\n     Object.keys(calendarData).forEach(dateKey => {\n+      uniqueDays.add(dateKey);\n       calendarData[dateKey].forEach(entry => {\n+        entryCount++;\n         entry.state.cells\n           .filter(cell => cell.type === 'text')\n           .forEach(cell => {\n@@ -33,528 +108,1129 @@ export default function AnalysisView() {\n       });\n     });\n \n-    setAllNotes(notes.join('\\n\\n'));\n+    const allText = notes.join('\\n\\n');\n+\n+    setAllNotes(allText);\n+    setStats({\n+      totalDays: uniqueDays.size,\n+      totalWords: countWords(allText),\n+      totalEntries: entryCount\n+    });\n+\n+    // @@@ Load saved reports history from localStorage\n+    const savedReportsData = localStorage.getItem(LOCALSTORAGE_KEY);\n+    if (savedReportsData) {\n+      try {\n+        const reports = JSON.parse(savedReportsData);\n+        setSavedReports(reports);\n+\n+        // @@@ Load most recent report into state (defensive checks for legacy data)\n+        if (reports.length > 0) {\n+          const mostRecent = reports[0];\n+          setEchoes(mostRecent.echoes || []);\n+          setTraits(mostRecent.traits || []);\n+          setPatterns(mostRecent.patterns || []);\n+        }\n+      } catch (e) {\n+        console.error('Failed to load saved reports:', e);\n+      }\n+    }\n   }, []);\n \n-  return (\n-    <div style={{\n-      width: '100%',\n-      height: '100%',\n-      display: 'flex',\n-      fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-      paddingTop: '2rem'\n-    }}>\n-      {/* Left sidebar - Page tabs */}\n-      <div style={{\n-        width: 200,\n-        background: 'transparent',\n-        alignSelf: 'stretch',\n-        paddingTop: '1rem',\n-        borderRight: '1px solid #d0c4b0'\n-      }}>\n-        {pages.map(page => (\n-          <div\n-            key={page.id}\n-            onClick={() => setCurrentPage(page.id)}\n-            style={{\n-              padding: '0.75rem 1.5rem',\n-              cursor: 'pointer',\n-              background: currentPage === page.id ? 'rgba(44, 44, 44, 0.05)' : 'transparent',\n-              borderLeft: currentPage === page.id ? '3px solid #333' : '3px solid transparent',\n-              fontWeight: currentPage === page.id ? 600 : 400,\n-              color: currentPage === page.id ? '#333' : '#888',\n-              transition: 'all 0.2s',\n-              fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n-              fontSize: 14\n-            }}\n-            onMouseEnter={e => {\n-              if (currentPage !== page.id) {\n-                e.currentTarget.style.color = '#555';\n-                e.currentTarget.style.background = 'rgba(44, 44, 44, 0.03)';\n-              }\n-            }}\n-            onMouseLeave={e => {\n-              if (currentPage !== page.id) {\n-                e.currentTarget.style.color = '#888';\n-                e.currentTarget.style.background = 'transparent';\n-              }\n-            }}\n-          >\n-            {page.name}\n-          </div>\n-        ))}\n-      </div>\n+  const handleAnalyzeAll = async () => {\n+    if (!allNotes.trim()) {\n+      setError('No notes found. Save some entries first.');\n+      return;\n+    }\n \n-      {/* Right content area */}\n-      <div style={{\n-        flex: 1,\n-        padding: '2rem',\n-        overflowY: 'auto',\n-        background: '#f8f0e6'\n-      }}>\n-        {currentPage === 0 && <Page0StickyNotes />}\n-        {currentPage === 1 && <PatternsPage allNotes={allNotes} />}\n-        {currentPage === 2 && <TraitsPage allNotes={allNotes} />}\n-        {currentPage === 3 && <EchoesPage allNotes={allNotes} />}\n-      </div>\n-    </div>\n-  );\n-}\n+    setError('');\n \n-// Page 0: Sticky notes with actionable nudges\n-function Page0StickyNotes() {\n-  const notes = [\n-    { text: '‰∏ãÊ¨°ÁÇπÂíñÂï°ÔºåËØïËØïËèúÂçï‰∏ä‰ªéÊ≤°ÁÇπËøáÁöÑÈÇ£‰∏Ä‰∏™„ÄÇ', color: '#FFF9BE', rotation: -2 },\n-    { text: 'Áªô‰∏Ä‰∏™Âæà‰πÖÊ≤°ËÅîÁ≥ªÁöÑ‰∫∫ÂèëÊù°Ê∂àÊÅØÔºåÂ∞±ËØ¥\"ÊÉ≥Ëµ∑‰Ω†‰∫Ü\"„ÄÇ', color: '#D4EAF1', rotation: 1 },\n-    { text: '‰ªäÂ§©Ëµ∞‰∏çÂêåÁöÑË∑ØÂõûÂÆ∂ÔºåÂì™ÊÄïÂè™ÊòØÊç¢‰∏ÄÊù°Ë°ó„ÄÇ', color: '#F1D4D4', rotation: -1 },\n-    { text: 'Âú®ÁîµÊ¢ØÈáåÂíåÈôåÁîü‰∫∫ËØ¥Âè•ËØùÔºåÊØîÂ¶Ç\"‰ªäÂ§©Â§©Ê∞î‰∏çÈîô\"„ÄÇ', color: '#FFF9BE', rotation: 2 },\n-    { text: 'Êää‰∏Ä‰ª∂Êãñ‰∫ÜÂæà‰πÖÁöÑÂ∞è‰∫ãÂÅöÊéâÔºå5 ÂàÜÈíüÂ∞±Â§ü‰∫Ü„ÄÇ', color: '#D4EAF1', rotation: -3 },\n-    { text: 'Èó≠‰∏äÁúºÁùõÂêÉ‰∏ÄÂè£‰∏úË•øÔºå‰∏ìÊ≥®Âú∞ÊÑüÂèóÂë≥ÈÅì„ÄÇ', color: '#F1D4D4', rotation: 1 }\n-  ];\n+    // @@@ Capture results to save to localStorage (state updates are async!)\n+    let echoesResult: Echo[] = [];\n+    let traitsResult: Trait[] = [];\n+    let patternsResult: Pattern[] = [];\n \n-  return (\n-    <div style={{\n-      display: 'grid',\n-      gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',\n-      gap: '2rem',\n-      padding: '2rem'\n-    }}>\n-      {notes.map((note, index) => (\n-        <div\n-          key={index}\n+    // @@@ Helper to wrap analysis calls with loading state and error handling\n+    const analyzeWithState = <T,>(\n+      analyzeFn: () => Promise<T>,\n+      loadingKey: 'echoes' | 'traits' | 'patterns',\n+      onSuccess: (result: T) => void\n+    ) => {\n+      setLoading(prev => ({ ...prev, [loadingKey]: true }));\n+      return analyzeFn()\n+        .then(result => {\n+          onSuccess(result);\n+          return result;\n+        })\n+        .catch(err => {\n+          console.error(`Failed to analyze ${loadingKey}:`, err);\n+          return [] as T;\n+        })\n+        .finally(() => setLoading(prev => ({ ...prev, [loadingKey]: false })));\n+    };\n+\n+    // Analyze all three in parallel\n+    [echoesResult, traitsResult, patternsResult] = await Promise.all([\n+      analyzeWithState(\n+        () => analyzeEchoes(allNotes),\n+        'echoes',\n+        result => setEchoes(result)\n+      ),\n+      analyzeWithState(\n+        () => analyzeTraits(allNotes),\n+        'traits',\n+        result => setTraits(result)\n+      ),\n+      analyzeWithState(\n+        () => analyzePatterns(allNotes),\n+        'patterns',\n+        result => setPatterns(result)\n+      )\n+    ]);\n+\n+    // @@@ Save report to localStorage history (prepend to array)\n+    const newReport: AnalysisReport = {\n+      id: Date.now(),\n+      echoes: echoesResult,\n+      traits: traitsResult,\n+      patterns: patternsResult,\n+      timestamp: Date.now(),\n+      stats: {\n+        days: stats.totalDays,\n+        entries: stats.totalEntries,\n+        words: stats.totalWords\n+      }\n+    };\n+\n+    // Get existing reports and prepend new one\n+    const updatedReports = [newReport, ...savedReports];\n+\n+    // Keep only last MAX_SAVED_REPORTS reports\n+    const limitedReports = updatedReports.slice(0, MAX_SAVED_REPORTS);\n+\n+    localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(limitedReports));\n+    setSavedReports(limitedReports);\n+\n+    // @@@ Switch to report view after analysis completes\n+    setViewMode('report');\n+    setCurrentPaper(0); // Reset to first paper\n+  };\n+\n+  const anyLoading = loading.echoes || loading.traits || loading.patterns;\n+  const hasAnyData = echoes.length > 0 || traits.length > 0 || patterns.length > 0;\n+\n+  // @@@ Full-page report view\n+  if (viewMode === 'report' && hasAnyData) {\n+    return (\n+      <div style={{\n+        width: '100%',\n+        height: '100%',\n+        background: 'linear-gradient(180deg, #f8f0e6 0%, #ede3d5 100%)',\n+        fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+        position: 'relative',\n+        overflow: 'hidden',\n+        display: 'flex',\n+        flexDirection: 'column'\n+      }}>\n+        {/* Back button - top left corner */}\n+        <button\n+          onClick={() => setViewMode('dashboard')}\n           style={{\n-            background: note.color,\n-            padding: '1.5rem',\n-            borderRadius: '4px',\n-            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',\n-            transform: `rotate(${note.rotation}deg)`,\n-            transition: 'all 0.2s',\n+            position: 'absolute',\n+            top: '2rem',\n+            left: '2rem',\n+            padding: '12px 24px',\n+            borderRadius: '24px',\n+            background: 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,250,240,0.9) 100%)',\n+            border: '2px solid rgba(139,115,85,0.25)',\n             cursor: 'pointer',\n-            minHeight: '120px',\n             display: 'flex',\n             alignItems: 'center',\n             justifyContent: 'center',\n-            textAlign: 'center',\n-            lineHeight: 1.6\n+            gap: '8px',\n+            fontSize: '14px',\n+            fontWeight: 500,\n+            color: '#5d4a3a',\n+            transition: 'all 0.3s',\n+            boxShadow: '0 4px 16px rgba(139,115,85,0.2), inset 0 1px 0 rgba(255,255,255,0.8)',\n+            zIndex: 30,\n+            fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n+            letterSpacing: '0.3px'\n           }}\n           onMouseEnter={e => {\n-            e.currentTarget.style.transform = `rotate(0deg) scale(1.05)`;\n-            e.currentTarget.style.boxShadow = '0 4px 16px rgba(0,0,0,0.15)';\n+            e.currentTarget.style.transform = 'translateY(-2px)';\n+            e.currentTarget.style.boxShadow = '0 8px 24px rgba(139,115,85,0.3), inset 0 1px 0 rgba(255,255,255,0.8)';\n+            e.currentTarget.style.background = 'linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,248,235,0.95) 100%)';\n           }}\n           onMouseLeave={e => {\n-            e.currentTarget.style.transform = `rotate(${note.rotation}deg) scale(1)`;\n-            e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';\n+            e.currentTarget.style.transform = 'translateY(0)';\n+            e.currentTarget.style.boxShadow = '0 4px 16px rgba(139,115,85,0.2), inset 0 1px 0 rgba(255,255,255,0.8)';\n+            e.currentTarget.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,250,240,0.9) 100%)';\n           }}\n+          title=\"Back to Dashboard\"\n         >\n-          {note.text}\n-        </div>\n-      ))}\n-    </div>\n-  );\n-}\n+          <span style={{ fontSize: '16px' }}>‚Üê</span>\n+          <span>Back</span>\n+        </button>\n \n-// @@@ Echoes Page - Recurring themes\n-function EchoesPage({ allNotes }: { allNotes: string }) {\n-  const [echoes, setEchoes] = useState<any[]>([]);\n-  const [loading, setLoading] = useState(false);\n-  const [error, setError] = useState('');\n+        <DecorativeInkSpots />\n \n-  const handleAnalyze = async () => {\n-    if (!allNotes.trim()) {\n-      setError('No notes found. Save some entries first.');\n-      return;\n-    }\n-\n-    setLoading(true);\n-    setError('');\n-\n-    try {\n-      const result = await analyzeEchoes(allNotes);\n-      setEchoes(result);\n-    } catch (e: any) {\n-      setError(e.message || 'Analysis failed');\n-    } finally {\n-      setLoading(false);\n-    }\n-  };\n+        {/* Centered paper stack - moved up slightly */}\n+        <div style={{\n+          flex: 1,\n+          display: 'flex',\n+          alignItems: 'center',\n+          justifyContent: 'center',\n+          padding: '2rem',\n+          marginTop: '-60px'\n+        }}>\n+          <PaperStack\n+            echoes={echoes}\n+            traits={traits}\n+            patterns={patterns}\n+            currentPaper={currentPaper}\n+            onPaperChange={setCurrentPaper}\n+          />\n+        </div>\n+      </div>\n+    );\n+  }\n \n+  // @@@ Dashboard view\n   return (\n-    <div style={{ maxWidth: '800px', margin: '0 auto' }}>\n-      <h2 style={{\n-        fontSize: '24px',\n-        fontWeight: 600,\n-        marginBottom: '1rem'\n-      }}>\n-        ÈáçÂ§çÂá∫Áé∞ÁöÑËØùÈ¢ò (Echoes)\n-      </h2>\n-\n-      <p style={{\n-        color: '#666',\n-        marginBottom: '2rem',\n-        lineHeight: 1.6\n-      }}>\n-        Identify recurring themes and topics across all your notes.\n-      </p>\n+    <div style={{\n+      width: '100%',\n+      height: '100%',\n+      overflowY: 'auto',\n+      background: 'linear-gradient(180deg, #f8f0e6 0%, #ede3d5 100%)',\n+      fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+      padding: '3rem 2rem',\n+      position: 'relative'\n+    }}>\n+      <DecorativeInkSpots />\n \n-      <button\n-        onClick={handleAnalyze}\n-        disabled={loading}\n-        style={{\n-          padding: '12px 24px',\n-          background: loading ? '#ccc' : '#333',\n-          color: '#fff',\n-          border: 'none',\n-          borderRadius: '6px',\n-          cursor: loading ? 'not-allowed' : 'pointer',\n-          fontSize: '14px',\n-          fontWeight: 600,\n-          marginBottom: '2rem'\n-        }}\n-      >\n-        {loading ? 'Analyzing...' : 'Analyze Echoes'}\n-      </button>\n+      <div style={{ maxWidth: '1100px', margin: '0 auto', position: 'relative' }}>\n+        {/* Header - Hand-drawn style */}\n+        <div style={{\n+          marginBottom: '3rem',\n+          textAlign: 'center',\n+          position: 'relative'\n+        }}>\n+          <h1 style={{\n+            fontSize: '48px',\n+            fontWeight: 400,\n+            color: '#3d3226',\n+            marginBottom: '0.75rem',\n+            fontFamily: 'Georgia, serif',\n+            fontStyle: 'italic',\n+            letterSpacing: '-0.5px',\n+            textShadow: '2px 2px 0px rgba(139,115,85,0.1)'\n+          }}>\n+            Reflections\n+          </h1>\n+          <div style={{\n+            width: '80px',\n+            height: '3px',\n+            background: 'linear-gradient(90deg, transparent, #8B7355, transparent)',\n+            margin: '0 auto 1rem',\n+            opacity: 0.4\n+          }} />\n+          <p style={{\n+            fontSize: '15px',\n+            color: '#6b5d4f',\n+            lineHeight: 1.8,\n+            fontStyle: 'italic',\n+            maxWidth: '500px',\n+            margin: '0 auto'\n+          }}>\n+            Patterns and insights woven through your words\n+          </p>\n+        </div>\n \n-      {error && (\n+        {/* Stats - Vintage label style */}\n         <div style={{\n-          padding: '1rem',\n-          background: '#fee',\n-          border: '1px solid #fcc',\n-          borderRadius: '6px',\n-          color: '#c33',\n-          marginBottom: '2rem'\n+          display: 'flex',\n+          justifyContent: 'center',\n+          gap: '2rem',\n+          marginBottom: '3rem',\n+          flexWrap: 'wrap'\n         }}>\n-          {error}\n+          <VintageStatLabel label=\"Days\" value={stats.totalDays} />\n+          <VintageStatLabel label=\"Entries\" value={stats.totalEntries} />\n+          <VintageStatLabel label=\"Words\" value={stats.totalWords.toLocaleString()} />\n         </div>\n-      )}\n \n-      <div style={{\n-        display: 'flex',\n-        flexDirection: 'column',\n-        gap: '1.5rem'\n-      }}>\n-        {echoes.map((echo, idx) => (\n-          <div\n-            key={idx}\n-            style={{\n-              background: '#fff',\n-              padding: '1.5rem',\n-              borderRadius: '8px',\n-              border: '1px solid #d0c4b0',\n-              boxShadow: '0 2px 4px rgba(0,0,0,0.05)'\n-            }}\n-          >\n-            <h3 style={{\n-              fontSize: '18px',\n-              fontWeight: 600,\n-              marginBottom: '0.75rem',\n-              color: '#333'\n-            }}>\n-              {echo.title}\n-            </h3>\n-            <p style={{\n-              color: '#666',\n-              lineHeight: 1.6,\n-              marginBottom: '1rem'\n+        {/* Saved Reports History */}\n+        {savedReports.length > 0 && (\n+          <div style={{ marginBottom: '3rem' }}>\n+            <h2 style={{\n+              fontSize: '20px',\n+              fontWeight: 500,\n+              color: '#5d4a3a',\n+              marginBottom: '1.5rem',\n+              textAlign: 'center',\n+              fontFamily: 'Georgia, serif',\n+              fontStyle: 'italic'\n             }}>\n-              {echo.description}\n-            </p>\n+              Past Reflections\n+            </h2>\n             <div style={{\n-              borderTop: '1px solid #f0f0f0',\n-              paddingTop: '1rem'\n+              display: 'grid',\n+              gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',\n+              gap: '1.5rem',\n+              marginBottom: '2rem'\n             }}>\n-              <div style={{\n-                fontSize: '12px',\n-                fontWeight: 600,\n-                color: '#999',\n-                marginBottom: '0.5rem'\n-              }}>\n-                EXAMPLES:\n-              </div>\n-              {echo.examples?.map((ex: string, i: number) => (\n+              {savedReports.map((report, idx) => (\n                 <div\n-                  key={i}\n+                  key={report.id}\n+                  onClick={() => {\n+                    setEchoes(report.echoes);\n+                    setTraits(report.traits);\n+                    setPatterns(report.patterns);\n+                    setViewMode('report');\n+                    setCurrentPaper(0);\n+                  }}\n                   style={{\n-                    padding: '0.5rem',\n-                    background: '#f8f0e6',\n-                    borderLeft: '3px solid #d0c4b0',\n-                    marginBottom: '0.5rem',\n-                    fontSize: '13px',\n-                    fontStyle: 'italic',\n-                    color: '#666'\n+                    padding: '1.5rem',\n+                    background: 'rgba(255,248,240,0.6)',\n+                    borderRadius: '16px',\n+                    border: '1px solid rgba(139,115,85,0.2)',\n+                    cursor: 'pointer',\n+                    transition: 'all 0.3s',\n+                    backdropFilter: 'blur(10px)'\n+                  }}\n+                  onMouseEnter={e => {\n+                    e.currentTarget.style.transform = 'translateY(-4px)';\n+                    e.currentTarget.style.boxShadow = '0 8px 24px rgba(139,115,85,0.2)';\n+                  }}\n+                  onMouseLeave={e => {\n+                    e.currentTarget.style.transform = 'translateY(0)';\n+                    e.currentTarget.style.boxShadow = 'none';\n                   }}\n                 >\n-                  \"{ex}\"\n+                  <div style={{\n+                    display: 'flex',\n+                    justifyContent: 'space-between',\n+                    alignItems: 'flex-start',\n+                    marginBottom: '1rem'\n+                  }}>\n+                    <div style={{\n+                      fontSize: '13px',\n+                      color: '#8B7355',\n+                      fontWeight: 500\n+                    }}>\n+                      {new Date(report.timestamp).toLocaleDateString('en-US', {\n+                        month: 'short',\n+                        day: 'numeric',\n+                        year: 'numeric',\n+                        hour: '2-digit',\n+                        minute: '2-digit'\n+                      })}\n+                    </div>\n+                    {idx === 0 && (\n+                      <div style={{\n+                        fontSize: '10px',\n+                        fontWeight: 600,\n+                        color: '#4CAF50',\n+                        background: 'rgba(76,175,80,0.1)',\n+                        padding: '4px 8px',\n+                        borderRadius: '8px',\n+                        textTransform: 'uppercase',\n+                        letterSpacing: '0.5px'\n+                      }}>\n+                        Latest\n+                      </div>\n+                    )}\n+                  </div>\n+                  <div style={{\n+                    display: 'flex',\n+                    gap: '1rem',\n+                    fontSize: '12px',\n+                    color: '#6b5d4f',\n+                    marginBottom: '0.75rem'\n+                  }}>\n+                    <div>{report.stats?.days || 0} days</div>\n+                    <div>¬∑</div>\n+                    <div>{report.stats?.entries || 0} entries</div>\n+                    <div>¬∑</div>\n+                    <div>{(report.stats?.words || 0).toLocaleString()} words</div>\n+                  </div>\n+                  <div style={{\n+                    display: 'flex',\n+                    gap: '0.5rem',\n+                    flexWrap: 'wrap'\n+                  }}>\n+                    {report.echoes?.length > 0 && (\n+                      <span style={{\n+                        fontSize: '11px',\n+                        padding: '4px 10px',\n+                        background: 'rgba(139,115,85,0.1)',\n+                        borderRadius: '12px',\n+                        color: '#5d4a3a'\n+                      }}>\n+                        {report.echoes.length} echoes\n+                      </span>\n+                    )}\n+                    {report.traits?.length > 0 && (\n+                      <span style={{\n+                        fontSize: '11px',\n+                        padding: '4px 10px',\n+                        background: 'rgba(139,115,85,0.1)',\n+                        borderRadius: '12px',\n+                        color: '#5d4a3a'\n+                      }}>\n+                        {report.traits.length} traits\n+                      </span>\n+                    )}\n+                    {report.patterns?.length > 0 && (\n+                      <span style={{\n+                        fontSize: '11px',\n+                        padding: '4px 10px',\n+                        background: 'rgba(139,115,85,0.1)',\n+                        borderRadius: '12px',\n+                        color: '#5d4a3a'\n+                      }}>\n+                        {report.patterns.length} patterns\n+                      </span>\n+                    )}\n+                  </div>\n                 </div>\n               ))}\n             </div>\n           </div>\n-        ))}\n+        )}\n+\n+        {/* Analyze Button - Ink stamp style */}\n+        <div style={{ marginBottom: '3rem', textAlign: 'center' }}>\n+          <button\n+            onClick={handleAnalyzeAll}\n+            disabled={anyLoading}\n+            style={{\n+              padding: '16px 48px',\n+              background: anyLoading ? 'rgba(139,115,85,0.3)' : 'transparent',\n+              color: anyLoading ? '#999' : '#5d4a3a',\n+              border: '2px solid',\n+              borderColor: anyLoading ? '#ccc' : '#8B7355',\n+              borderRadius: '30px',\n+              cursor: anyLoading ? 'not-allowed' : 'pointer',\n+              fontSize: '15px',\n+              fontWeight: 500,\n+              fontFamily: 'Georgia, serif',\n+              transition: 'all 0.3s',\n+              letterSpacing: '1px',\n+              textTransform: 'uppercase',\n+              position: 'relative',\n+              overflow: 'hidden'\n+            }}\n+            onMouseEnter={e => {\n+              if (!anyLoading) {\n+                e.currentTarget.style.background = 'rgba(139,115,85,0.12)';\n+                e.currentTarget.style.transform = 'translateY(-2px)';\n+                e.currentTarget.style.boxShadow = '0 6px 20px rgba(139,115,85,0.2)';\n+              }\n+            }}\n+            onMouseLeave={e => {\n+              if (!anyLoading) {\n+                e.currentTarget.style.background = 'transparent';\n+                e.currentTarget.style.transform = 'translateY(0)';\n+                e.currentTarget.style.boxShadow = 'none';\n+              }\n+            }}\n+          >\n+            {anyLoading ? 'Reflecting...' : 'Generate New Analysis'}\n+          </button>\n+        </div>\n+\n+        {error && (\n+          <div style={{\n+            padding: '1rem',\n+            background: '#fee',\n+            border: '1px solid #fcc',\n+            borderRadius: '8px',\n+            color: '#c33',\n+            marginBottom: '2rem',\n+            textAlign: 'center'\n+          }}>\n+            {error}\n+          </div>\n+        )}\n+\n+        {/* Empty State - Journal page aesthetic */}\n+        {!hasAnyData && !anyLoading && (\n+          <div style={{\n+            textAlign: 'center',\n+            padding: '5rem 2rem',\n+            position: 'relative'\n+          }}>\n+            {/* Decorative watercolor wash */}\n+            <div style={{\n+              position: 'absolute',\n+              top: '50%',\n+              left: '50%',\n+              transform: 'translate(-50%, -50%)',\n+              width: '300px',\n+              height: '300px',\n+              borderRadius: '50%',\n+              background: 'radial-gradient(circle, rgba(139,115,85,0.06) 0%, transparent 70%)',\n+              filter: 'blur(40px)',\n+              pointerEvents: 'none'\n+            }} />\n+\n+            <div style={{\n+              fontSize: '72px',\n+              marginBottom: '1.5rem',\n+              opacity: 0.3,\n+              filter: 'grayscale(100%)'\n+            }}>\n+              üìñ\n+            </div>\n+            <p style={{\n+              fontSize: '20px',\n+              marginBottom: '0.75rem',\n+              color: '#5d4a3a',\n+              fontFamily: 'Georgia, serif',\n+              fontStyle: 'italic',\n+              fontWeight: 300\n+            }}>\n+              Your story awaits analysis\n+            </p>\n+            <p style={{\n+              fontSize: '14px',\n+              color: '#8B7355',\n+              maxWidth: '400px',\n+              margin: '0 auto',\n+              lineHeight: 1.7\n+            }}>\n+              Begin the journey to discover the patterns, themes, and essence woven through your words\n+            </p>\n+          </div>\n+        )}\n       </div>\n     </div>\n   );\n }\n \n-// @@@ Traits Page - Personality characteristics\n-function TraitsPage({ allNotes }: { allNotes: string }) {\n-  const [traits, setTraits] = useState<any[]>([]);\n-  const [loading, setLoading] = useState(false);\n-  const [error, setError] = useState('');\n-\n-  const handleAnalyze = async () => {\n-    if (!allNotes.trim()) {\n-      setError('No notes found. Save some entries first.');\n-      return;\n-    }\n-\n-    setLoading(true);\n-    setError('');\n-\n-    try {\n-      const result = await analyzeTraits(allNotes);\n-      setTraits(result);\n-    } catch (e: any) {\n-      setError(e.message || 'Analysis failed');\n-    } finally {\n-      setLoading(false);\n-    }\n-  };\n+// @@@ Reusable Components\n \n+// @@@ Decorative ink spot background elements\n+function DecorativeInkSpots() {\n   return (\n-    <div style={{ maxWidth: '800px', margin: '0 auto' }}>\n-      <h2 style={{\n-        fontSize: '24px',\n-        fontWeight: 600,\n-        marginBottom: '1rem'\n-      }}>\n-        ÊÄßÊ†ºÁâπÂæÅÂàÜÊûê (Traits)\n-      </h2>\n+    <>\n+      <div style={{\n+        position: 'absolute',\n+        top: '10%',\n+        right: '5%',\n+        width: '120px',\n+        height: '120px',\n+        borderRadius: '50%',\n+        background: 'radial-gradient(circle, rgba(139,115,85,0.08) 0%, rgba(139,115,85,0) 70%)',\n+        filter: 'blur(20px)',\n+        pointerEvents: 'none'\n+      }} />\n+      <div style={{\n+        position: 'absolute',\n+        bottom: '20%',\n+        left: '8%',\n+        width: '150px',\n+        height: '150px',\n+        borderRadius: '50%',\n+        background: 'radial-gradient(circle, rgba(160,130,109,0.06) 0%, rgba(160,130,109,0) 70%)',\n+        filter: 'blur(25px)',\n+        pointerEvents: 'none'\n+      }} />\n+    </>\n+  );\n+}\n \n-      <p style={{\n-        color: '#666',\n-        marginBottom: '2rem',\n-        lineHeight: 1.6\n-      }}>\n-        Identify personality traits evident from your writing.\n-      </p>\n+// @@@ Stacked Paper Component - Realistic paper effect with navigation\n+function PaperStack({\n+  echoes,\n+  traits,\n+  patterns,\n+  currentPaper,\n+  onPaperChange\n+}: {\n+  echoes: Echo[];\n+  traits: Trait[];\n+  patterns: Pattern[];\n+  currentPaper: number;\n+  onPaperChange: (index: number) => void;\n+}) {\n+  // @@@ Build papers array (only include non-empty ones)\n+  const papers = [];\n \n-      <button\n-        onClick={handleAnalyze}\n-        disabled={loading}\n-        style={{\n-          padding: '12px 24px',\n-          background: loading ? '#ccc' : '#333',\n-          color: '#fff',\n-          border: 'none',\n-          borderRadius: '6px',\n-          cursor: loading ? 'not-allowed' : 'pointer',\n-          fontSize: '14px',\n-          fontWeight: 600,\n-          marginBottom: '2rem'\n-        }}\n-      >\n-        {loading ? 'Analyzing...' : 'Analyze Traits'}\n-      </button>\n+  if (echoes.length > 0) {\n+    papers.push({\n+      title: 'Recurring Themes',\n+      subtitle: 'Echoes',\n+      icon: 'üîÑ',\n+      content: (\n+        <div style={{\n+          display: 'flex',\n+          flexDirection: 'column',\n+          gap: '1rem',\n+          maxHeight: '500px',\n+          overflowY: 'auto',\n+          paddingRight: '1rem'\n+        }}>\n+          {echoes.map((echo, idx) => (\n+            <EchoCard key={idx} echo={echo} />\n+          ))}\n+        </div>\n+      )\n+    });\n+  }\n \n-      {error && (\n+  if (traits.length > 0) {\n+    papers.push({\n+      title: 'Character Traits',\n+      subtitle: 'Personality',\n+      icon: '‚≠ê',\n+      content: (\n         <div style={{\n-          padding: '1rem',\n-          background: '#fee',\n-          border: '1px solid #fcc',\n-          borderRadius: '6px',\n-          color: '#c33',\n-          marginBottom: '2rem'\n+          display: 'grid',\n+          gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',\n+          gap: '1rem',\n+          maxHeight: '500px',\n+          overflowY: 'auto',\n+          paddingRight: '1rem'\n         }}>\n-          {error}\n+          {traits.map((trait, idx) => (\n+            <TraitCard key={idx} trait={trait} />\n+          ))}\n         </div>\n-      )}\n+      )\n+    });\n+  }\n+\n+  if (patterns.length > 0) {\n+    papers.push({\n+      title: 'Behavioral Patterns',\n+      subtitle: 'Habits',\n+      icon: 'üåÄ',\n+      content: (\n+        <div style={{\n+          display: 'flex',\n+          flexDirection: 'column',\n+          gap: '1rem',\n+          maxHeight: '500px',\n+          overflowY: 'auto',\n+          paddingRight: '1rem'\n+        }}>\n+          {patterns.map((pattern, idx) => (\n+            <PatternCard key={idx} pattern={pattern} />\n+          ))}\n+        </div>\n+      )\n+    });\n+  }\n+\n+  const totalPapers = papers.length;\n+  if (totalPapers === 0) return null;\n \n+  return (\n+    <div style={{\n+      position: 'relative',\n+      width: '100%',\n+      maxWidth: '1100px',\n+      height: '650px',\n+      margin: '0 auto',\n+      perspective: '1200px'\n+    }}>\n+      {/* Stack of papers */}\n       <div style={{\n-        display: 'grid',\n-        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',\n-        gap: '1.5rem'\n+        position: 'absolute',\n+        top: '50%',\n+        left: '50%',\n+        transform: 'translate(-50%, -50%)',\n+        marginLeft: '-30px',\n+        width: '100%',\n+        maxWidth: '900px',\n+        height: '600px'\n       }}>\n-        {traits.map((trait, idx) => (\n-          <div\n-            key={idx}\n+        {papers.map((paper, idx) => {\n+          const isActive = idx === currentPaper;\n+          const isBehind = idx < currentPaper;\n+          const offset = isActive ? 0 : isBehind ? -10 : 10;\n+          const zIndex = isActive ? 10 : isBehind ? totalPapers - idx : idx;\n+\n+          return (\n+            <div\n+              key={idx}\n+              style={{\n+                position: 'absolute',\n+                top: 0,\n+                left: '50%',\n+                transform: `translateX(-50%) translateY(${offset}px) rotate(${isActive ? 0 : isBehind ? -0.5 : 0.5}deg)`,\n+                width: '100%',\n+                height: '100%',\n+                transition: 'all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)',\n+                opacity: isActive ? 1 : 0.4,\n+                pointerEvents: isActive ? 'auto' : 'none',\n+                zIndex\n+              }}\n+            >\n+              {/* Paper sheet with realistic effects */}\n+              <div style={{\n+                width: '100%',\n+                height: '100%',\n+                background: `\n+                  linear-gradient(135deg,\n+                    rgba(255,255,255,0.95) 0%,\n+                    rgba(255,250,240,0.92) 50%,\n+                    rgba(255,248,235,0.9) 100%\n+                  )\n+                `,\n+                borderRadius: '3px',\n+                boxShadow: `\n+                  0 1px 3px rgba(139,115,85,0.12),\n+                  0 4px 12px rgba(139,115,85,0.15),\n+                  0 10px 30px rgba(139,115,85,0.2),\n+                  inset 0 1px 0 rgba(255,255,255,0.9),\n+                  inset 0 -1px 0 rgba(139,115,85,0.08)\n+                `,\n+                border: '1px solid rgba(139,115,85,0.15)',\n+                padding: '3rem',\n+                overflow: 'hidden',\n+                position: 'relative'\n+              }}>\n+                {/* Paper texture overlay */}\n+                <div style={{\n+                  position: 'absolute',\n+                  top: 0,\n+                  left: 0,\n+                  right: 0,\n+                  bottom: 0,\n+                  backgroundImage: `\n+                    repeating-linear-gradient(\n+                      0deg,\n+                      rgba(139,115,85,0.01) 0px,\n+                      rgba(139,115,85,0.015) 1px,\n+                      transparent 1px,\n+                      transparent 2px\n+                    ),\n+                    repeating-linear-gradient(\n+                      90deg,\n+                      rgba(139,115,85,0.008) 0px,\n+                      rgba(139,115,85,0.012) 1px,\n+                      transparent 1px,\n+                      transparent 2px\n+                    )\n+                  `,\n+                  pointerEvents: 'none',\n+                  opacity: 0.7\n+                }} />\n+\n+                {/* Decorative watercolor wash */}\n+                <div style={{\n+                  position: 'absolute',\n+                  top: '10%',\n+                  right: '5%',\n+                  width: '150px',\n+                  height: '150px',\n+                  borderRadius: '50%',\n+                  background: 'radial-gradient(circle, rgba(160,130,109,0.06) 0%, transparent 70%)',\n+                  filter: 'blur(30px)',\n+                  pointerEvents: 'none'\n+                }} />\n+\n+                {/* Paper content */}\n+                <div style={{ position: 'relative', zIndex: 1 }}>\n+                  {/* Paper header */}\n+                  <div style={{\n+                    marginBottom: '2rem',\n+                    borderBottom: '2px solid rgba(139,115,85,0.15)',\n+                    paddingBottom: '1rem'\n+                  }}>\n+                    <div style={{\n+                      display: 'flex',\n+                      alignItems: 'center',\n+                      gap: '0.75rem',\n+                      marginBottom: '0.5rem'\n+                    }}>\n+                      <span style={{ fontSize: '32px' }}>{paper.icon}</span>\n+                      <div>\n+                        <h2 style={{\n+                          fontSize: '28px',\n+                          fontWeight: 400,\n+                          color: '#3d3226',\n+                          fontFamily: 'Georgia, serif',\n+                          fontStyle: 'italic',\n+                          letterSpacing: '-0.3px',\n+                          margin: 0,\n+                          lineHeight: 1.2\n+                        }}>\n+                          {paper.title}\n+                        </h2>\n+                        <div style={{\n+                          fontSize: '12px',\n+                          color: '#8B7355',\n+                          textTransform: 'uppercase',\n+                          letterSpacing: '1.5px',\n+                          fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n+                          fontWeight: 500\n+                        }}>\n+                          {paper.subtitle}\n+                        </div>\n+                      </div>\n+                    </div>\n+                  </div>\n+\n+                  {/* Paper body */}\n+                  {paper.content}\n+                </div>\n+              </div>\n+            </div>\n+          );\n+        })}\n+      </div>\n+\n+      {/* Navigation arrows */}\n+      {totalPapers > 1 && (\n+        <>\n+          <button\n+            onClick={() => onPaperChange(Math.max(0, currentPaper - 1))}\n+            disabled={currentPaper === 0}\n             style={{\n-              background: '#fff',\n-              padding: '1.5rem',\n-              borderRadius: '8px',\n-              border: '1px solid #d0c4b0',\n-              boxShadow: '0 2px 4px rgba(0,0,0,0.05)'\n+              position: 'absolute',\n+              left: '50%',\n+              marginLeft: '-540px',\n+              top: '50%',\n+              transform: 'translateY(-50%)',\n+              width: '48px',\n+              height: '48px',\n+              borderRadius: '50%',\n+              background: currentPaper === 0 ? 'rgba(139,115,85,0.1)' : 'rgba(255,255,255,0.95)',\n+              border: '2px solid rgba(139,115,85,0.2)',\n+              cursor: currentPaper === 0 ? 'not-allowed' : 'pointer',\n+              display: 'flex',\n+              alignItems: 'center',\n+              justifyContent: 'center',\n+              fontSize: '20px',\n+              color: currentPaper === 0 ? '#ccc' : '#5d4a3a',\n+              transition: 'all 0.3s',\n+              boxShadow: currentPaper === 0 ? 'none' : '0 4px 12px rgba(139,115,85,0.15)',\n+              zIndex: 20\n+            }}\n+            onMouseEnter={e => {\n+              if (currentPaper !== 0) {\n+                e.currentTarget.style.transform = 'translateY(-50%) scale(1.1)';\n+                e.currentTarget.style.boxShadow = '0 6px 20px rgba(139,115,85,0.25)';\n+              }\n+            }}\n+            onMouseLeave={e => {\n+              e.currentTarget.style.transform = 'translateY(-50%) scale(1)';\n+              e.currentTarget.style.boxShadow = currentPaper === 0 ? 'none' : '0 4px 12px rgba(139,115,85,0.15)';\n             }}\n           >\n-            <div style={{\n+            ‚Üê\n+          </button>\n+\n+          <button\n+            onClick={() => onPaperChange(Math.min(totalPapers - 1, currentPaper + 1))}\n+            disabled={currentPaper === totalPapers - 1}\n+            style={{\n+              position: 'absolute',\n+              left: '50%',\n+              marginLeft: '530px',\n+              top: '50%',\n+              transform: 'translateY(-50%)',\n+              width: '48px',\n+              height: '48px',\n+              borderRadius: '50%',\n+              background: currentPaper === totalPapers - 1 ? 'rgba(139,115,85,0.1)' : 'rgba(255,255,255,0.95)',\n+              border: '2px solid rgba(139,115,85,0.2)',\n+              cursor: currentPaper === totalPapers - 1 ? 'not-allowed' : 'pointer',\n               display: 'flex',\n-              justifyContent: 'space-between',\n               alignItems: 'center',\n-              marginBottom: '0.75rem'\n-            }}>\n-              <h3 style={{\n-                fontSize: '18px',\n-                fontWeight: 600,\n-                color: '#333'\n-              }}>\n-                {trait.trait}\n-              </h3>\n-              <div style={{\n-                fontSize: '14px',\n-                fontWeight: 600,\n-                color: '#666',\n-                background: '#f0f0f0',\n-                padding: '4px 8px',\n-                borderRadius: '4px'\n-              }}>\n-                {trait.strength}/5\n-              </div>\n-            </div>\n-            {/* Strength bar */}\n-            <div style={{\n-              height: '6px',\n-              background: '#f0f0f0',\n-              borderRadius: '3px',\n-              marginBottom: '1rem',\n-              overflow: 'hidden'\n-            }}>\n-              <div style={{\n-                height: '100%',\n-                width: `${(trait.strength / 5) * 100}%`,\n-                background: 'linear-gradient(90deg, #4CAF50, #8BC34A)',\n-                borderRadius: '3px'\n-              }} />\n-            </div>\n-            <p style={{\n-              color: '#666',\n-              lineHeight: 1.6,\n-              fontSize: '13px'\n-            }}>\n-              {trait.evidence}\n-            </p>\n+              justifyContent: 'center',\n+              fontSize: '20px',\n+              color: currentPaper === totalPapers - 1 ? '#ccc' : '#5d4a3a',\n+              transition: 'all 0.3s',\n+              boxShadow: currentPaper === totalPapers - 1 ? 'none' : '0 4px 12px rgba(139,115,85,0.15)',\n+              zIndex: 20\n+            }}\n+            onMouseEnter={e => {\n+              if (currentPaper !== totalPapers - 1) {\n+                e.currentTarget.style.transform = 'translateY(-50%) scale(1.1)';\n+                e.currentTarget.style.boxShadow = '0 6px 20px rgba(139,115,85,0.25)';\n+              }\n+            }}\n+            onMouseLeave={e => {\n+              e.currentTarget.style.transform = 'translateY(-50%) scale(1)';\n+              e.currentTarget.style.boxShadow = currentPaper === totalPapers - 1 ? 'none' : '0 4px 12px rgba(139,115,85,0.15)';\n+            }}\n+          >\n+            ‚Üí\n+          </button>\n+\n+          {/* Paper indicators */}\n+          <div style={{\n+            position: 'absolute',\n+            bottom: '-40px',\n+            left: '50%',\n+            transform: 'translateX(-50%)',\n+            display: 'flex',\n+            gap: '10px',\n+            zIndex: 20\n+          }}>\n+            {papers.map((_, idx) => (\n+              <button\n+                key={idx}\n+                onClick={() => onPaperChange(idx)}\n+                style={{\n+                  width: '12px',\n+                  height: '12px',\n+                  borderRadius: '50%',\n+                  background: idx === currentPaper ? '#8B7355' : 'rgba(139,115,85,0.3)',\n+                  border: 'none',\n+                  cursor: 'pointer',\n+                  transition: 'all 0.3s',\n+                  padding: 0\n+                }}\n+                onMouseEnter={e => {\n+                  if (idx !== currentPaper) {\n+                    e.currentTarget.style.background = 'rgba(139,115,85,0.5)';\n+                    e.currentTarget.style.transform = 'scale(1.2)';\n+                  }\n+                }}\n+                onMouseLeave={e => {\n+                  if (idx !== currentPaper) {\n+                    e.currentTarget.style.background = 'rgba(139,115,85,0.3)';\n+                    e.currentTarget.style.transform = 'scale(1)';\n+                  }\n+                }}\n+              />\n+            ))}\n           </div>\n-        ))}\n-      </div>\n+        </>\n+      )}\n     </div>\n   );\n }\n \n-// @@@ Patterns Page - Behavioral patterns\n-function PatternsPage({ allNotes }: { allNotes: string }) {\n-  const [patterns, setPatterns] = useState<any[]>([]);\n-  const [loading, setLoading] = useState(false);\n-  const [error, setError] = useState('');\n-\n-  const handleAnalyze = async () => {\n-    if (!allNotes.trim()) {\n-      setError('No notes found. Save some entries first.');\n-      return;\n-    }\n-\n-    setLoading(true);\n-    setError('');\n-\n-    try {\n-      const result = await analyzePatterns(allNotes);\n-      setPatterns(result);\n-    } catch (e: any) {\n-      setError(e.message || 'Analysis failed');\n-    } finally {\n-      setLoading(false);\n-    }\n-  };\n-\n+function VintageStatLabel({ label, value }: { label: string; value: number | string }) {\n   return (\n-    <div style={{ maxWidth: '800px', margin: '0 auto' }}>\n-      <h2 style={{\n-        fontSize: '24px',\n-        fontWeight: 600,\n-        marginBottom: '1rem'\n+    <div style={{\n+      display: 'inline-flex',\n+      flexDirection: 'column',\n+      alignItems: 'center',\n+      gap: '0.5rem'\n+    }}>\n+      <div style={{\n+        fontSize: '36px',\n+        fontWeight: 300,\n+        color: '#5d4a3a',\n+        fontFamily: 'Georgia, serif',\n+        lineHeight: 1\n+      }}>\n+        {value}\n+      </div>\n+      <div style={{\n+        fontSize: '11px',\n+        color: '#8B7355',\n+        fontWeight: 500,\n+        textTransform: 'uppercase',\n+        letterSpacing: '1.5px',\n+        fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n+        borderTop: '1px solid rgba(139,115,85,0.3)',\n+        paddingTop: '0.5rem'\n       }}>\n-        Ë°å‰∏∫Ê®°ÂºèÂàÜÊûê (Patterns)\n-      </h2>\n+        {label}\n+      </div>\n+    </div>\n+  );\n+}\n \n+function EchoCard({ echo }: { echo: Echo }) {\n+  return (\n+    <div style={{\n+      background: 'rgba(255,248,240,0.6)',\n+      padding: '1.75rem',\n+      borderRadius: '16px',\n+      border: '1px solid rgba(139,115,85,0.2)',\n+      transition: 'all 0.3s',\n+      position: 'relative',\n+      backdropFilter: 'blur(10px)'\n+    }}>\n+      <h3 style={{\n+        fontSize: '19px',\n+        fontWeight: 500,\n+        color: '#3d3226',\n+        marginBottom: '1rem',\n+        fontFamily: 'Georgia, serif',\n+        fontStyle: 'italic',\n+        position: 'relative'\n+      }}>\n+        {echo.title}\n+      </h3>\n       <p style={{\n-        color: '#666',\n-        marginBottom: '2rem',\n-        lineHeight: 1.6\n+        color: '#5d4a3a',\n+        lineHeight: 1.8,\n+        marginBottom: '1.25rem',\n+        fontSize: '14px'\n       }}>\n-        Identify behavioral patterns and habits from your notes.\n+        {echo.description}\n       </p>\n+      {echo.examples && echo.examples.length > 0 && (\n+        <div>\n+          <div style={{\n+            fontSize: '10px',\n+            fontWeight: 600,\n+            color: '#8B7355',\n+            marginBottom: '0.75rem',\n+            textTransform: 'uppercase',\n+            letterSpacing: '1px',\n+            fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif'\n+          }}>\n+            Echoes\n+          </div>\n+          {echo.examples.map((ex: string, i: number) => (\n+            <div\n+              key={i}\n+              style={{\n+                padding: '1rem',\n+                background: 'rgba(255,255,255,0.7)',\n+                borderLeft: '4px solid rgba(139,115,85,0.4)',\n+                marginBottom: '0.75rem',\n+                fontSize: '13px',\n+                fontStyle: 'italic',\n+                color: '#5d4a3a',\n+                borderRadius: '0 8px 8px 0',\n+                lineHeight: 1.6\n+              }}\n+            >\n+              \"{ex}\"\n+            </div>\n+          ))}\n+        </div>\n+      )}\n+    </div>\n+  );\n+}\n \n-      <button\n-        onClick={handleAnalyze}\n-        disabled={loading}\n-        style={{\n-          padding: '12px 24px',\n-          background: loading ? '#ccc' : '#333',\n-          color: '#fff',\n-          border: 'none',\n-          borderRadius: '6px',\n-          cursor: loading ? 'not-allowed' : 'pointer',\n-          fontSize: '14px',\n-          fontWeight: 600,\n-          marginBottom: '2rem'\n-        }}\n-      >\n-        {loading ? 'Analyzing...' : 'Analyze Patterns'}\n-      </button>\n-\n-      {error && (\n+function TraitCard({ trait }: { trait: Trait }) {\n+  return (\n+    <div style={{\n+      background: 'rgba(255,252,247,0.7)',\n+      padding: '1.75rem',\n+      borderRadius: '18px',\n+      border: '1px solid rgba(139,115,85,0.2)',\n+      transition: 'all 0.3s',\n+      position: 'relative',\n+      backdropFilter: 'blur(8px)'\n+    }}>\n+      <div style={{\n+        display: 'flex',\n+        justifyContent: 'space-between',\n+        alignItems: 'flex-start',\n+        marginBottom: '1.25rem'\n+      }}>\n+        <h3 style={{\n+          fontSize: '18px',\n+          fontWeight: 500,\n+          color: '#3d3226',\n+          fontFamily: 'Georgia, serif',\n+          fontStyle: 'italic',\n+          flex: 1\n+        }}>\n+          {trait.trait}\n+        </h3>\n         <div style={{\n-          padding: '1rem',\n-          background: '#fee',\n-          border: '1px solid #fcc',\n-          borderRadius: '6px',\n-          color: '#c33',\n-          marginBottom: '2rem'\n+          fontSize: '12px',\n+          fontWeight: 600,\n+          color: '#8B7355',\n+          background: 'rgba(139,115,85,0.1)',\n+          padding: '6px 12px',\n+          borderRadius: '20px',\n+          fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n+          border: '1px solid rgba(139,115,85,0.2)',\n+          marginLeft: '1rem'\n         }}>\n-          {error}\n+          {trait.strength}/5\n         </div>\n-      )}\n+      </div>\n \n+      {/* Organic strength indicator */}\n       <div style={{\n         display: 'flex',\n-        flexDirection: 'column',\n-        gap: '1.5rem'\n+        gap: '6px',\n+        marginBottom: '1.25rem'\n       }}>\n-        {patterns.map((pattern, idx) => (\n+        {[1, 2, 3, 4, 5].map(i => (\n           <div\n-            key={idx}\n+            key={i}\n             style={{\n-              background: '#fff',\n-              padding: '1.5rem',\n-              borderRadius: '8px',\n-              border: '1px solid #d0c4b0',\n-              boxShadow: '0 2px 4px rgba(0,0,0,0.05)'\n+              flex: 1,\n+              height: '6px',\n+              borderRadius: '3px',\n+              background: i <= trait.strength\n+                ? 'linear-gradient(90deg, rgba(139,115,85,0.6), rgba(160,130,109,0.4))'\n+                : 'rgba(139,115,85,0.1)',\n+              transition: 'all 0.4s',\n+              opacity: i <= trait.strength ? 1 : 0.4\n             }}\n-          >\n-            <h3 style={{\n-              fontSize: '18px',\n-              fontWeight: 600,\n-              marginBottom: '0.75rem',\n-              color: '#333'\n-            }}>\n-              {pattern.pattern}\n-            </h3>\n-            <p style={{\n-              color: '#666',\n-              lineHeight: 1.6,\n-              marginBottom: '1rem'\n-            }}>\n-              {pattern.description}\n-            </p>\n-            <div style={{\n-              display: 'flex',\n-              alignItems: 'center',\n-              gap: '0.5rem',\n-              fontSize: '13px',\n-              color: '#999'\n-            }}>\n-              <span style={{ fontWeight: 600 }}>Frequency:</span>\n-              <span>{pattern.frequency}</span>\n-            </div>\n-          </div>\n+          />\n         ))}\n       </div>\n+\n+      <p style={{\n+        color: '#5d4a3a',\n+        lineHeight: 1.8,\n+        fontSize: '13px'\n+      }}>\n+        {trait.evidence}\n+      </p>\n+    </div>\n+  );\n+}\n+\n+function PatternCard({ pattern }: { pattern: Pattern }) {\n+  return (\n+    <div style={{\n+      background: 'rgba(255,250,242,0.6)',\n+      padding: '1.75rem',\n+      borderRadius: '16px',\n+      border: '1px solid rgba(139,115,85,0.2)',\n+      transition: 'all 0.3s',\n+      position: 'relative',\n+      backdropFilter: 'blur(10px)'\n+    }}>\n+      <h3 style={{\n+        fontSize: '19px',\n+        fontWeight: 500,\n+        color: '#3d3226',\n+        marginBottom: '1rem',\n+        fontFamily: 'Georgia, serif',\n+        fontStyle: 'italic',\n+        position: 'relative'\n+      }}>\n+        {pattern.pattern}\n+      </h3>\n+      <p style={{\n+        color: '#5d4a3a',\n+        lineHeight: 1.8,\n+        marginBottom: '1.25rem',\n+        fontSize: '14px'\n+      }}>\n+        {pattern.description}\n+      </p>\n+      <div style={{\n+        display: 'inline-flex',\n+        alignItems: 'center',\n+        gap: '0.5rem',\n+        fontSize: '12px',\n+        color: '#8B7355',\n+        fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n+        background: 'rgba(139,115,85,0.08)',\n+        padding: '6px 14px',\n+        borderRadius: '20px',\n+        border: '1px solid rgba(139,115,85,0.15)'\n+      }}>\n+        <span style={{ fontWeight: 600 }}>Frequency:</span>\n+        <span style={{ fontStyle: 'italic' }}>{pattern.frequency}</span>\n+      </div>\n     </div>\n   );\n }\n+"
    },
    {
      "sha": "4e95898cb620d2bff95095b8caf313e06215d54c",
      "filename": "frontend/src/components/CollectionsView.tsx",
      "status": "modified",
      "additions": 687,
      "deletions": 241,
      "changes": 928,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -1,83 +1,164 @@\n-import { useState, useEffect } from 'react';\n+import { useState, useEffect, useRef } from 'react';\n import type { Commentor } from '../engine/EditorEngine';\n \n-export default function CollectionsView() {\n-  const [currentPage, setCurrentPage] = useState(0);\n-\n-  const pages = [\n-    { id: 0, name: 'Starred Comments' },\n-    { id: 1, name: 'Daily Pictures' }\n-  ];\n+// @@@ TypeScript interfaces\n+interface TimelineDay {\n+  date: string;\n+  isPast: boolean;\n+  isFuture: boolean;\n+  isToday: boolean;\n+  daysOffset: number;\n+}\n \n+export default function CollectionsView() {\n   return (\n     <div style={{\n       width: '100%',\n       height: '100%',\n       display: 'flex',\n       fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n-      paddingTop: '2rem'\n+      background: '#f8f0e6',\n+      overflow: 'hidden'\n     }}>\n-      {/* Left sidebar - Page tabs */}\n-      <div style={{\n-        width: 200,\n-        background: 'transparent',\n-        alignSelf: 'stretch',\n-        paddingTop: '1rem',\n-        borderRight: '1px solid #d0c4b0'\n-      }}>\n-        {pages.map(page => (\n-          <div\n-            key={page.id}\n-            onClick={() => setCurrentPage(page.id)}\n-            style={{\n-              padding: '0.75rem 1.5rem',\n-              cursor: 'pointer',\n-              background: currentPage === page.id ? 'rgba(44, 44, 44, 0.05)' : 'transparent',\n-              borderLeft: currentPage === page.id ? '3px solid #333' : '3px solid transparent',\n-              fontWeight: currentPage === page.id ? 600 : 400,\n-              color: currentPage === page.id ? '#333' : '#888',\n-              transition: 'all 0.2s',\n-              fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n-              fontSize: 14\n-            }}\n-            onMouseEnter={e => {\n-              if (currentPage !== page.id) {\n-                e.currentTarget.style.color = '#555';\n-                e.currentTarget.style.background = 'rgba(44, 44, 44, 0.03)';\n-              }\n-            }}\n-            onMouseLeave={e => {\n-              if (currentPage !== page.id) {\n-                e.currentTarget.style.color = '#888';\n-                e.currentTarget.style.background = 'transparent';\n-              }\n-            }}\n-          >\n-            {page.name}\n-          </div>\n-        ))}\n-      </div>\n-\n-      {/* Right content area */}\n-      <div style={{\n-        flex: 1,\n-        padding: '2rem',\n-        overflowY: 'auto',\n-        background: '#f8f0e6'\n-      }}>\n-        {currentPage === 0 && <StarredCommentsPage />}\n-        {currentPage === 1 && <DailyPicturesPage />}\n-      </div>\n+      <TimelinePage />\n     </div>\n   );\n }\n \n-// @@@ Starred Comments Page\n-function StarredCommentsPage() {\n+// @@@ Helper to get icon emoji\n+function getIconForVoice(icon: string): string {\n+  const iconMap: Record<string, string> = {\n+    brain: 'üß†',\n+    heart: '‚ù§Ô∏è',\n+    question: '‚ùì',\n+    cloud: '‚òÅÔ∏è',\n+    masks: 'üé≠',\n+    eye: 'üëÅÔ∏è',\n+    fist: '‚úä',\n+    lightbulb: 'üí°',\n+    shield: 'üõ°Ô∏è',\n+    wind: 'üí®',\n+    fire: 'üî•',\n+    compass: 'üß≠'\n+  };\n+  return iconMap[icon] || 'üí≠';\n+}\n+\n+// @@@ Helper to format dates consistently\n+function formatDate(date: Date | string): string {\n+  return new Date(date).toLocaleDateString('en-US', {\n+    year: 'numeric',\n+    month: 'short',\n+    day: 'numeric'\n+  });\n+}\n+\n+// @@@ Generate timeline days (7 past + today + 7 future)\n+function generateTimelineDays(): TimelineDay[] {\n+  const today = new Date();\n+  const todayStr = formatDate(today);\n+  const allTimelineDays: TimelineDay[] = [];\n+\n+  // Add past 7 days\n+  for (let i = 7; i >= 1; i--) {\n+    const pastDate = new Date(today);\n+    pastDate.setDate(today.getDate() - i);\n+    allTimelineDays.push({\n+      date: formatDate(pastDate),\n+      isPast: true,\n+      isFuture: false,\n+      isToday: false,\n+      daysOffset: -i\n+    });\n+  }\n+\n+  // Add today\n+  allTimelineDays.push({\n+    date: todayStr,\n+    isPast: false,\n+    isFuture: false,\n+    isToday: true,\n+    daysOffset: 0\n+  });\n+\n+  // Add future 7 days\n+  for (let i = 1; i <= 7; i++) {\n+    const futureDate = new Date(today);\n+    futureDate.setDate(today.getDate() + i);\n+    allTimelineDays.push({\n+      date: formatDate(futureDate),\n+      isPast: false,\n+      isFuture: true,\n+      isToday: false,\n+      daysOffset: i\n+    });\n+  }\n+\n+  return allTimelineDays;\n+}\n+\n+// @@@ Helper function for interesting placeholders\n+function getPlaceholderText(daysOffset: number): string {\n+  if (daysOffset === 0) return 'Click to generate';\n+\n+  const placeholders: Record<string, string> = {\n+    '-7': 'taste buds renew every 10 days',\n+    '-6': 'the liver regenerates in 6 weeks',\n+    '-5': 'stomach lining replaces itself every 5 days',\n+    '-4': 'skin cells shed every 2-4 weeks',\n+    '-3': 'red blood cells live for 120 days',\n+    '-2': 'the heart beats 100,000 times a day',\n+    '-1': 'neurons can form new connections',\n+    '1': 'tomorrow is unwritten',\n+    '2': 'the future is a blank page',\n+    '3': 'time flows forward',\n+    '4': 'days ahead unknown',\n+    '5': 'yet to unfold',\n+    '6': 'still becoming',\n+    '7': 'awaiting experience'\n+  };\n+\n+  return placeholders[daysOffset.toString()] || (daysOffset < 0 ? 'what was has passed' : 'yet to be written');\n+}\n+\n+// @@@ Get all notes from all sessions in localStorage\n+function getAllNotesFromSessions(): string {\n+  const allText: string[] = [];\n+  const keys = Object.keys(localStorage);\n+\n+  for (const key of keys) {\n+    if (key === 'ink_memory_state' || key.startsWith('ink_memory_state_')) {\n+      try {\n+        const state = JSON.parse(localStorage.getItem(key) || '{}');\n+        if (state.cells) {\n+          const text = state.cells\n+            .filter((c: any) => c.type === 'text')\n+            .map((c: any) => c.content)\n+            .join('\\n\\n');\n+          if (text.trim()) {\n+            allText.push(text);\n+          }\n+        }\n+      } catch (e) {\n+        console.error('Failed to parse session:', key, e);\n+      }\n+    }\n+  }\n+\n+  return allText.join('\\n\\n---\\n\\n');\n+}\n+\n+// @@@ Timeline page - combines pictures and starred comments by date\n+function TimelinePage() {\n   const [starredComments, setStarredComments] = useState<Commentor[]>([]);\n+  const [pictures, setPictures] = useState<Array<{ date: string; base64: string; prompt: string }>>([]);\n+  const [generatingForDate, setGeneratingForDate] = useState<string | null>(null);\n+  const [viewingImage, setViewingImage] = useState<{ base64: string; prompt: string; date: string } | null>(null);\n+  const [initialLoading, setInitialLoading] = useState(true);\n+  const scrollContainerRef = useRef<HTMLDivElement | null>(null);\n \n   useEffect(() => {\n-    // Load starred comments from localStorage\n+    // Load starred comments\n     const savedState = localStorage.getItem('ink_memory_state');\n     if (savedState) {\n       try {\n@@ -88,219 +169,584 @@ function StarredCommentsPage() {\n         console.error('Failed to load starred comments:', e);\n       }\n     }\n+\n+    // Load pictures\n+    const savedPictures = localStorage.getItem('daily-pictures');\n+    if (savedPictures) {\n+      try {\n+        setPictures(JSON.parse(savedPictures));\n+      } catch (e) {\n+        console.error('Failed to load pictures:', e);\n+      }\n+    }\n+\n+    setInitialLoading(false);\n   }, []);\n \n-  if (starredComments.length === 0) {\n-    return (\n-      <div style={{\n-        textAlign: 'center',\n-        padding: '4rem 2rem',\n-        color: '#999'\n-      }}>\n-        <div style={{ fontSize: '48px', marginBottom: '1rem' }}>‚≠ê</div>\n-        <div style={{ fontSize: '18px', marginBottom: '0.5rem' }}>No starred comments yet</div>\n-        <div style={{ fontSize: '14px' }}>Star comments in your writing to collect them here</div>\n-      </div>\n-    );\n+  // @@@ Group items by date\n+  const timelineByDate = new Map<string, { picture?: any; comments: Commentor[] }>();\n+\n+  starredComments.forEach(comment => {\n+    const date = formatDate(new Date(comment.appliedAt || comment.computedAt));\n+    if (!timelineByDate.has(date)) {\n+      timelineByDate.set(date, { comments: [] });\n+    }\n+    timelineByDate.get(date)!.comments.push(comment);\n+  });\n+\n+  pictures.forEach(pic => {\n+    const date = formatDate(pic.date);\n+    if (!timelineByDate.has(date)) {\n+      timelineByDate.set(date, { comments: [] });\n+    }\n+    timelineByDate.get(date)!.picture = pic;\n+  });\n+\n+  // @@@ Set initial scroll position to center on today's card\n+  useEffect(() => {\n+    // Double RAF to ensure layout is complete\n+    requestAnimationFrame(() => {\n+      requestAnimationFrame(() => {\n+        if (scrollContainerRef.current) {\n+          // Today is at index 7 (after 7 past days)\n+          // Each card is 500px + 4rem gap (64px) = 564px\n+          // Plus left padding of 4rem (64px)\n+          const cardWidth = 500 + 64;\n+          const todayIndex = 7;\n+          const leftPadding = 64;\n+          const containerWidth = scrollContainerRef.current.clientWidth;\n+\n+          // Center today's card\n+          const scrollLeft = leftPadding + (todayIndex * cardWidth) - (containerWidth / 2) + (250);\n+          scrollContainerRef.current.scrollLeft = scrollLeft;\n+        }\n+      });\n+    });\n+  }, []);\n+\n+  const handleGenerateForDate = async (dateStr: string) => {\n+    setGeneratingForDate(dateStr);\n+\n+    try {\n+      const allNotes = getAllNotesFromSessions();\n+      if (!allNotes.trim()) {\n+        alert('Write some notes first to generate an image!');\n+        return;\n+      }\n+\n+      const { generateDailyPicture } = await import('../api/voiceApi');\n+      const { image_base64, prompt } = await generateDailyPicture(allNotes);\n+\n+      const newPicture = {\n+        date: new Date().toISOString(),\n+        base64: image_base64,\n+        prompt: prompt\n+      };\n+\n+      // @@@ Overwrite existing picture for this date instead of adding new\n+      const normalizedNewDate = formatDate(newPicture.date);\n+\n+      const updated = pictures.filter(p => formatDate(p.date) !== normalizedNewDate);\n+\n+      updated.unshift(newPicture);\n+      setPictures(updated);\n+      localStorage.setItem('daily-pictures', JSON.stringify(updated));\n+    } catch (error) {\n+      console.error('Image generation failed:', error);\n+      alert('Failed to generate image. Please try again.');\n+    } finally {\n+      setGeneratingForDate(null);\n+    }\n+  };\n+\n+  if (initialLoading) {\n+    return null;\n   }\n \n+  // @@@ Generate all timeline days using helper function (always show timeline structure)\n+  const allTimelineDays = generateTimelineDays();\n+\n   return (\n-    <div style={{\n-      maxWidth: '800px',\n-      margin: '0 auto'\n-    }}>\n-      <h2 style={{\n-        fontSize: '24px',\n-        fontWeight: 600,\n-        color: '#333',\n-        marginBottom: '1.5rem',\n+    <div\n+      ref={scrollContainerRef}\n+      style={{\n+        width: '100%',\n+        height: '100%',\n+        background: '#f8f0e6',\n+        overflowX: 'auto',\n+        overflowY: 'hidden',\n         display: 'flex',\n-        alignItems: 'center',\n-        gap: '0.5rem'\n+        flexDirection: 'column',\n+        padding: '3rem 0'\n       }}>\n-        <span>‚≠ê</span>\n-        <span>Starred Comments</span>\n-        <span style={{ fontSize: '14px', fontWeight: 400, color: '#999' }}>\n-          ({starredComments.length})\n-        </span>\n-      </h2>\n-\n+      {/* @@@ Horizontal scrolling timeline - cards side by side */}\n       <div style={{\n         display: 'flex',\n-        flexDirection: 'column',\n-        gap: '1rem'\n+        flexDirection: 'row',\n+        gap: '4rem',\n+        padding: '0 4rem',\n+        minHeight: 0,\n+        flex: 1\n       }}>\n-        {starredComments.map((comment) => (\n-          <div\n-            key={comment.id}\n-            style={{\n-              background: '#fff',\n-              border: '1px solid #d0c4b0',\n-              borderRadius: '8px',\n-              padding: '1.5rem',\n-              boxShadow: '0 2px 4px rgba(0,0,0,0.05)',\n-              transition: 'all 0.2s'\n-            }}\n-            onMouseEnter={e => {\n-              e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';\n-            }}\n-            onMouseLeave={e => {\n-              e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';\n-            }}\n-          >\n-            {/* Header */}\n-            <div style={{\n-              display: 'flex',\n-              alignItems: 'center',\n-              gap: '0.75rem',\n-              marginBottom: '0.75rem',\n-              paddingBottom: '0.75rem',\n-              borderBottom: '1px solid #f0f0f0'\n-            }}>\n+        {allTimelineDays.map((day, index) => {\n+          const dayData = timelineByDate.get(day.date);\n+          const hasData = !!dayData;\n+          const isGenerating = generatingForDate === day.date;\n+\n+          return (\n+            <div\n+              key={day.date}\n+              style={{\n+                display: 'flex',\n+                flexDirection: 'column',\n+                minWidth: '500px',\n+                maxWidth: '500px',\n+                position: 'relative'\n+              }}>\n+              {/* Timeline node and line */}\n               <div style={{\n-                fontSize: '20px'\n+                display: 'flex',\n+                alignItems: 'center',\n+                marginBottom: '2rem',\n+                position: 'relative'\n               }}>\n-                {getIconForVoice(comment.icon)}\n+                {/* Line before node */}\n+                {index > 0 && (\n+                  <div style={{\n+                    position: 'absolute',\n+                    right: 'calc(50% + 12px)',\n+                    width: 'calc(4rem + 50%)',\n+                    height: '3px',\n+                    background: '#d0c4b0'\n+                  }} />\n+                )}\n+\n+                {/* Timeline node */}\n+                <div style={{\n+                  width: '24px',\n+                  height: '24px',\n+                  borderRadius: '50%',\n+                  background: hasData ? '#4CAF50' : (day.isToday ? '#888' : '#ddd'),\n+                  border: '3px solid #f8f0e6',\n+                  boxShadow: '0 2px 8px rgba(0,0,0,0.15)',\n+                  margin: '0 auto',\n+                  position: 'relative',\n+                  zIndex: 2\n+                }} />\n+\n+                {/* Line after node */}\n+                {index < allTimelineDays.length - 1 && (\n+                  <div style={{\n+                    position: 'absolute',\n+                    left: 'calc(50% + 12px)',\n+                    width: 'calc(4rem + 50%)',\n+                    height: '3px',\n+                    background: '#d0c4b0'\n+                  }} />\n+                )}\n               </div>\n+\n+              {/* Date header */}\n               <div style={{\n-                flex: 1,\n                 fontSize: '16px',\n                 fontWeight: 600,\n-                color: '#333'\n+                color: day.isToday ? '#2c2c2c' : '#666',\n+                textAlign: 'center',\n+                marginBottom: '1.5rem'\n               }}>\n-                {comment.voice}\n+                {day.isToday ? 'Today' : day.date}\n               </div>\n+\n+              {/* Card content */}\n               <div style={{\n-                fontSize: '12px',\n-                color: '#999'\n+                display: 'flex',\n+                flexDirection: 'column',\n+                gap: '1rem',\n+                flex: 1\n               }}>\n-                {new Date(comment.appliedAt || comment.computedAt).toLocaleDateString()}\n+                {/* Image */}\n+                <div style={{ flexShrink: 0 }}>\n+                  {dayData?.picture ? (\n+                    <div style={{\n+                      position: 'relative',\n+                      background: '#fff',\n+                      border: '1px solid #d0c4b0',\n+                      borderRadius: '8px',\n+                      overflow: 'hidden',\n+                      cursor: 'pointer',\n+                      transition: 'all 0.2s'\n+                    }}\n+                    onClick={() => setViewingImage(dayData.picture)}\n+                    onMouseEnter={e => {\n+                      e.currentTarget.style.transform = 'scale(1.02)';\n+                      e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';\n+                    }}\n+                    onMouseLeave={e => {\n+                      e.currentTarget.style.transform = 'scale(1)';\n+                      e.currentTarget.style.boxShadow = 'none';\n+                    }}\n+                    >\n+                      <img\n+                        src={`data:image/png;base64,${dayData.picture.base64}`}\n+                        alt={dayData.picture.prompt}\n+                        style={{\n+                          width: '100%',\n+                          aspectRatio: '1',\n+                          objectFit: 'cover'\n+                        }}\n+                      />\n+                      <button\n+                        onClick={(e) => {\n+                          e.stopPropagation();\n+                          if (!isGenerating) handleGenerateForDate(day.date);\n+                        }}\n+                        disabled={isGenerating}\n+                        style={{\n+                          position: 'absolute',\n+                          top: '0.75rem',\n+                          right: '0.75rem',\n+                          width: '32px',\n+                          height: '32px',\n+                          borderRadius: '50%',\n+                          background: 'rgba(255, 255, 255, 0.95)',\n+                          border: 'none',\n+                          cursor: isGenerating ? 'wait' : 'pointer',\n+                          display: 'flex',\n+                          alignItems: 'center',\n+                          justifyContent: 'center',\n+                          opacity: 0.9,\n+                          transition: 'all 0.2s'\n+                        }}\n+                        onMouseEnter={e => {\n+                          if (!isGenerating) e.currentTarget.style.opacity = '1';\n+                        }}\n+                        onMouseLeave={e => {\n+                          e.currentTarget.style.opacity = '0.9';\n+                        }}\n+                        title=\"Redraw image\"\n+                      >\n+                        <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n+                          <path d=\"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2\"/>\n+                        </svg>\n+                      </button>\n+                    </div>\n+                  ) : (\n+                    <div\n+                      onClick={() => day.isToday && !isGenerating && handleGenerateForDate(day.date)}\n+                      style={{\n+                        width: '100%',\n+                        aspectRatio: '1',\n+                        background: day.isFuture ? 'linear-gradient(135deg, #f8f0e6 0%, #ede3d5 100%)' : 'linear-gradient(135deg, #f0e8de 0%, #e5dbc9 100%)',\n+                        border: day.isFuture ? '2px dashed #d0c4b0' : '2px dashed #b8a896',\n+                        borderRadius: '8px',\n+                        display: 'flex',\n+                        flexDirection: 'column',\n+                        alignItems: 'center',\n+                        justifyContent: 'center',\n+                        cursor: day.isToday ? (isGenerating ? 'wait' : 'pointer') : 'default',\n+                        gap: '0.75rem',\n+                        opacity: day.isPast || day.isFuture ? 0.4 : 1,\n+                        transition: 'all 0.2s'\n+                      }}\n+                      onMouseEnter={e => {\n+                        if (day.isToday && !isGenerating) {\n+                          e.currentTarget.style.opacity = '1';\n+                        }\n+                      }}\n+                      onMouseLeave={e => {\n+                        if (day.isToday && !isGenerating) {\n+                          e.currentTarget.style.opacity = '1';\n+                        } else if (day.isPast) {\n+                          e.currentTarget.style.opacity = '0.4';\n+                        }\n+                      }}\n+                    >\n+                      <div style={{\n+                        fontSize: '15px',\n+                        color: '#999',\n+                        fontWeight: 500,\n+                        fontStyle: 'italic',\n+                        textAlign: 'center',\n+                        lineHeight: '1.8',\n+                        padding: '0 3rem'\n+                      }}>\n+                        {isGenerating ? 'Generating...' : getPlaceholderText(day.daysOffset)}\n+                      </div>\n+                    </div>\n+                  )}\n+                </div>\n+\n+                {/* Simple metadata */}\n+                {(dayData?.comments && dayData.comments.length > 0) && (\n+                  <div style={{\n+                    textAlign: 'center',\n+                    padding: '1rem',\n+                    background: 'rgba(255, 255, 255, 0.5)',\n+                    borderRadius: '6px',\n+                    fontSize: '13px',\n+                    color: '#888',\n+                    fontStyle: 'italic'\n+                  }}>\n+                    {dayData.comments.length} {dayData.comments.length === 1 ? 'entry' : 'entries'}\n+                  </div>\n+                )}\n               </div>\n             </div>\n+          );\n+        })}\n+      </div>\n \n-            {/* Phrase */}\n+      {/* Image Lightbox Modal */}\n+      {viewingImage && (\n+        <div\n+          style={{\n+            position: 'fixed',\n+            top: 0,\n+            left: 0,\n+            right: 0,\n+            bottom: 0,\n+            background: 'rgba(0, 0, 0, 0.6)',\n+            display: 'flex',\n+            alignItems: 'center',\n+            justifyContent: 'center',\n+            zIndex: 9999,\n+            padding: '3rem'\n+          }}\n+          onClick={() => setViewingImage(null)}\n+        >\n+          <div\n+            style={{\n+              display: 'flex',\n+              flexDirection: 'column',\n+              maxWidth: '1400px',\n+              width: '100%',\n+              maxHeight: '90vh',\n+              background: '#fff',\n+              borderRadius: '12px',\n+              overflow: 'hidden',\n+              boxShadow: '0 8px 32px rgba(0,0,0,0.4)',\n+              marginTop: '2rem'\n+            }}\n+            onClick={(e) => e.stopPropagation()}\n+          >\n+            {/* Main content: Image + Comments */}\n             <div style={{\n-              padding: '0.75rem',\n-              background: '#f8f0e6',\n-              borderLeft: '3px solid #d0c4b0',\n-              marginBottom: '0.75rem',\n-              fontSize: '14px',\n-              fontStyle: 'italic',\n-              color: '#666'\n+              display: 'flex',\n+              flex: 1,\n+              minHeight: 0,\n+              overflow: 'hidden'\n             }}>\n-              \"{comment.phrase}\"\n+              {/* Image on left */}\n+              <div style={{\n+                flex: '0 0 55%',\n+                display: 'flex',\n+                alignItems: 'center',\n+                justifyContent: 'center',\n+                background: '#000',\n+                position: 'relative'\n+              }}>\n+                <img\n+                  src={`data:image/png;base64,${viewingImage.base64}`}\n+                  alt=\"Generated image\"\n+                  style={{\n+                    maxWidth: '100%',\n+                    maxHeight: '100%',\n+                    objectFit: 'contain'\n+                  }}\n+                />\n+                {/* Close button */}\n+                <button\n+                  onClick={() => setViewingImage(null)}\n+                  style={{\n+                    position: 'absolute',\n+                    top: '1.5rem',\n+                    right: '1.5rem',\n+                    background: 'rgba(255, 255, 255, 0.95)',\n+                    border: 'none',\n+                    borderRadius: '50%',\n+                    width: '36px',\n+                    height: '36px',\n+                    cursor: 'pointer',\n+                    display: 'flex',\n+                    alignItems: 'center',\n+                    justifyContent: 'center',\n+                    fontSize: '22px',\n+                    color: '#333',\n+                    fontWeight: 'bold',\n+                    transition: 'all 0.2s',\n+                    boxShadow: '0 2px 8px rgba(0,0,0,0.2)'\n+                  }}\n+                  onMouseEnter={e => {\n+                    e.currentTarget.style.background = '#f0f0f0';\n+                    e.currentTarget.style.transform = 'scale(1.1)';\n+                  }}\n+                  onMouseLeave={e => {\n+                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.95)';\n+                    e.currentTarget.style.transform = 'scale(1)';\n+                  }}\n+                >\n+                  √ó\n+                </button>\n+              </div>\n+\n+              {/* Starred comments on right */}\n+              <div style={{\n+                flex: '0 0 45%',\n+                background: '#f9f7f4',\n+                display: 'flex',\n+                flexDirection: 'column',\n+                overflow: 'hidden',\n+                minWidth: 0\n+              }}>\n+                {/* Header */}\n+                <div style={{\n+                  padding: '2rem 2rem 1rem',\n+                  borderBottom: '1px solid #e0d8cc',\n+                  flexShrink: 0\n+                }}>\n+                  <div style={{\n+                    fontSize: '13px',\n+                    color: '#aaa',\n+                    fontWeight: 600,\n+                    textTransform: 'uppercase',\n+                    letterSpacing: '0.1em'\n+                  }}>\n+                    Starred Comments\n+                  </div>\n+                </div>\n+\n+                {/* Comments list - scrollable */}\n+                <div style={{\n+                  flex: 1,\n+                  overflowY: 'auto',\n+                  overflowX: 'hidden',\n+                  padding: '1.5rem 2rem',\n+                  minWidth: 0,\n+                  width: '100%',\n+                  boxSizing: 'border-box'\n+                }}>\n+                  {(() => {\n+                    const dateData = Array.from(timelineByDate.entries()).find(([_, data]) =>\n+                      data.picture?.base64 === viewingImage.base64\n+                    );\n+                    const comments = dateData?.[1]?.comments || [];\n+\n+                    if (comments.length === 0) {\n+                      return (\n+                        <div style={{\n+                          textAlign: 'center',\n+                          color: '#999',\n+                          fontSize: '14px',\n+                          fontStyle: 'italic',\n+                          padding: '2rem 1rem'\n+                        }}>\n+                          No starred comments for this day\n+                        </div>\n+                      );\n+                    }\n+\n+                    return (\n+                      <div style={{\n+                        display: 'flex',\n+                        flexDirection: 'column',\n+                        gap: '1rem',\n+                        minWidth: 0\n+                      }}>\n+                        {comments.map((comment) => (\n+                          <div\n+                            key={comment.id}\n+                            style={{\n+                              background: '#fff',\n+                              border: '1px solid #e0d8cc',\n+                              borderRadius: '8px',\n+                              padding: '1rem',\n+                              transition: 'all 0.2s',\n+                              minWidth: 0\n+                            }}\n+                          >\n+                            <div style={{\n+                              display: 'flex',\n+                              alignItems: 'center',\n+                              gap: '0.5rem',\n+                              marginBottom: '0.75rem',\n+                              minWidth: 0\n+                            }}>\n+                              <span style={{ fontSize: '18px', flexShrink: 0 }}>{getIconForVoice(comment.icon)}</span>\n+                              <span style={{ fontWeight: 600, fontSize: '14px', color: '#333', flexShrink: 0 }}>{comment.voice}</span>\n+                              <span style={{ fontSize: '14px', marginLeft: 'auto', flexShrink: 0 }}>‚≠ê</span>\n+                            </div>\n+                            <div style={{\n+                              fontSize: '12px',\n+                              fontStyle: 'italic',\n+                              color: '#999',\n+                              marginBottom: '0.75rem',\n+                              paddingLeft: '1.5rem',\n+                              borderLeft: '2px solid #e0d8cc',\n+                              wordBreak: 'break-word',\n+                              overflowWrap: 'anywhere',\n+                              minWidth: 0\n+                            }}>\n+                              \"{comment.phrase}\"\n+                            </div>\n+                            <div style={{\n+                              fontSize: '13px',\n+                              color: '#555',\n+                              lineHeight: '1.7',\n+                              paddingLeft: '0.5rem',\n+                              wordBreak: 'break-word',\n+                              overflowWrap: 'anywhere',\n+                              whiteSpace: 'pre-wrap',\n+                              minWidth: 0\n+                            }}>\n+                              {comment.comment}\n+                            </div>\n+                          </div>\n+                        ))}\n+                      </div>\n+                    );\n+                  })()}\n+                </div>\n+              </div>\n             </div>\n \n-            {/* Comment */}\n+            {/* Bottom metadata bar */}\n             <div style={{\n-              fontSize: '15px',\n-              lineHeight: '1.6',\n-              color: '#333'\n+              borderTop: '1px solid #e0d8cc',\n+              background: '#f0e8de',\n+              padding: '1rem 2rem',\n+              display: 'flex',\n+              alignItems: 'center',\n+              justifyContent: 'space-between',\n+              flexShrink: 0\n             }}>\n-              {comment.comment}\n-            </div>\n-\n-            {/* Chat history preview if exists */}\n-            {comment.chatHistory && comment.chatHistory.length > 1 && (\n               <div style={{\n-                marginTop: '0.75rem',\n-                paddingTop: '0.75rem',\n-                borderTop: '1px solid #f0f0f0',\n                 fontSize: '13px',\n-                color: '#999'\n+                color: '#666'\n               }}>\n-                üí¨ {comment.chatHistory.length - 1} conversation{comment.chatHistory.length - 1 === 1 ? '' : 's'}\n+                {new Date(viewingImage.date).toLocaleDateString('en-US', {\n+                  year: 'numeric',\n+                  month: 'long',\n+                  day: 'numeric'\n+                })}\n               </div>\n-            )}\n-          </div>\n-        ))}\n-      </div>\n-    </div>\n-  );\n-}\n-\n-// @@@ Daily Pictures Page (Placeholder)\n-function DailyPicturesPage() {\n-  return (\n-    <div style={{\n-      maxWidth: '1000px',\n-      margin: '0 auto'\n-    }}>\n-      <h2 style={{\n-        fontSize: '24px',\n-        fontWeight: 600,\n-        color: '#333',\n-        marginBottom: '1.5rem',\n-        display: 'flex',\n-        alignItems: 'center',\n-        gap: '0.5rem'\n-      }}>\n-        <span>üì∑</span>\n-        <span>Daily Pictures</span>\n-      </h2>\n-\n-      {/* Placeholder gallery grid */}\n-      <div style={{\n-        display: 'grid',\n-        gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',\n-        gap: '1rem'\n-      }}>\n-        {[1, 2, 3, 4, 5, 6].map(i => (\n-          <div\n-            key={i}\n-            style={{\n-              aspectRatio: '1',\n-              background: 'linear-gradient(135deg, #f8f0e6 0%, #e8e0d6 100%)',\n-              borderRadius: '8px',\n-              display: 'flex',\n-              alignItems: 'center',\n-              justifyContent: 'center',\n-              border: '2px dashed #d0c4b0',\n-              fontSize: '48px',\n-              cursor: 'pointer',\n-              transition: 'all 0.2s'\n-            }}\n-            onMouseEnter={e => {\n-              e.currentTarget.style.transform = 'scale(1.05)';\n-              e.currentTarget.style.borderStyle = 'solid';\n-            }}\n-            onMouseLeave={e => {\n-              e.currentTarget.style.transform = 'scale(1)';\n-              e.currentTarget.style.borderStyle = 'dashed';\n-            }}\n-          >\n-            üì∑\n+              <div style={{\n+                fontSize: '13px',\n+                color: '#888'\n+              }}>\n+                {(() => {\n+                  const dateData = Array.from(timelineByDate.entries()).find(([_, data]) =>\n+                    data.picture?.base64 === viewingImage.base64\n+                  );\n+                  const commentCount = dateData?.[1]?.comments?.length || 0;\n+                  return `${commentCount} ${commentCount === 1 ? 'entry' : 'entries'}`;\n+                })()}\n+              </div>\n+            </div>\n           </div>\n-        ))}\n-      </div>\n-\n-      <div style={{\n-        textAlign: 'center',\n-        padding: '3rem 2rem',\n-        color: '#999',\n-        fontSize: '14px'\n-      }}>\n-        This feature will allow you to save daily snapshots and memories\n-      </div>\n+        </div>\n+      )}\n     </div>\n   );\n }\n \n-// @@@ Helper to get icon emoji\n-function getIconForVoice(icon: string): string {\n-  const iconMap: Record<string, string> = {\n-    brain: 'üß†',\n-    heart: '‚ù§Ô∏è',\n-    question: '‚ùì',\n-    cloud: '‚òÅÔ∏è',\n-    masks: 'üé≠',\n-    eye: 'üëÅÔ∏è',\n-    fist: '‚úä',\n-    lightbulb: 'üí°',\n-    shield: 'üõ°Ô∏è',\n-    wind: 'üí®',\n-    fire: 'üî•',\n-    compass: 'üß≠'\n-  };\n-  return iconMap[icon] || 'üí≠';\n-}\n+// @@@ Analysis Page (placeholder for echoes/traits/patterns)"
    },
    {
      "sha": "469a2f5c55c62fdd26a292bab37e39a168b505ed",
      "filename": "frontend/src/components/LeftSidebar.tsx",
      "status": "modified",
      "additions": 10,
      "deletions": 10,
      "changes": 20,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fcomponents%2FLeftSidebar.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fcomponents%2FLeftSidebar.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FLeftSidebar.tsx?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -1,6 +1,6 @@\n interface Props {\n-  currentView: 'writing' | 'settings' | 'collections' | 'analysis' | 'about';\n-  onViewChange: (view: 'writing' | 'settings' | 'collections' | 'analysis' | 'about') => void;\n+  currentView: 'writing' | 'settings' | 'timeline' | 'analysis' | 'about';\n+  onViewChange: (view: 'writing' | 'settings' | 'timeline' | 'analysis' | 'about') => void;\n }\n \n export default function LeftSidebar({ currentView, onViewChange }: Props) {\n@@ -93,27 +93,27 @@ export default function LeftSidebar({ currentView, onViewChange }: Props) {\n         </button>\n \n         <button\n-          onClick={() => onViewChange('collections')}\n-          style={buttonStyle(currentView === 'collections')}\n-          title=\"Collections\"\n+          onClick={() => onViewChange('timeline')}\n+          style={buttonStyle(currentView === 'timeline')}\n+          title=\"Timeline\"\n           onMouseEnter={e => {\n-            if (currentView !== 'collections') {\n+            if (currentView !== 'timeline') {\n               e.currentTarget.style.background = 'rgba(44, 44, 44, 0.04)';\n             }\n           }}\n           onMouseLeave={e => {\n-            if (currentView !== 'collections') {\n+            if (currentView !== 'timeline') {\n               e.currentTarget.style.background = 'transparent';\n             }\n           }}\n         >\n-          Collections\n+          Timeline\n         </button>\n \n         <button\n           onClick={() => onViewChange('analysis')}\n           style={buttonStyle(currentView === 'analysis')}\n-          title=\"Analysis\"\n+          title=\"Reflections\"\n           onMouseEnter={e => {\n             if (currentView !== 'analysis') {\n               e.currentTarget.style.background = 'rgba(44, 44, 44, 0.04)';\n@@ -125,7 +125,7 @@ export default function LeftSidebar({ currentView, onViewChange }: Props) {\n             }\n           }}\n         >\n-          Analysis\n+          Reflections\n         </button>\n \n         <button"
    },
    {
      "sha": "4b058ffde810cbe1183edb0fba70dfd5f94ae786",
      "filename": "frontend/src/components/VoiceSettings.tsx",
      "status": "modified",
      "additions": 685,
      "deletions": 268,
      "changes": 953,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fcomponents%2FVoiceSettings.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fcomponents%2FVoiceSettings.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FVoiceSettings.tsx?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -1,6 +1,10 @@\n import { useState, useEffect, useRef } from 'react';\n import type { VoiceConfig, StateConfig, UserState } from '../types/voice';\n import { getVoices, saveVoices, clearVoices, getMetaPrompt, saveMetaPrompt, getStateConfig, saveStateConfig } from '../utils/voiceStorage';\n+import {\n+  FaBrain, FaHeart, FaQuestion, FaCloud, FaTheaterMasks, FaEye,\n+  FaFistRaised, FaLightbulb, FaShieldAlt, FaWind, FaFire, FaCompass\n+} from 'react-icons/fa';\n \n // @@@ Display mappings (text name ‚Üí visual)\n const COLORS = {\n@@ -11,10 +15,36 @@ const COLORS = {\n   'yellow': { hex: '#f39c12', label: 'Yellow' }\n };\n \n-const ICONS = {\n-  'brain': 'üß†', 'lightbulb': 'üí°', 'masks': 'üé≠', 'cloud': '‚òÅÔ∏è',\n-  'shield': 'üõ°Ô∏è', 'compass': 'üß≠', 'heart': '‚ù§Ô∏è', 'fist': '‚úä',\n-  'fire': 'üî•', 'wind': 'üí®', 'question': '‚ùì', 'eye': 'üëÅÔ∏è'\n+// @@@ Icon map with React Icons (matching App.tsx)\n+const iconMap = {\n+  brain: FaBrain,\n+  heart: FaHeart,\n+  question: FaQuestion,\n+  cloud: FaCloud,\n+  masks: FaTheaterMasks,\n+  eye: FaEye,\n+  fist: FaFistRaised,\n+  lightbulb: FaLightbulb,\n+  shield: FaShieldAlt,\n+  wind: FaWind,\n+  fire: FaFire,\n+  compass: FaCompass,\n+};\n+\n+// @@@ Icon labels for dropdown display (emoji for visual reference)\n+const ICON_LABELS = {\n+  'brain': 'üß† brain',\n+  'lightbulb': 'üí° lightbulb',\n+  'masks': 'üé≠ masks',\n+  'cloud': '‚òÅÔ∏è cloud',\n+  'shield': 'üõ°Ô∏è shield',\n+  'compass': 'üß≠ compass',\n+  'heart': '‚ù§Ô∏è heart',\n+  'fist': '‚úä fist',\n+  'fire': 'üî• fire',\n+  'wind': 'üí® wind',\n+  'question': '‚ùì question',\n+  'eye': 'üëÅÔ∏è eye'\n };\n \n interface Props {\n@@ -172,310 +202,697 @@ export default function VoiceSettings({ defaultVoices, onSave }: Props) {\n     });\n   };\n \n+  const [activeTab, setActiveTab] = useState<'voices' | 'meta' | 'states'>('voices');\n+\n   return (\n     <div style={{ flex: 1, display: 'flex', flexDirection: 'column', background: '#f8f0e6', overflow: 'hidden' }}>\n-      {/* Fixed Header - Function Bar */}\n+      {/* Fixed Header */}\n       <div style={{\n-        padding: '16px 24px',\n-        background: '#fff',\n-        borderBottom: '2px solid #d0c4b0',\n-        boxShadow: '0 2px 4px rgba(0,0,0,0.05)',\n+        padding: '24px 32px 0',\n+        background: '#f8f0e6',\n         flexShrink: 0\n       }}>\n-        <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\n-          <button onClick={handleAdd} style={{ padding: '8px 16px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer', fontSize: 13 }}>+ Add Voice</button>\n-          <button onClick={handleImport} style={{ padding: '8px 16px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer', fontSize: 13 }}>Import</button>\n-          <button onClick={handleExport} style={{ padding: '8px 16px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer', fontSize: 13 }}>Export</button>\n-          <button onClick={handleDefault} style={{ padding: '8px 16px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer', fontSize: 13 }}>Use Default</button>\n-          <div style={{ flex: 1 }} />\n-          <button\n-            onClick={handleSave}\n-            style={{\n-              padding: '8px 20px',\n-              border: saveStatus === 'saved' ? '1px solid #27ae60' : '1px solid #666',\n-              background: saveStatus === 'saved' ? '#27ae60' : '#333',\n-              color: '#fff',\n-              borderRadius: 4,\n-              cursor: 'pointer',\n-              fontWeight: 'bold',\n-              fontSize: 13,\n-              transition: 'all 0.3s'\n-            }}\n-          >\n-            {saveStatus === 'saved' ? '‚úì Saved!' : 'Save'}\n-          </button>\n-        </div>\n-      </div>\n-\n-      {/* Scrollable Content Area */}\n-      <div ref={scrollContainerRef} style={{ flex: 1, overflowY: 'auto', padding: '24px', background: '#f8f0e6' }}>\n-        {/* Meta Prompt Section */}\n-        <div style={{\n-          marginBottom: 24,\n-          padding: 20,\n-          background: '#fffef9',\n-          border: '1px solid #d0c4b0',\n-          borderRadius: 6,\n-          boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n-        }}>\n-          <h3 style={{\n-            margin: '0 0 12px 0',\n-            fontSize: 15,\n-            fontWeight: 600,\n-            color: '#333',\n-            letterSpacing: '-0.01em'\n+        {/* Title */}\n+        <div style={{ marginBottom: 20 }}>\n+          <h1 style={{\n+            margin: 0,\n+            fontSize: 28,\n+            fontWeight: 700,\n+            color: '#2c2c2c',\n+            fontFamily: 'Georgia, serif',\n+            letterSpacing: '-0.5px'\n           }}>\n-            Meta Prompt\n-          </h3>\n+            The Voice Council\n+          </h1>\n           <p style={{\n-            margin: '0 0 12px 0',\n-            fontSize: 12,\n+            margin: '6px 0 0',\n+            fontSize: 14,\n             color: '#666',\n-            lineHeight: 1.5\n+            fontStyle: 'italic'\n           }}>\n-            Global instructions applied to all voice personas (affects both comments and chat)\n+            Configure your inner voices, the ones that comment on everything you write\n           </p>\n-          <textarea\n-            value={metaPrompt}\n-            onChange={e => setMetaPrompt(e.target.value)}\n-            placeholder=\"e.g., Be honest and pragmatic. Prioritize mental well-being over theatrical commentary...\"\n-            style={{\n-              width: '100%',\n-              minHeight: 100,\n-              padding: 12,\n-              fontSize: 13,\n-              fontFamily: 'monospace',\n-              border: '1px solid #d0c4b0',\n-              borderRadius: 4,\n-              background: '#fff',\n-              resize: 'vertical',\n-              boxSizing: 'border-box',\n-              lineHeight: 1.6\n-            }}\n-          />\n         </div>\n \n-        {/* User States Section */}\n+        {/* Tabs */}\n         <div style={{\n-          marginBottom: 24,\n-          padding: 20,\n-          background: '#fffef9',\n-          border: '1px solid #d0c4b0',\n-          borderRadius: 6,\n-          boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n+          display: 'flex',\n+          gap: 8,\n+          borderBottom: '2px solid #d0c4b0'\n         }}>\n-          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n-            <h3 style={{\n-              margin: 0,\n-              fontSize: 15,\n-              fontWeight: 600,\n-              color: '#333',\n-              letterSpacing: '-0.01em'\n-            }}>\n-              User States\n-            </h3>\n+          {['voices', 'meta', 'states'].map((tab) => (\n             <button\n-              onClick={handleAddState}\n+              key={tab}\n+              onClick={() => setActiveTab(tab as any)}\n               style={{\n-                padding: '4px 12px',\n-                fontSize: 12,\n-                border: '1px solid #d0c4b0',\n-                background: '#fff',\n-                borderRadius: 4,\n-                cursor: 'pointer'\n+                padding: '12px 24px',\n+                border: 'none',\n+                background: activeTab === tab ? '#fff' : 'transparent',\n+                borderRadius: '8px 8px 0 0',\n+                cursor: 'pointer',\n+                fontSize: 14,\n+                fontWeight: activeTab === tab ? 600 : 400,\n+                color: activeTab === tab ? '#2c2c2c' : '#888',\n+                transition: 'all 0.2s',\n+                borderBottom: activeTab === tab ? '2px solid #2c2c2c' : 'none',\n+                marginBottom: '-2px'\n+              }}\n+              onMouseEnter={(e) => {\n+                if (activeTab !== tab) {\n+                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.5)';\n+                }\n+              }}\n+              onMouseLeave={(e) => {\n+                if (activeTab !== tab) {\n+                  e.currentTarget.style.background = 'transparent';\n+                }\n               }}\n             >\n-              + Add State\n+              {tab === 'voices' && 'üé≠ Voices'}\n+              {tab === 'meta' && 'üìú Meta Prompt'}\n+              {tab === 'states' && 'üí≠ User States'}\n             </button>\n-          </div>\n-          <p style={{\n-            margin: '0 0 16px 0',\n-            fontSize: 12,\n-            color: '#666',\n-            lineHeight: 1.5\n-          }}>\n-            Configure states shown at startup, each with a specific prompt context\n-          </p>\n+          ))}\n \n-          {/* Greeting */}\n-          <div style={{ marginBottom: 16 }}>\n-            <label style={{\n-              display: 'block',\n-              fontSize: 12,\n-              fontWeight: 600,\n-              color: '#333',\n-              marginBottom: 6\n-            }}>\n-              Greeting Message\n-            </label>\n-            <input\n-              type=\"text\"\n-              value={stateConfig.greeting}\n-              onChange={e => setStateConfig({ ...stateConfig, greeting: e.target.value })}\n-              placeholder=\"e.g., How are you feeling today?\"\n-              style={{\n-                width: '100%',\n-                padding: 8,\n-                fontSize: 13,\n+          {/* Action buttons on the right */}\n+          <div style={{ flex: 1 }} />\n+          <div style={{ display: 'flex', gap: 8, alignItems: 'flex-end', paddingBottom: 8 }}>\n+            {activeTab === 'voices' && (\n+              <>\n+                <button onClick={handleAdd} style={{\n+                  padding: '6px 14px',\n+                  border: '1px solid #d0c4b0',\n+                  background: '#fff',\n+                  borderRadius: 6,\n+                  cursor: 'pointer',\n+                  fontSize: 12,\n+                  fontWeight: 500,\n+                  transition: 'all 0.2s',\n+                  boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n+                }}\n+                onMouseEnter={(e) => {\n+                  e.currentTarget.style.transform = 'translateY(-1px)';\n+                  e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.12)';\n+                }}\n+                onMouseLeave={(e) => {\n+                  e.currentTarget.style.transform = 'translateY(0)';\n+                  e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';\n+                }}\n+                >+ Add Voice</button>\n+                <button onClick={handleImport} style={{\n+                  padding: '6px 14px',\n+                  border: '1px solid #d0c4b0',\n+                  background: '#fff',\n+                  borderRadius: 6,\n+                  cursor: 'pointer',\n+                  fontSize: 12,\n+                  transition: 'all 0.2s',\n+                  boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n+                }}\n+                onMouseEnter={(e) => {\n+                  e.currentTarget.style.transform = 'translateY(-1px)';\n+                  e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.12)';\n+                }}\n+                onMouseLeave={(e) => {\n+                  e.currentTarget.style.transform = 'translateY(0)';\n+                  e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';\n+                }}\n+                >Import</button>\n+                <button onClick={handleExport} style={{\n+                  padding: '6px 14px',\n+                  border: '1px solid #d0c4b0',\n+                  background: '#fff',\n+                  borderRadius: 6,\n+                  cursor: 'pointer',\n+                  fontSize: 12,\n+                  transition: 'all 0.2s',\n+                  boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n+                }}\n+                onMouseEnter={(e) => {\n+                  e.currentTarget.style.transform = 'translateY(-1px)';\n+                  e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.12)';\n+                }}\n+                onMouseLeave={(e) => {\n+                  e.currentTarget.style.transform = 'translateY(0)';\n+                  e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';\n+                }}\n+                >Export</button>\n+                <button onClick={handleDefault} style={{\n+                  padding: '6px 14px',\n+                  border: '1px solid #d0c4b0',\n+                  background: '#fff',\n+                  borderRadius: 6,\n+                  cursor: 'pointer',\n+                  fontSize: 12,\n+                  transition: 'all 0.2s',\n+                  boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n+                }}\n+                onMouseEnter={(e) => {\n+                  e.currentTarget.style.transform = 'translateY(-1px)';\n+                  e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.12)';\n+                }}\n+                onMouseLeave={(e) => {\n+                  e.currentTarget.style.transform = 'translateY(0)';\n+                  e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';\n+                }}\n+                >Reset to Default</button>\n+              </>\n+            )}\n+            {activeTab === 'states' && (\n+              <button onClick={handleAddState} style={{\n+                padding: '6px 14px',\n                 border: '1px solid #d0c4b0',\n-                borderRadius: 4,\n                 background: '#fff',\n-                boxSizing: 'border-box'\n+                borderRadius: 6,\n+                cursor: 'pointer',\n+                fontSize: 12,\n+                fontWeight: 500,\n+                transition: 'all 0.2s',\n+                boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n+              }}\n+              onMouseEnter={(e) => {\n+                e.currentTarget.style.transform = 'translateY(-1px)';\n+                e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.12)';\n+              }}\n+              onMouseLeave={(e) => {\n+                e.currentTarget.style.transform = 'translateY(0)';\n+                e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';\n+              }}\n+              >+ Add State</button>\n+            )}\n+            <button\n+              onClick={handleSave}\n+              style={{\n+                padding: '6px 18px',\n+                border: 'none',\n+                background: saveStatus === 'saved' ? '#27ae60' : '#2c2c2c',\n+                color: '#fff',\n+                borderRadius: 6,\n+                cursor: 'pointer',\n+                fontWeight: 600,\n+                fontSize: 12,\n+                transition: 'all 0.3s',\n+                boxShadow: '0 2px 6px rgba(0,0,0,0.15)'\n+              }}\n+              onMouseEnter={(e) => {\n+                if (saveStatus !== 'saved') {\n+                  e.currentTarget.style.transform = 'translateY(-1px)';\n+                  e.currentTarget.style.boxShadow = '0 3px 8px rgba(0,0,0,0.2)';\n+                }\n               }}\n-            />\n+              onMouseLeave={(e) => {\n+                e.currentTarget.style.transform = 'translateY(0)';\n+                e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';\n+              }}\n+            >\n+              {saveStatus === 'saved' ? '‚úì Saved!' : 'Save Changes'}\n+            </button>\n           </div>\n+        </div>\n+      </div>\n \n-          {/* States */}\n-          <div style={{ display: 'grid', gap: 12 }}>\n-            {Object.entries(stateConfig.states).map(([id, state]) => (\n-              <div key={id} style={{\n-                padding: 12,\n-                background: '#f8f0e6',\n-                border: '1px solid #d0c4b0',\n-                borderRadius: 4,\n-                position: 'relative'\n-              }}>\n-                <button\n-                  onClick={() => handleDeleteState(id)}\n+      {/* Scrollable Content Area */}\n+      <div ref={scrollContainerRef} style={{ flex: 1, overflowY: 'auto', padding: '32px', background: '#f8f0e6' }}>\n+\n+        {/* VOICES TAB */}\n+        {activeTab === 'voices' && (\n+          <div style={{\n+            display: 'grid',\n+            gridTemplateColumns: 'repeat(auto-fill, minmax(360px, 1fr))',\n+            gap: 24,\n+            alignContent: 'start'\n+          }}>\n+            {Object.entries(voices).map(([id, voice]) => {\n+              const colorHex = COLORS[voice.color as keyof typeof COLORS]?.hex || '#4a90e2';\n+              const Icon = iconMap[voice.icon as keyof typeof iconMap] || FaBrain;\n+\n+              return (\n+                <div\n+                  key={id}\n                   style={{\n-                    position: 'absolute',\n-                    top: 8,\n-                    right: 8,\n-                    background: 'none',\n-                    border: 'none',\n-                    cursor: 'pointer',\n-                    fontSize: 14\n+                    background: '#fff',\n+                    border: `2px solid ${voice.enabled ? colorHex : '#ddd'}`,\n+                    borderRadius: 12,\n+                    padding: 20,\n+                    position: 'relative',\n+                    boxShadow: voice.enabled ? '0 4px 12px rgba(0,0,0,0.1)' : '0 2px 6px rgba(0,0,0,0.05)',\n+                    transition: 'all 0.3s',\n+                    opacity: voice.enabled ? 1 : 0.6\n+                  }}\n+                  onMouseEnter={(e) => {\n+                    e.currentTarget.style.transform = 'translateY(-2px)';\n+                    e.currentTarget.style.boxShadow = voice.enabled ? '0 6px 16px rgba(0,0,0,0.15)' : '0 3px 8px rgba(0,0,0,0.08)';\n+                  }}\n+                  onMouseLeave={(e) => {\n+                    e.currentTarget.style.transform = 'translateY(0)';\n+                    e.currentTarget.style.boxShadow = voice.enabled ? '0 4px 12px rgba(0,0,0,0.1)' : '0 2px 6px rgba(0,0,0,0.05)';\n                   }}\n-                  title=\"Delete\"\n                 >\n-                  üóëÔ∏è\n-                </button>\n-\n-                <div style={{ marginBottom: 8 }}>\n-                  <label style={{\n-                    display: 'block',\n-                    fontSize: 11,\n-                    fontWeight: 600,\n-                    color: '#666',\n-                    marginBottom: 4\n-                  }}>\n-                    State Name (shown to user)\n-                  </label>\n-                  <input\n-                    type=\"text\"\n-                    value={state.name}\n-                    onChange={e => handleUpdateState(id, 'name', e.target.value)}\n-                    placeholder=\"e.g., Happy\"\n+                  {/* Delete button */}\n+                  <button\n+                    onClick={() => handleDelete(id)}\n                     style={{\n-                      width: '100%',\n-                      padding: 6,\n-                      fontSize: 13,\n-                      border: '1px solid #d0c4b0',\n-                      borderRadius: 4,\n-                      background: '#fff',\n-                      boxSizing: 'border-box'\n+                      position: 'absolute',\n+                      top: 12,\n+                      right: 12,\n+                      background: 'rgba(255, 255, 255, 0.9)',\n+                      border: '1px solid #ddd',\n+                      borderRadius: 6,\n+                      width: 28,\n+                      height: 28,\n+                      display: 'flex',\n+                      alignItems: 'center',\n+                      justifyContent: 'center',\n+                      cursor: 'pointer',\n+                      fontSize: 14,\n+                      transition: 'all 0.2s'\n                     }}\n-                  />\n-                </div>\n-\n-                <div>\n-                  <label style={{\n-                    display: 'block',\n-                    fontSize: 11,\n-                    fontWeight: 600,\n-                    color: '#666',\n-                    marginBottom: 4\n-                  }}>\n-                    State Prompt (added to voice context)\n-                  </label>\n-                  <textarea\n-                    value={state.prompt}\n-                    onChange={e => handleUpdateState(id, 'prompt', e.target.value)}\n-                    placeholder=\"e.g., The user is feeling positive and energized...\"\n-                    style={{\n-                      width: '100%',\n-                      minHeight: 60,\n-                      padding: 8,\n-                      fontSize: 12,\n-                      fontFamily: 'monospace',\n-                      border: '1px solid #d0c4b0',\n-                      borderRadius: 4,\n-                      background: '#fff',\n-                      resize: 'vertical',\n-                      boxSizing: 'border-box',\n-                      lineHeight: 1.4\n+                    onMouseEnter={(e) => {\n+                      e.currentTarget.style.background = '#fee';\n+                      e.currentTarget.style.borderColor = '#fcc';\n                     }}\n-                  />\n+                    onMouseLeave={(e) => {\n+                      e.currentTarget.style.background = 'rgba(255, 255, 255, 0.9)';\n+                      e.currentTarget.style.borderColor = '#ddd';\n+                    }}\n+                    title=\"Delete\"\n+                  >\n+                    √ó\n+                  </button>\n+\n+                  {/* Voice Header */}\n+                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: 12, marginBottom: 16 }}>\n+                    {/* Icon Circle */}\n+                    <div style={{\n+                      width: 56,\n+                      height: 56,\n+                      borderRadius: 28,\n+                      background: `linear-gradient(135deg, ${colorHex} 0%, ${colorHex}cc 100%)`,\n+                      display: 'flex',\n+                      alignItems: 'center',\n+                      justifyContent: 'center',\n+                      color: '#fff',\n+                      flexShrink: 0,\n+                      boxShadow: `0 3px 8px ${colorHex}40`\n+                    }}>\n+                      <Icon size={28} />\n+                    </div>\n+\n+                    {/* Name + Toggle */}\n+                    <div style={{ flex: 1, minWidth: 0 }}>\n+                      <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }}>\n+                        <input\n+                          type=\"checkbox\"\n+                          checked={voice.enabled}\n+                          onChange={e => handleUpdate(id, 'enabled', e.target.checked)}\n+                          style={{\n+                            width: 18,\n+                            height: 18,\n+                            cursor: 'pointer',\n+                            accentColor: colorHex\n+                          }}\n+                        />\n+                        <input\n+                          type=\"text\"\n+                          value={voice.name}\n+                          onChange={e => handleRename(id, e.target.value)}\n+                          placeholder=\"Voice Name\"\n+                          style={{\n+                            flex: 1,\n+                            border: 'none',\n+                            borderBottom: '2px solid transparent',\n+                            fontSize: 18,\n+                            fontWeight: 700,\n+                            background: 'transparent',\n+                            padding: '4px 0',\n+                            color: '#2c2c2c',\n+                            outline: 'none',\n+                            transition: 'border-color 0.2s'\n+                          }}\n+                          onFocus={(e) => {\n+                            e.currentTarget.style.borderBottomColor = colorHex;\n+                          }}\n+                          onBlur={(e) => {\n+                            e.currentTarget.style.borderBottomColor = 'transparent';\n+                          }}\n+                        />\n+                      </div>\n+\n+                      {/* Icon + Color Selectors */}\n+                      <div style={{ display: 'flex', gap: 8 }}>\n+                        <select\n+                          value={voice.icon}\n+                          onChange={e => handleUpdate(id, 'icon', e.target.value)}\n+                          style={{\n+                            flex: 1,\n+                            padding: '6px 8px',\n+                            border: '1px solid #e0e0e0',\n+                            borderRadius: 6,\n+                            background: '#f9f9f9',\n+                            fontSize: 12,\n+                            cursor: 'pointer'\n+                          }}\n+                        >\n+                          {Object.entries(ICON_LABELS).map(([name, label]) => (\n+                            <option key={name} value={name}>{label}</option>\n+                          ))}\n+                        </select>\n+                        <select\n+                          value={voice.color}\n+                          onChange={e => handleUpdate(id, 'color', e.target.value)}\n+                          style={{\n+                            flex: 1,\n+                            padding: '6px 8px',\n+                            border: '1px solid #e0e0e0',\n+                            borderRadius: 6,\n+                            background: '#f9f9f9',\n+                            fontSize: 12,\n+                            cursor: 'pointer'\n+                          }}\n+                        >\n+                          {Object.entries(COLORS).map(([name, { label }]) => (\n+                            <option key={name} value={name}>\n+                              {label}\n+                            </option>\n+                          ))}\n+                        </select>\n+                      </div>\n+                    </div>\n+                  </div>\n+\n+                  {/* System Prompt */}\n+                  <div>\n+                    <label style={{\n+                      display: 'block',\n+                      fontSize: 11,\n+                      fontWeight: 600,\n+                      color: '#666',\n+                      marginBottom: 6,\n+                      textTransform: 'uppercase',\n+                      letterSpacing: '0.5px'\n+                    }}>\n+                      Personality Prompt\n+                    </label>\n+                    <textarea\n+                      value={voice.systemPrompt}\n+                      onChange={e => handleUpdate(id, 'systemPrompt', e.target.value)}\n+                      placeholder=\"Describe this voice's personality, tone, and perspective...\"\n+                      style={{\n+                        width: '100%',\n+                        minHeight: 120,\n+                        padding: 12,\n+                        fontSize: 13,\n+                        fontFamily: 'monospace',\n+                        border: '1px solid #e0e0e0',\n+                        borderRadius: 6,\n+                        background: '#fafafa',\n+                        resize: 'vertical',\n+                        boxSizing: 'border-box',\n+                        lineHeight: 1.6,\n+                        transition: 'all 0.2s'\n+                      }}\n+                      onFocus={(e) => {\n+                        e.currentTarget.style.borderColor = colorHex;\n+                        e.currentTarget.style.background = '#fff';\n+                      }}\n+                      onBlur={(e) => {\n+                        e.currentTarget.style.borderColor = '#e0e0e0';\n+                        e.currentTarget.style.background = '#fafafa';\n+                      }}\n+                    />\n+                  </div>\n                 </div>\n-              </div>\n-            ))}\n+              );\n+            })}\n           </div>\n-        </div>\n+        )}\n \n-        {/* Voice Personas Grid */}\n-        <div style={{\n-          display: 'grid',\n-          gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))',\n-          gap: 20,\n-          alignContent: 'start'\n-        }}>\n-        {Object.entries(voices).map(([id, voice]) => (\n-          <div key={id} style={{ padding: 12, border: '1px solid #d0c4b0', borderRadius: 4, position: 'relative', background: '#fffef9' }}>\n-            <button\n-              onClick={() => handleDelete(id)}\n-              style={{ position: 'absolute', top: 8, right: 8, background: 'none', border: 'none', cursor: 'pointer', fontSize: 16 }}\n-              title=\"Delete\"\n-            >\n-              üóëÔ∏è\n-            </button>\n+        {/* META TAB */}\n+        {activeTab === 'meta' && (\n+          <div style={{ maxWidth: 800, margin: '0 auto' }}>\n+            <div style={{\n+              padding: 24,\n+              background: '#fff',\n+              border: '2px solid #d0c4b0',\n+              borderRadius: 12,\n+              boxShadow: '0 4px 12px rgba(0,0,0,0.08)'\n+            }}>\n+              <h3 style={{\n+                margin: '0 0 8px 0',\n+                fontSize: 20,\n+                fontWeight: 600,\n+                color: '#2c2c2c'\n+              }}>\n+                Meta Prompt\n+              </h3>\n+              <p style={{\n+                margin: '0 0 20px 0',\n+                fontSize: 14,\n+                color: '#666',\n+                lineHeight: 1.6\n+              }}>\n+                Global instructions applied to all voice personas. These instructions affect both voice comments and chat conversations. Use this to set a consistent tone or add context that all voices should be aware of.\n+              </p>\n+              <textarea\n+                value={metaPrompt}\n+                onChange={e => setMetaPrompt(e.target.value)}\n+                placeholder=\"e.g., Be honest and pragmatic. Prioritize mental well-being over theatrical commentary. Focus on actionable insights rather than abstract philosophizing...\"\n+                style={{\n+                  width: '100%',\n+                  minHeight: 200,\n+                  padding: 16,\n+                  fontSize: 14,\n+                  fontFamily: 'monospace',\n+                  border: '2px solid #e0e0e0',\n+                  borderRadius: 8,\n+                  background: '#fafafa',\n+                  resize: 'vertical',\n+                  boxSizing: 'border-box',\n+                  lineHeight: 1.7,\n+                  transition: 'all 0.2s'\n+                }}\n+                onFocus={(e) => {\n+                  e.currentTarget.style.borderColor = '#2c2c2c';\n+                  e.currentTarget.style.background = '#fff';\n+                }}\n+                onBlur={(e) => {\n+                  e.currentTarget.style.borderColor = '#e0e0e0';\n+                  e.currentTarget.style.background = '#fafafa';\n+                }}\n+              />\n+            </div>\n+          </div>\n+        )}\n \n-            <div style={{ marginBottom: 8 }}>\n-              <label style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n-                <input\n-                  type=\"checkbox\"\n-                  checked={voice.enabled}\n-                  onChange={e => handleUpdate(id, 'enabled', e.target.checked)}\n-                />\n-                <input\n-                  type=\"text\"\n-                  value={voice.name}\n-                  onChange={e => handleRename(id, e.target.value)}\n-                  placeholder=\"Voice Name\"\n-                  style={{ flex: 1, border: 'none', borderBottom: '1px solid #d0c4b0', fontSize: 14, fontWeight: 'bold', background: 'transparent', padding: '4px 0' }}\n-                />\n-              </label>\n+        {/* STATES TAB */}\n+        {activeTab === 'states' && (\n+          <div style={{ maxWidth: 900, margin: '0 auto' }}>\n+            {/* Greeting Section */}\n+            <div style={{\n+              marginBottom: 24,\n+              padding: 24,\n+              background: '#fff',\n+              border: '2px solid #d0c4b0',\n+              borderRadius: 12,\n+              boxShadow: '0 4px 12px rgba(0,0,0,0.08)'\n+            }}>\n+              <h3 style={{\n+                margin: '0 0 8px 0',\n+                fontSize: 20,\n+                fontWeight: 600,\n+                color: '#2c2c2c'\n+              }}>\n+                Greeting Message\n+              </h3>\n+              <p style={{\n+                margin: '0 0 16px 0',\n+                fontSize: 14,\n+                color: '#666',\n+                lineHeight: 1.6\n+              }}>\n+                The message shown when you start writing. This appears at the top of the page.\n+              </p>\n+              <input\n+                type=\"text\"\n+                value={stateConfig.greeting}\n+                onChange={e => setStateConfig({ ...stateConfig, greeting: e.target.value })}\n+                placeholder=\"e.g., How are you feeling today?\"\n+                style={{\n+                  width: '100%',\n+                  padding: 12,\n+                  fontSize: 15,\n+                  border: '2px solid #e0e0e0',\n+                  borderRadius: 8,\n+                  background: '#fafafa',\n+                  boxSizing: 'border-box',\n+                  transition: 'all 0.2s'\n+                }}\n+                onFocus={(e) => {\n+                  e.currentTarget.style.borderColor = '#2c2c2c';\n+                  e.currentTarget.style.background = '#fff';\n+                }}\n+                onBlur={(e) => {\n+                  e.currentTarget.style.borderColor = '#e0e0e0';\n+                  e.currentTarget.style.background = '#fafafa';\n+                }}\n+              />\n             </div>\n \n-            <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>\n-              <select\n-                value={voice.icon}\n-                onChange={e => handleUpdate(id, 'icon', e.target.value)}\n-                style={{ flex: 1, padding: 4, border: '1px solid #d0c4b0', borderRadius: 4, background: '#fff' }}\n-              >\n-                {Object.entries(ICONS).map(([name, emoji]) => (\n-                  <option key={name} value={name}>{emoji} {name}</option>\n-                ))}\n-              </select>\n-              <select\n-                value={voice.color}\n-                onChange={e => handleUpdate(id, 'color', e.target.value)}\n-                style={{ flex: 1, padding: 4, border: '1px solid #d0c4b0', borderRadius: 4, background: '#fff' }}\n-              >\n-                {Object.entries(COLORS).map(([name, { hex, label }]) => (\n-                  <option key={name} value={name} style={{ color: hex }}>‚óè {label}</option>\n+            {/* States List */}\n+            <div style={{\n+              padding: 24,\n+              background: '#fff',\n+              border: '2px solid #d0c4b0',\n+              borderRadius: 12,\n+              boxShadow: '0 4px 12px rgba(0,0,0,0.08)'\n+            }}>\n+              <h3 style={{\n+                margin: '0 0 8px 0',\n+                fontSize: 20,\n+                fontWeight: 600,\n+                color: '#2c2c2c'\n+              }}>\n+                User States\n+              </h3>\n+              <p style={{\n+                margin: '0 0 24px 0',\n+                fontSize: 14,\n+                color: '#666',\n+                lineHeight: 1.6\n+              }}>\n+                Define emotional states that users can select. Each state has a prompt that influences how AI voices respond.\n+              </p>\n+\n+              {/* States Grid */}\n+              <div style={{ display: 'grid', gap: 16 }}>\n+                {Object.entries(stateConfig.states).map(([id, state]) => (\n+                  <div key={id} style={{\n+                    padding: 16,\n+                    background: '#f9f9f9',\n+                    border: '2px solid #e0e0e0',\n+                    borderRadius: 8,\n+                    position: 'relative',\n+                    transition: 'all 0.2s'\n+                  }}\n+                  onMouseEnter={(e) => {\n+                    e.currentTarget.style.borderColor = '#d0c4b0';\n+                  }}\n+                  onMouseLeave={(e) => {\n+                    e.currentTarget.style.borderColor = '#e0e0e0';\n+                  }}\n+                  >\n+                    <button\n+                      onClick={() => handleDeleteState(id)}\n+                      style={{\n+                        position: 'absolute',\n+                        top: 12,\n+                        right: 12,\n+                        background: 'rgba(255, 255, 255, 0.9)',\n+                        border: '1px solid #ddd',\n+                        borderRadius: 6,\n+                        width: 28,\n+                        height: 28,\n+                        display: 'flex',\n+                        alignItems: 'center',\n+                        justifyContent: 'center',\n+                        cursor: 'pointer',\n+                        fontSize: 14,\n+                        transition: 'all 0.2s'\n+                      }}\n+                      onMouseEnter={(e) => {\n+                        e.currentTarget.style.background = '#fee';\n+                        e.currentTarget.style.borderColor = '#fcc';\n+                      }}\n+                      onMouseLeave={(e) => {\n+                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.9)';\n+                        e.currentTarget.style.borderColor = '#ddd';\n+                      }}\n+                      title=\"Delete\"\n+                    >\n+                      √ó\n+                    </button>\n+\n+                    <div style={{ marginBottom: 12 }}>\n+                      <label style={{\n+                        display: 'block',\n+                        fontSize: 11,\n+                        fontWeight: 600,\n+                        color: '#666',\n+                        marginBottom: 6,\n+                        textTransform: 'uppercase',\n+                        letterSpacing: '0.5px'\n+                      }}>\n+                        State Name\n+                      </label>\n+                      <input\n+                        type=\"text\"\n+                        value={state.name}\n+                        onChange={e => handleUpdateState(id, 'name', e.target.value)}\n+                        placeholder=\"e.g., Happy, Anxious, Reflective...\"\n+                        style={{\n+                          width: '100%',\n+                          padding: 10,\n+                          fontSize: 15,\n+                          fontWeight: 600,\n+                          border: '2px solid #e0e0e0',\n+                          borderRadius: 6,\n+                          background: '#fff',\n+                          boxSizing: 'border-box',\n+                          transition: 'all 0.2s'\n+                        }}\n+                        onFocus={(e) => {\n+                          e.currentTarget.style.borderColor = '#2c2c2c';\n+                        }}\n+                        onBlur={(e) => {\n+                          e.currentTarget.style.borderColor = '#e0e0e0';\n+                        }}\n+                      />\n+                    </div>\n+\n+                    <div>\n+                      <label style={{\n+                        display: 'block',\n+                        fontSize: 11,\n+                        fontWeight: 600,\n+                        color: '#666',\n+                        marginBottom: 6,\n+                        textTransform: 'uppercase',\n+                        letterSpacing: '0.5px'\n+                      }}>\n+                        State Prompt\n+                      </label>\n+                      <textarea\n+                        value={state.prompt}\n+                        onChange={e => handleUpdateState(id, 'prompt', e.target.value)}\n+                        placeholder=\"e.g., The user is feeling anxious and overthinking things. Be gentle and help them ground themselves in the present moment...\"\n+                        style={{\n+                          width: '100%',\n+                          minHeight: 80,\n+                          padding: 10,\n+                          fontSize: 13,\n+                          fontFamily: 'monospace',\n+                          border: '2px solid #e0e0e0',\n+                          borderRadius: 6,\n+                          background: '#fff',\n+                          resize: 'vertical',\n+                          boxSizing: 'border-box',\n+                          lineHeight: 1.6,\n+                          transition: 'all 0.2s'\n+                        }}\n+                        onFocus={(e) => {\n+                          e.currentTarget.style.borderColor = '#2c2c2c';\n+                        }}\n+                        onBlur={(e) => {\n+                          e.currentTarget.style.borderColor = '#e0e0e0';\n+                        }}\n+                      />\n+                    </div>\n+                  </div>\n                 ))}\n-              </select>\n+              </div>\n             </div>\n-\n-            <textarea\n-              value={voice.systemPrompt}\n-              onChange={e => handleUpdate(id, 'systemPrompt', e.target.value)}\n-              placeholder=\"Voice prompt...\"\n-              style={{ width: '100%', minHeight: 100, padding: 8, fontSize: 13, fontFamily: 'monospace', border: '1px solid #d0c4b0', borderRadius: 4, background: '#fff', resize: 'none', boxSizing: 'border-box' }}\n-            />\n           </div>\n-        ))}\n-        </div>\n+        )}\n       </div>\n     </div>\n   );"
    },
    {
      "sha": "d918e3c358b33256a92f14339877f65e6b634aa6",
      "filename": "frontend/src/engine/EditorEngine.ts",
      "status": "modified",
      "additions": 31,
      "deletions": 6,
      "changes": 37,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fengine%2FEditorEngine.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9e3b768ed5ff748535d29ebcf44fb924df86f2/frontend%2Fsrc%2Fengine%2FEditorEngine.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fengine%2FEditorEngine.ts?ref=0b9e3b768ed5ff748535d29ebcf44fb924df86f2",
      "patch": "@@ -166,7 +166,16 @@ export class EditorEngine {\n     this.checkAnalysisTrigger(combinedText, energy);\n \n     // Check if we can apply commentors\n-    this.checkCommentorApplication(combinedText, energy);\n+    const result = this.checkCommentorApplication(combinedText, energy);\n+\n+    // @@@ If comments were skipped, invalidate cache to allow fresh request\n+    if (result.skippedAny && !result.appliedAny) {\n+      console.log(`üîÑ Comments were skipped, invalidating cache to allow fresh request`);\n+      const completedSentences = getCompletedSentences(combinedText);\n+      if (completedSentences) {\n+        this.sentCache.delete(completedSentences);\n+      }\n+    }\n \n     this.notifyChange();\n   }\n@@ -212,8 +221,9 @@ export class EditorEngine {\n   }\n \n   // @@@ Check if we can apply commentors from waitlist\n-  private checkCommentorApplication(text: string, currentEnergy: number): boolean {\n+  private checkCommentorApplication(text: string, currentEnergy: number): { appliedAny: boolean; skippedAny: boolean } {\n     let appliedAny = false;\n+    let skippedAny = false;\n \n     // Apply ONE commentor at a time when we have enough energy\n     while (this.commentorWaitlist.length > 0) {\n@@ -229,13 +239,15 @@ export class EditorEngine {\n       // Check if text still matches (current text starts with snapshot)\n       if (!text.startsWith(commentor.textSnapshot)) {\n         console.log(`‚è≠Ô∏è Skipped outdated commentor: ${commentor.voice}`);\n+        skippedAny = true;\n         continue;\n       }\n \n       // @@@ Check for overlap with existing highlights\n       const phraseIndex = text.toLowerCase().indexOf(commentor.phrase.toLowerCase());\n       if (phraseIndex === -1) {\n         console.log(`‚è≠Ô∏è Skipped commentor (phrase not found): ${commentor.voice}`);\n+        skippedAny = true;\n         continue;\n       }\n \n@@ -260,6 +272,7 @@ export class EditorEngine {\n       }\n \n       if (hasOverlap) {\n+        skippedAny = true;\n         continue;\n       }\n \n@@ -276,7 +289,7 @@ export class EditorEngine {\n       this.notifyChange();\n     }\n \n-    return appliedAny;\n+    return { appliedAny, skippedAny };\n   }\n \n   // @@@ Request analysis from backend\n@@ -376,10 +389,22 @@ export class EditorEngine {\n     const currentEnergy = lastEntry?.energy || 0;\n \n     // Try to apply comments from waitlist\n-    const appliedAny = this.checkCommentorApplication(text, currentEnergy);\n-\n+    const result = this.checkCommentorApplication(text, currentEnergy);\n+\n+    // @@@ If comments were skipped but not applied, invalidate cache\n+    if (result.skippedAny && !result.appliedAny) {\n+      console.log(`üîÑ All pending comments were skipped, invalidating cache`);\n+      const completedSentences = getCompletedSentences(text);\n+      if (completedSentences) {\n+        this.sentCache.delete(completedSentences);\n+        // Trigger a fresh request immediately\n+        setTimeout(() => {\n+          this.checkAnalysisTrigger(text, currentEnergy);\n+        }, 50);\n+      }\n+    }\n     // If we applied comments, hash changed, so check if we need another request\n-    if (appliedAny) {\n+    else if (result.appliedAny) {\n       // Give a small delay to let the UI update\n       setTimeout(() => {\n         this.checkAnalysisTrigger(text, currentEnergy);"
    }
  ]
}