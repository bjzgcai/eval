{
  "sha": "cb5c9121367bd4961d9dde2a0231f6a6bb9c4044",
  "node_id": "C_kwDOP2Zrm9oAKGNiNWM5MTIxMzY3YmQ0OTYxZDlkZGUyYTAyMzFmNmE2YmI5YzQwNDQ",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-05T12:43:24Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-05T12:43:24Z"
    },
    "message": "Add voice persona inspiration system with floating bubble UI\n\n- Transform writing suggestion into inspiration system\n- Randomly select voice persona to deliver encouragement\n- Display inspiration in floating bubble with icon and voice name\n- Backend generates context-aware inspiration messages\n- Frontend shows bubble bottom-right with close button\n\nü§ñ Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>",
    "tree": {
      "sha": "f4d08c9f0ed6a079e26a13301872b60cf94c8b2a",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/f4d08c9f0ed6a079e26a13301872b60cf94c8b2a"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "ad29eb9976d519094a72142f177df031013950a6",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/ad29eb9976d519094a72142f177df031013950a6",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/ad29eb9976d519094a72142f177df031013950a6"
    }
  ],
  "stats": {
    "total": 288,
    "additions": 286,
    "deletions": 2
  },
  "files": [
    {
      "sha": "ff3c8c3076368d73394caa9d70b3a891d20230d5",
      "filename": "backend/server.py",
      "status": "modified",
      "additions": 93,
      "deletions": 0,
      "changes": 93,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044/backend%2Fserver.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044/backend%2Fserver.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=cb5c9121367bd4961d9dde2a0231f6a6bb9c4044",
      "patch": "@@ -19,6 +19,79 @@\n \n # ========== Session Definitions (PolyCLI) ==========\n \n+@session_def(\n+    name=\"Get Writing Suggestion\",\n+    description=\"Get AI-powered writing inspiration from a voice persona\",\n+    params={\n+        \"text\": {\"type\": \"str\"},\n+        \"meta_prompt\": {\"type\": \"str\"},\n+        \"state_prompt\": {\"type\": \"str\"}\n+    },\n+    category=\"Writing\"\n+)\n+def get_writing_suggestion(text: str, meta_prompt: str = \"\", state_prompt: str = \"\"):\n+    \"\"\"Generate writing inspiration from a random voice persona.\"\"\"\n+    print(f\"\\n{'='*60}\")\n+    print(f\"‚úçÔ∏è  get_writing_suggestion() called\")\n+    print(f\"   Text length: {len(text)} chars\")\n+    print(f\"{'='*60}\\n\")\n+\n+    if not text or len(text.strip()) < 10:\n+        return {\"success\": False, \"error\": \"Text too short\"}\n+\n+    # @@@ Pick a random voice persona to deliver inspiration\n+    import random\n+    from config import VOICE_ARCHETYPES\n+\n+    voice_key = random.choice(list(VOICE_ARCHETYPES.keys()))\n+    voice_info = VOICE_ARCHETYPES[voice_key]\n+\n+    print(f\"üé≠ Selected voice: {voice_info['name']} ({voice_key})\")\n+\n+    agent = PolyAgent(id=\"writing-suggester\")\n+\n+    # Build system prompt - voice gives inspiration, not continuation\n+    system_prompt = f\"\"\"You are {voice_info['name']}, an inner voice persona.\n+Your role: {voice_info['tagline']}\n+\n+Read the user's writing and offer a brief, inspiring comment to help them continue.\n+Be encouraging, insightful, or thought-provoking (1-2 sentences).\n+Speak in the voice's characteristic style.\"\"\"\n+\n+    if state_prompt:\n+        system_prompt += f\"\\n\\nContext: {state_prompt}\"\n+\n+    if meta_prompt:\n+        system_prompt += f\"\\n\\nStyle guide: {meta_prompt}\"\n+\n+    user_prompt = f\"\"\"The user wrote:\n+\n+{text}\n+\n+Offer a brief, inspiring comment to help them continue writing (1-2 sentences).\"\"\"\n+\n+    # Generate inspiration\n+    print(f\"üì§ Calling agent.run() with model='claude-haiku-4.5'...\")\n+    result = agent.run(user_prompt, system_prompt=system_prompt, model='claude-haiku-4.5', cli=\"no-tools\", tracked=True)\n+\n+    if not result.is_success or not result.content:\n+        print(f\"‚ö†Ô∏è  Failed to generate inspiration\")\n+        inspiration = None\n+    else:\n+        inspiration = result.content.strip()\n+        print(f\"‚úÖ Got inspiration: {inspiration[:100]}...\")\n+\n+    print(f\"\\nüì¶ Returning voice inspiration\\n\")\n+\n+    return {\n+        \"success\": True,\n+        \"inspiration\": inspiration,\n+        \"voice\": voice_info['name'],\n+        \"voice_key\": voice_key,\n+        \"icon\": voice_info['icon'],\n+        \"color\": voice_info['color']\n+    }\n+\n @session_def(\n     name=\"Chat with Voice\",\n     description=\"Have a conversation with a specific inner voice persona\",\n@@ -970,6 +1043,25 @@ def save_preferences_endpoint(\n \n     return {\"success\": True}\n \n+@app.post(\"/api/suggest\")\n+async def suggest_api(request_data: dict):\n+    \"\"\"\n+    @@@ Get writing continuation suggestions (sync API).\n+\n+    Uses PolyCLI's sync API internally - no polling needed!\n+    \"\"\"\n+    async with httpx.AsyncClient() as client:\n+        response = await client.post(\n+            \"http://localhost:8765/polycli/api/trigger-sync\",\n+            json={\n+                \"session_id\": \"get_writing_suggestion\",\n+                \"params\": request_data,\n+                \"timeout\": 30.0\n+            },\n+            timeout=35.0\n+        )\n+        return response.json()\n+\n @app.post(\"/api/mark-first-login-completed\")\n def mark_first_login_completed(current_user: dict = Depends(get_current_user)):\n     \"\"\"\n@@ -1146,6 +1238,7 @@ async def analyze_patterns_api(request_data: dict):\n     print(\"    POST /api/analyze-echoes  - Find themes (sync)\")\n     print(\"    POST /api/analyze-traits  - Identify traits (sync)\")\n     print(\"    POST /api/analyze-patterns - Find patterns (sync)\")\n+    print(\"    POST /api/suggest         - Get writing suggestions (sync)\")\n     print(\"    GET  /api/default-voices  - Get voice configs\")\n     print(\"\\n  PolyCLI Control Panel:\")\n     print(\"    /polycli                  - Control panel UI\")"
    },
    {
      "sha": "16b9b5d2f5039a2a7288b19328ccd010ce80cd76",
      "filename": "frontend/src/App.tsx",
      "status": "modified",
      "additions": 150,
      "deletions": 2,
      "changes": 152,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044/frontend%2Fsrc%2FApp.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044/frontend%2Fsrc%2FApp.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=cb5c9121367bd4961d9dde2a0231f6a6bb9c4044",
      "patch": "@@ -22,12 +22,15 @@ import ChatWidgetUI from './components/ChatWidgetUI';\n import StateChooser from './components/StateChooser';\n import type { VoiceConfig, StateConfig } from './types/voice';\n import { getVoices, getMetaPrompt, getStateConfig } from './utils/voiceStorage';\n-import { getDefaultVoices, chatWithVoice, importLocalData } from './api/voiceApi';\n+import { getDefaultVoices, chatWithVoice, importLocalData, getSuggestion, type VoiceInspiration } from './api/voiceApi';\n import { useMobile } from './utils/mobileDetect';\n import { CommentGroupCard } from './components/CommentCard';\n import { findNormalizedPhrase } from './utils/textNormalize';\n import { useAuth } from './contexts/AuthContext';\n import LoginForm from './components/Auth/LoginForm';\n+\n+// @@@ DEBUG: Verify new code is loaded\n+console.log('üöÄüöÄüöÄ APP.TSX LOADED - NEW CODE WITH SUGGESTIONS üöÄüöÄüöÄ');\n import RegisterForm from './components/Auth/RegisterForm';\n import { STORAGE_KEYS } from './constants/storageKeys';\n \n@@ -283,6 +286,11 @@ export default function App() {\n   const [expandedCommentId, setExpandedCommentId] = useState<string | null>(null);\n   const [commentChatProcessing, setCommentChatProcessing] = useState<Set<string>>(new Set());\n \n+  // @@@ Writing suggestion state\n+  const [currentInspiration, setCurrentInspiration] = useState<VoiceInspiration | null>(null);\n+  const [suggestionSnapshot, setSuggestionSnapshot] = useState<string>('');\n+  const suggestionTimerRef = useRef<NodeJS.Timeout | null>(null);\n+\n   // @@@ Trigger re-render when returning to writing view to recalculate comment positions\n   useEffect(() => {\n     if (currentView === 'writing') {\n@@ -807,12 +815,23 @@ export default function App() {\n \n   // @@@ Per-cell text change handler\n   const handleTextChange = useCallback((cellId: string, newText: string) => {\n+    console.log('üî•üî•üî• handleTextChange CALLED!', cellId, newText.length);\n     setLocalTexts(prev => {\n       const next = new Map(prev);\n       next.set(cellId, newText);\n       return next;\n     });\n \n+    // @@@ Clear inspiration instantly on typing\n+    setCurrentInspiration(null);\n+    setSuggestionSnapshot('');\n+\n+    // @@@ Clear existing suggestion timer\n+    if (suggestionTimerRef.current) {\n+      clearTimeout(suggestionTimerRef.current);\n+      suggestionTimerRef.current = null;\n+    }\n+\n     // @@@ Auto-resize textarea to prevent internal scrolling\n     const textarea = textareaRefs.current.get(cellId);\n     if (textarea) {\n@@ -831,7 +850,67 @@ export default function App() {\n     if (!composingCells.has(cellId) && engineRef.current) {\n       engineRef.current.updateTextCell(cellId, newText);\n     }\n-  }, [composingCells, dropdownVisible, dropdownTriggerCellId]);\n+\n+    // @@@ Start 5-second debounce timer for suggestions\n+    console.log('‚è±Ô∏è  Starting 5-second suggestion timer');\n+    suggestionTimerRef.current = setTimeout(async () => {\n+      console.log('‚è∞ Timer fired! Fetching suggestion...');\n+\n+      // Get all text from all text cells\n+      const allText = state?.cells\n+        .filter(c => c.type === 'text')\n+        .map(c => (c as TextCell).content)\n+        .join('') || '';\n+\n+      console.log(`üìù Text length: ${allText.length} chars`);\n+\n+      if (allText.trim().length < 10) {\n+        console.log('‚ùå Text too short, skipping suggestion');\n+        return;\n+      }\n+\n+      // Capture snapshot for validation\n+      const snapshot = allText;\n+      setSuggestionSnapshot(snapshot);\n+\n+      try {\n+        const metaPrompt = getMetaPrompt();\n+        const statePrompt = selectedState && stateConfig.states[selectedState]\n+          ? stateConfig.states[selectedState].prompt\n+          : '';\n+\n+        console.log('üöÄ Calling getSuggestion API...');\n+        const suggestion = await getSuggestion(allText, metaPrompt, statePrompt);\n+        console.log('‚úÖ Got suggestion:', suggestion);\n+\n+        // @@@ Validate text hasn't changed since request was sent\n+        const currentCells = engineRef.current?.getState().cells;\n+        const currentText = currentCells\n+          ?.filter(c => c.type === 'text')\n+          .map(c => (c as TextCell).content)\n+          .join('') || '';\n+\n+        console.log('üìä Comparison:', {\n+          snapshotLength: snapshot.length,\n+          currentLength: currentText.length,\n+          matches: currentText === snapshot\n+        });\n+\n+        if (suggestion && currentText === snapshot) {\n+          console.log('‚ú® Setting inspiration:', suggestion);\n+          setCurrentInspiration(suggestion);\n+        } else {\n+          if (!suggestion) {\n+            console.log('‚ö†Ô∏è  No inspiration returned from backend');\n+          } else {\n+            console.log('‚ö†Ô∏è  Text changed, discarding inspiration');\n+          }\n+        }\n+      } catch (error) {\n+        console.error('‚ùå Failed to get inspiration:', error);\n+      }\n+    }, 5000);\n+  }, [composingCells, dropdownVisible, dropdownTriggerCellId, state, selectedState, stateConfig]);\n \n   // @@@ Per-cell composition handlers\n   const handleCompositionStart = useCallback((cellId: string) => {\n@@ -1919,6 +1998,7 @@ export default function App() {\n                               height: 'auto'\n                             }}\n                           />\n+\n                         </div>\n                       );\n                     } else if (cell.type === 'widget' && cell.widgetType === 'chat') {\n@@ -2252,6 +2332,74 @@ export default function App() {\n         </div>\n       )}\n \n+      {/* @@@ Floating Inspiration Bubble - appears bottom-right when inspiration is available */}\n+      {currentInspiration && (\n+        <div\n+          style={{\n+            position: 'fixed',\n+            bottom: isMobile ? '60px' : '20px',\n+            right: isMobile ? '10px' : '20px',\n+            maxWidth: isMobile ? 'calc(100% - 20px)' : '400px',\n+            backgroundColor: '#fff',\n+            borderRadius: '12px',\n+            boxShadow: '0 4px 20px rgba(0,0,0,0.15)',\n+            padding: '16px',\n+            display: 'flex',\n+            gap: '12px',\n+            alignItems: 'start',\n+            zIndex: 1000,\n+            animation: 'slideIn 0.3s ease-out'\n+          }}\n+        >\n+          {/* Voice Icon */}\n+          <div\n+            style={{\n+              fontSize: '28px',\n+              flexShrink: 0\n+            }}\n+          >\n+            {React.createElement(iconMap[currentInspiration.icon as keyof typeof iconMap] || FaBrain)}\n+          </div>\n+\n+          {/* Inspiration Content */}\n+          <div style={{ flex: 1 }}>\n+            <div style={{\n+              fontWeight: 'bold',\n+              marginBottom: '6px',\n+              fontSize: '14px',\n+              color: '#555'\n+            }}>\n+              {currentInspiration.voice}\n+            </div>\n+            <div style={{\n+              fontSize: '15px',\n+              lineHeight: '1.5',\n+              color: '#333'\n+            }}>\n+              {currentInspiration.inspiration}\n+            </div>\n+          </div>\n+\n+          {/* Close button */}\n+          <button\n+            onClick={() => setCurrentInspiration(null)}\n+            style={{\n+              border: 'none',\n+              background: 'transparent',\n+              cursor: 'pointer',\n+              fontSize: '18px',\n+              color: '#999',\n+              padding: '0',\n+              width: '24px',\n+              height: '24px',\n+              flexShrink: 0\n+            }}\n+          >\n+            √ó\n+          </button>\n+        </div>\n+      )}\n+\n       {/* Calendar Popup */}\n       {showCalendarPopup && (\n         <CalendarPopup"
    },
    {
      "sha": "2b3506f172cfcaf766c651a689338026175a0561",
      "filename": "frontend/src/api/voiceApi.ts",
      "status": "modified",
      "additions": 43,
      "deletions": 0,
      "changes": 43,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/cb5c9121367bd4961d9dde2a0231f6a6bb9c4044/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fapi%2FvoiceApi.ts?ref=cb5c9121367bd4961d9dde2a0231f6a6bb9c4044",
      "patch": "@@ -405,6 +405,49 @@ export async function getPreferences(): Promise<any> {\n   return await response.json();\n }\n \n+/**\n+ * Get writing inspiration from a voice persona\n+ */\n+export interface VoiceInspiration {\n+  inspiration: string;\n+  voice: string;\n+  voice_key: string;\n+  icon: string;\n+  color: string;\n+}\n+\n+export async function getSuggestion(text: string, metaPrompt?: string, statePrompt?: string): Promise<VoiceInspiration | null> {\n+  const response = await fetch(`${API_BASE}/api/suggest`, {\n+    method: 'POST',\n+    headers: { 'Content-Type': 'application/json' },\n+    body: JSON.stringify({\n+      text,\n+      meta_prompt: metaPrompt || '',\n+      state_prompt: statePrompt || ''\n+    })\n+  });\n+\n+  if (!response.ok) {\n+    console.error('Suggestion request failed');\n+    return null;\n+  }\n+\n+  const data = await response.json();\n+\n+  // @@@ PolyCLI trigger-sync wraps the session result in data.result\n+  if (data.result && data.result.success && data.result.inspiration) {\n+    return {\n+      inspiration: data.result.inspiration,\n+      voice: data.result.voice,\n+      voice_key: data.result.voice_key,\n+      icon: data.result.icon,\n+      color: data.result.color\n+    };\n+  }\n+\n+  return null;\n+}\n+\n /**\n  * Save analysis report\n  */"
    }
  ]
}