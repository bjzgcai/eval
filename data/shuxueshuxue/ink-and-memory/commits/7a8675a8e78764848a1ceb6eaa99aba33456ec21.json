{
  "sha": "7a8675a8e78764848a1ceb6eaa99aba33456ec21",
  "node_id": "C_kwDOP2Zrm9oAKDdhODY3NWE4ZTc4NzY0ODQ4YTFjZWI2ZWFhOTlhYmEzMzQ1NmVjMjE",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-17T14:41:40Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-17T14:41:40Z"
    },
    "message": "Integrate deck system into all voice-related features\n\nAll AI voice features now use deck system instead of old preferences:\n- Voice analysis (analyze_text): Uses load_voices_from_user_decks()\n- Writing suggestions (get_writing_suggestion): Random from enabled decks\n- Chat with voices (chat_with_voice): Looks up voice in enabled decks\n\nBenefits:\n- Users control which voices are active via Deck enable/disable toggles\n- Consistent voice source across all features\n- Cleaner architecture (deck system is single source of truth)\n\nChanges:\n- backend/server.py: Update all 3 session functions to use deck system\n- backend/database.py: load_voices_from_user_decks() returns enabled voices\n- frontend/src/components/DeckManager.tsx: Toggle UI integration\n- frontend/src/api/voiceApi.ts: API client for deck sync\n\nRelated: Auto-fork system, sync functionality already implemented",
    "tree": {
      "sha": "54474a14c7f75073df82bb888a5a5f8e0a430998",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/54474a14c7f75073df82bb888a5a5f8e0a430998"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/7a8675a8e78764848a1ceb6eaa99aba33456ec21",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/7a8675a8e78764848a1ceb6eaa99aba33456ec21",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/7a8675a8e78764848a1ceb6eaa99aba33456ec21",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/7a8675a8e78764848a1ceb6eaa99aba33456ec21/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c"
    }
  ],
  "stats": {
    "total": 295,
    "additions": 245,
    "deletions": 50
  },
  "files": [
    {
      "sha": "c2820c8d559aa60a688caf167b0c11c6f183c46e",
      "filename": "backend/database.py",
      "status": "modified",
      "additions": 127,
      "deletions": 0,
      "changes": 127,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/7a8675a8e78764848a1ceb6eaa99aba33456ec21/backend%2Fdatabase.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/7a8675a8e78764848a1ceb6eaa99aba33456ec21/backend%2Fdatabase.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fdatabase.py?ref=7a8675a8e78764848a1ceb6eaa99aba33456ec21",
      "patch": "@@ -541,6 +541,133 @@ def fork_deck(user_id: int, deck_id: str) -> str:\n     finally:\n         db.close()\n \n+def sync_deck_with_parent(user_id: int, deck_id: str, force: bool = False) -> dict:\n+    \"\"\"\n+    Sync user's forked deck with parent template (complete reset).\n+\n+    Deletes all user's voices and re-creates from parent template.\n+    This ensures deleted voices reappear and new parent voices are added.\n+\n+    Returns: {\"success\": True, \"synced_voices\": N}\n+    Raises ValueError if deck not found, no parent, or parent missing\n+    \"\"\"\n+    import uuid\n+\n+    db = get_db()\n+    try:\n+        # Get user's deck\n+        deck = db.execute(\n+            \"SELECT * FROM decks WHERE id = ? AND owner_id = ?\",\n+            (deck_id, user_id)\n+        ).fetchone()\n+\n+        if not deck:\n+            raise ValueError(\"Deck not found or permission denied\")\n+\n+        if not deck['parent_id']:\n+            raise ValueError(\"Deck is not a fork (no parent)\")\n+\n+        # Get parent deck\n+        parent = db.execute(\n+            \"SELECT * FROM decks WHERE id = ?\",\n+            (deck['parent_id'],)\n+        ).fetchone()\n+\n+        if not parent:\n+            raise ValueError(\"Parent deck not found\")\n+\n+        # @@@ Step 1: Sync deck metadata (preserve user preferences like enabled/order)\n+        db.execute(\"\"\"\n+        UPDATE decks SET\n+            name = ?, name_zh = ?, name_en = ?,\n+            description = ?, description_zh = ?, description_en = ?,\n+            icon = ?, color = ?,\n+            has_local_changes = 0,\n+            updated_at = CURRENT_TIMESTAMP\n+        WHERE id = ?\n+        \"\"\", (parent['name'], parent['name_zh'], parent['name_en'],\n+              parent['description'], parent['description_zh'], parent['description_en'],\n+              parent['icon'], parent['color'],\n+              deck_id))\n+\n+        # @@@ Step 2: Delete ALL user's voices in this deck\n+        db.execute(\"DELETE FROM voices WHERE deck_id = ?\", (deck_id,))\n+\n+        # @@@ Step 3: Re-create all voices from parent (fresh copy)\n+        parent_voices = db.execute(\n+            \"SELECT * FROM voices WHERE deck_id = ? ORDER BY order_index\",\n+            (deck['parent_id'],)\n+        ).fetchall()\n+\n+        synced_count = 0\n+        for parent_voice in parent_voices:\n+            new_voice_id = str(uuid.uuid4())\n+            db.execute(\"\"\"\n+            INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt,\n+                              icon, color, is_system, parent_id, owner_id, enabled, has_local_changes, order_index)\n+            VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, 1, 0, ?)\n+            \"\"\", (new_voice_id,\n+                  deck_id,  # User's deck\n+                  parent_voice['name'],\n+                  parent_voice['name_zh'],\n+                  parent_voice['name_en'],\n+                  parent_voice['system_prompt'],\n+                  parent_voice['icon'],\n+                  parent_voice['color'],\n+                  parent_voice['id'],  # parent_id tracks original\n+                  user_id,\n+                  parent_voice['order_index']))\n+            synced_count += 1\n+\n+        db.commit()\n+        return {\"success\": True, \"synced_voices\": synced_count}\n+    finally:\n+        db.close()\n+\n+def load_voices_from_user_decks(user_id: int) -> dict:\n+    \"\"\"\n+    Load all enabled voices from user's enabled decks for LLM analysis.\n+\n+    Returns dict format: {voice_id: {name, systemPrompt, icon, color}}\n+    Compatible with analyze_stateless() expectations.\n+    \"\"\"\n+    db = get_db()\n+    try:\n+        # Get all user's enabled decks\n+        enabled_decks = db.execute(\"\"\"\n+        SELECT id FROM decks\n+        WHERE owner_id = ? AND enabled = 1\n+        ORDER BY order_index, created_at\n+        \"\"\", (user_id,)).fetchall()\n+\n+        if not enabled_decks:\n+            return {}\n+\n+        deck_ids = [deck['id'] for deck in enabled_decks]\n+\n+        # Get all enabled voices from these decks\n+        placeholders = ','.join('?' * len(deck_ids))\n+        voices = db.execute(f\"\"\"\n+        SELECT id, name, system_prompt, icon, color\n+        FROM voices\n+        WHERE deck_id IN ({placeholders}) AND enabled = 1\n+        ORDER BY order_index, created_at\n+        \"\"\", deck_ids).fetchall()\n+\n+        # Convert to expected format\n+        voice_dict = {}\n+        for voice in voices:\n+            voice_dict[voice['id']] = {\n+                'name': voice['name'],\n+                'systemPrompt': voice['system_prompt'],\n+                'icon': voice['icon'],\n+                'color': voice['color']\n+            }\n+\n+        return voice_dict\n+    finally:\n+        db.close()\n+\n # ========== Voice CRUD ==========\n \n def create_voice(user_id: int, deck_id: str, name: str, system_prompt: str,"
    },
    {
      "sha": "992d88aad26b89106863715fce90300facd1e231",
      "filename": "backend/server.py",
      "status": "modified",
      "additions": 33,
      "deletions": 26,
      "changes": 59,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/7a8675a8e78764848a1ceb6eaa99aba33456ec21/backend%2Fserver.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/7a8675a8e78764848a1ceb6eaa99aba33456ec21/backend%2Fserver.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=7a8675a8e78764848a1ceb6eaa99aba33456ec21",
      "patch": "@@ -40,14 +40,20 @@ def get_writing_suggestion(text: str, user_id: int, meta_prompt: str = \"\", state\n     if not text or len(text.strip()) < 10:\n         return {\"success\": False, \"error\": \"Text too short\"}\n \n-    # @@@ Pick a random voice persona to deliver inspiration\n+    # @@@ Load voices from user's enabled decks (deck system)\n     import random\n-    from config import VOICE_ARCHETYPES\n \n-    voice_key = random.choice(list(VOICE_ARCHETYPES.keys()))\n-    voice_info = VOICE_ARCHETYPES[voice_key]\n+    voices = database.load_voices_from_user_decks(user_id)\n+\n+    if not voices:\n+        return {\"success\": False, \"error\": \"No enabled voices found in your decks\"}\n+\n+    # Pick a random enabled voice\n+    voice_key = random.choice(list(voices.keys()))\n+    voice_info = voices[voice_key]\n \n     print(f\"üé≠ Selected voice: {voice_info['name']} ({voice_key})\")\n+    print(f\"üìö Selected from {len(voices)} enabled voices\")\n \n     agent = PolyAgent(id=\"writing-suggester\")\n \n@@ -139,28 +145,20 @@ def chat_with_voice(voice_id: str, user_id: int, conversation_history: list, use\n     print(f\"   State prompt: {repr(state_prompt)[:100]}\")\n     print(f\"{'='*60}\\n\")\n \n-    # @@@ Load user's voice configs from database\n-    prefs = database.get_preferences(user_id)\n-    voice_configs = prefs['voice_configs'] if prefs and prefs['voice_configs'] else {}\n+    # @@@ Load voices from user's enabled decks (deck system)\n+    voices = database.load_voices_from_user_decks(user_id)\n \n     # @@@ Get voice config for this specific voice\n-    if voice_id in voice_configs:\n-        voice_config = voice_configs[voice_id]\n+    if voice_id in voices:\n+        voice_config = voices[voice_id]\n         voice_name = voice_config.get('name', voice_id)\n-        print(f\"üìö Loaded voice config from database for {voice_id}: {voice_name}\")\n+        print(f\"üìö Loaded voice from deck system: {voice_id} ({voice_name})\")\n     else:\n-        # Fallback: use default from config.VOICE_ARCHETYPES\n-        import config\n-        if voice_id in config.VOICE_ARCHETYPES:\n-            default_voice = config.VOICE_ARCHETYPES[voice_id]\n-            voice_name = default_voice['name']\n-            voice_config = {\"systemPrompt\": default_voice['systemPrompt']}\n-            print(f\"üìö Using default voice config for {voice_id}: {voice_name}\")\n-        else:\n-            # Ultimate fallback\n-            voice_name = voice_id\n-            voice_config = {\"systemPrompt\": f\"{voice_name} voice\"}\n-            print(f\"‚ö†Ô∏è  Voice {voice_id} not found, using fallback\")\n+        # Fallback: voice might be disabled or not in user's decks\n+        return {\n+            \"success\": False,\n+            \"error\": f\"Voice {voice_id} not found in your enabled decks. Please enable it in the Decks tab.\"\n+        }\n \n     agent = PolyAgent(id=f\"voice-chat-{voice_name.lower()}\")\n \n@@ -249,10 +247,9 @@ def analyze_text(text: str, editor_session_id: str, user_id: int, applied_commen\n     print(f\"   State prompt: {repr(state_prompt)[:100]}\")\n     print(f\"{'='*60}\\n\")\n \n-    # @@@ Load user's voice configs from database\n-    prefs = database.get_preferences(user_id)\n-    voices = prefs['voice_configs'] if prefs and prefs['voice_configs'] else None\n-    print(f\"üìö Loaded voice configs from database: {list(voices.keys()) if voices else 'None (will use defaults)'}\")\n+    # @@@ Load voices from user's enabled decks (deck system)\n+    voices = database.load_voices_from_user_decks(user_id)\n+    print(f\"üìö Loaded {len(voices)} enabled voices from deck system: {list(voices.keys()) if voices else 'None (will use defaults)'}\")\n \n     agent = PolyAgent(id=\"voice-analyzer\")\n \n@@ -1307,6 +1304,16 @@ def fork_deck(deck_id: str, current_user: dict = Depends(get_current_user)):\n     except ValueError as e:\n         raise HTTPException(status_code=404, detail=str(e))\n \n+@app.post(\"/api/decks/{deck_id}/sync\")\n+def sync_deck(deck_id: str, current_user: dict = Depends(get_current_user)):\n+    \"\"\"Sync user's forked deck with parent template (force overwrites local changes)\"\"\"\n+    user_id = current_user['user_id']\n+    try:\n+        result = database.sync_deck_with_parent(user_id, deck_id, force=True)\n+        return result\n+    except ValueError as e:\n+        raise HTTPException(status_code=400, detail=str(e))\n+\n @app.post(\"/api/voices\")\n def create_voice(request: VoiceCreateRequest, current_user: dict = Depends(get_current_user)):\n     \"\"\"Create a new voice in a user deck\"\"\""
    },
    {
      "sha": "a5c857580e55150ef738a26cd98db0d3adc94c24",
      "filename": "frontend/src/api/voiceApi.ts",
      "status": "modified",
      "additions": 17,
      "deletions": 0,
      "changes": 17,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/7a8675a8e78764848a1ceb6eaa99aba33456ec21/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/7a8675a8e78764848a1ceb6eaa99aba33456ec21/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fapi%2FvoiceApi.ts?ref=7a8675a8e78764848a1ceb6eaa99aba33456ec21",
      "patch": "@@ -742,6 +742,23 @@ export async function forkDeck(deckId: string): Promise<{ deck_id: string }> {\n   return await response.json();\n }\n \n+/**\n+ * Sync deck with parent template (force overwrites local changes)\n+ */\n+export async function syncDeck(deckId: string): Promise<{ success: boolean; synced_voices: number }> {\n+  const response = await fetch(`${API_BASE}/api/decks/${deckId}/sync`, {\n+    method: 'POST',\n+    headers: getAuthHeaders()\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Sync deck failed');\n+  }\n+\n+  return await response.json();\n+}\n+\n /**\n  * Create a new voice in a deck\n  */"
    },
    {
      "sha": "8bb55e6dd64bcd42685ff35092f7911dc7f3fdbe",
      "filename": "frontend/src/components/DeckManager.tsx",
      "status": "modified",
      "additions": 68,
      "deletions": 24,
      "changes": 92,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/7a8675a8e78764848a1ceb6eaa99aba33456ec21/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/7a8675a8e78764848a1ceb6eaa99aba33456ec21/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx?ref=7a8675a8e78764848a1ceb6eaa99aba33456ec21",
      "patch": "@@ -6,6 +6,7 @@ import {\n   updateDeck,\n   deleteDeck,\n   forkDeck,\n+  syncDeck,\n   createVoice,\n   updateVoice,\n   deleteVoice,\n@@ -146,6 +147,19 @@ export default function DeckManager({ onUpdate }: Props) {\n     }\n   }\n \n+  async function handleSyncDeck(deckId: string) {\n+    if (!confirm('Sync with original template? This will overwrite any changes you made to this deck.')) return;\n+\n+    try {\n+      const result = await syncDeck(deckId);\n+      alert(`‚úÖ Synced ${result.synced_voices} voices with original template`);\n+      await loadDecks();\n+      onUpdate?.();\n+    } catch (err: any) {\n+      alert(`Failed to sync deck: ${err.message}`);\n+    }\n+  }\n+\n   async function handleToggleVoice(voiceId: string, currentEnabled: boolean) {\n     try {\n       await updateVoice(voiceId, { enabled: !currentEnabled });\n@@ -320,6 +334,7 @@ export default function DeckManager({ onUpdate }: Props) {\n                       color: '#2c2c2c',\n                       marginBottom: 4\n                     }}>\n+                      {console.log('üîç Rendering deck:', deck.name, 'order_index:', deck.order_index, 'full deck:', deck)}\n                       {deck.name}\n                       {isSystem && (\n                         <span style={{\n@@ -406,30 +421,59 @@ export default function DeckManager({ onUpdate }: Props) {\n                         Fork to My Collection\n                       </button>\n                     ) : (\n-                      <button\n-                        onClick={() => handleDeleteDeck(deck.id)}\n-                        style={{\n-                          padding: '8px 16px',\n-                          background: '#e74c3c',\n-                          color: '#fff',\n-                          border: 'none',\n-                          borderRadius: 6,\n-                          cursor: 'pointer',\n-                          fontSize: 13,\n-                          fontWeight: 600,\n-                          transition: 'all 0.2s'\n-                        }}\n-                        onMouseEnter={(e) => {\n-                          e.currentTarget.style.transform = 'translateY(-1px)';\n-                          e.currentTarget.style.boxShadow = '0 4px 12px rgba(231, 76, 60, 0.4)';\n-                        }}\n-                        onMouseLeave={(e) => {\n-                          e.currentTarget.style.transform = 'translateY(0)';\n-                          e.currentTarget.style.boxShadow = 'none';\n-                        }}\n-                      >\n-                        Delete Deck\n-                      </button>\n+                      <>\n+                        {/* @@@ Show sync button if deck has a parent */}\n+                        {deck.parent_id && (\n+                          <button\n+                            onClick={() => handleSyncDeck(deck.id)}\n+                            style={{\n+                              padding: '8px 16px',\n+                              background: '#3498db',\n+                              color: '#fff',\n+                              border: 'none',\n+                              borderRadius: 6,\n+                              cursor: 'pointer',\n+                              fontSize: 13,\n+                              fontWeight: 600,\n+                              transition: 'all 0.2s'\n+                            }}\n+                            onMouseEnter={(e) => {\n+                              e.currentTarget.style.transform = 'translateY(-1px)';\n+                              e.currentTarget.style.boxShadow = '0 4px 12px rgba(52, 152, 219, 0.4)';\n+                            }}\n+                            onMouseLeave={(e) => {\n+                              e.currentTarget.style.transform = 'translateY(0)';\n+                              e.currentTarget.style.boxShadow = 'none';\n+                            }}\n+                          >\n+                            Sync with Original\n+                          </button>\n+                        )}\n+                        <button\n+                          onClick={() => handleDeleteDeck(deck.id)}\n+                          style={{\n+                            padding: '8px 16px',\n+                            background: '#e74c3c',\n+                            color: '#fff',\n+                            border: 'none',\n+                            borderRadius: 6,\n+                            cursor: 'pointer',\n+                            fontSize: 13,\n+                            fontWeight: 600,\n+                            transition: 'all 0.2s'\n+                          }}\n+                          onMouseEnter={(e) => {\n+                            e.currentTarget.style.transform = 'translateY(-1px)';\n+                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(231, 76, 60, 0.4)';\n+                          }}\n+                          onMouseLeave={(e) => {\n+                            e.currentTarget.style.transform = 'translateY(0)';\n+                            e.currentTarget.style.boxShadow = 'none';\n+                          }}\n+                        >\n+                          Delete Deck\n+                        </button>\n+                      </>\n                     )}\n                   </div>\n                 </div>"
    }
  ]
}