{
  "sha": "1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
  "node_id": "C_kwDOP2Zrm9oAKDFjNzYwMjFkMGEzYzdhMmMwZjRjZmE0OTBjYjc1M2ZmZGQ1ZDgwZWY",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-02T05:51:10Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-02T05:51:10Z"
    },
    "message": "Add frontend authentication and localStorage migration\n\nFrontend changes:\n- Create AuthContext with JWT token management\n- Add login/register UI components\n- Wrap app with AuthProvider\n- Show auth screen for guests\n- Add localStorage â†’ database migration dialog on first login\n- Block image generation for non-authenticated users\n- Add auth headers to all authenticated API endpoints\n\nNew files:\n- frontend/src/contexts/AuthContext.tsx - Auth state management\n- frontend/src/components/Auth/LoginForm.tsx - Login form\n- frontend/src/components/Auth/RegisterForm.tsx - Register form\n\nModified files:\n- frontend/src/main.tsx - Wrap with AuthProvider\n- frontend/src/App.tsx - Add auth screens, migration dialog\n- frontend/src/api/voiceApi.ts - Add authenticated endpoints\n- frontend/src/components/CollectionsView.tsx - Block guest image gen\n\nFeatures:\n- Auto-verify JWT token on mount\n- 7-day token expiration\n- Migration prompt shows after login if localStorage data exists\n- Users can migrate or skip (sets flag to not show again)\n- Images now save to database when authenticated\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>",
    "tree": {
      "sha": "4ab080cf0beb5210450336a3e0170262676d08b3",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/4ab080cf0beb5210450336a3e0170262676d08b3"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "3de0a0c2093156f0c420724dbca83831d96bc879",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/3de0a0c2093156f0c420724dbca83831d96bc879",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/3de0a0c2093156f0c420724dbca83831d96bc879"
    }
  ],
  "stats": {
    "total": 1029,
    "additions": 1026,
    "deletions": 3
  },
  "files": [
    {
      "sha": "db3fcfe97b78aad78618d88efd934725040e4060",
      "filename": "frontend/src/App.tsx",
      "status": "modified",
      "additions": 233,
      "deletions": 1,
      "changes": 234,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2FApp.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2FApp.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "patch": "@@ -22,10 +22,13 @@ import ChatWidgetUI from './components/ChatWidgetUI';\n import StateChooser from './components/StateChooser';\n import type { VoiceConfig } from './types/voice';\n import { getVoices, getMetaPrompt, getStateConfig } from './utils/voiceStorage';\n-import { getDefaultVoices, chatWithVoice } from './api/voiceApi';\n+import { getDefaultVoices, chatWithVoice, importLocalData, generateDailyPicture, saveDailyPicture } from './api/voiceApi';\n import { useMobile } from './utils/mobileDetect';\n import { CommentGroupCard } from './components/CommentCard';\n import { findNormalizedPhrase } from './utils/textNormalize';\n+import { useAuth } from './contexts/AuthContext';\n+import LoginForm from './components/Auth/LoginForm';\n+import RegisterForm from './components/Auth/RegisterForm';\n \n // @@@ Left Toolbar Component - floating toolbelt within left margin\n function LeftToolbar({\n@@ -253,6 +256,13 @@ const colorMap: Record<string, { gradient: string; text: string; glow: string }>\n // @@@ Main App Component\n export default function App() {\n   const isMobile = useMobile();\n+  const { isAuthenticated, isLoading } = useAuth();\n+\n+  // @@@ Auth screen state\n+  const [authScreen, setAuthScreen] = useState<'login' | 'register'>('login');\n+  const [showMigrationDialog, setShowMigrationDialog] = useState(false);\n+  const [isMigrating, setIsMigrating] = useState(false);\n+\n   const [currentView, setCurrentView] = useState<'writing' | 'settings' | 'timeline' | 'analysis' | 'about'>('writing');\n   const [showCalendarPopup, setShowCalendarPopup] = useState(false);\n   const [voiceConfigs, setVoiceConfigs] = useState<Record<string, VoiceConfig>>({});\n@@ -347,6 +357,29 @@ export default function App() {\n     }\n   }, [currentView]);\n \n+  // @@@ Check for localStorage migration after login\n+  useEffect(() => {\n+    if (isAuthenticated && !isLoading) {\n+      // Check if user has localStorage data that needs migration\n+      const hasLocalData =\n+        localStorage.getItem('ink_memory_state') ||\n+        localStorage.getItem('calendarEntries') ||\n+        localStorage.getItem('dailyPictures') ||\n+        localStorage.getItem('voice-configs') ||\n+        localStorage.getItem('meta-prompt') ||\n+        localStorage.getItem('state-config') ||\n+        localStorage.getItem('selected-state') ||\n+        localStorage.getItem('analysisReports');\n+\n+      // Check if migration already done (flag stored after migration)\n+      const migrationDone = localStorage.getItem('migration_completed');\n+\n+      if (hasLocalData && !migrationDone) {\n+        setShowMigrationDialog(true);\n+      }\n+    }\n+  }, [isAuthenticated, isLoading]);\n+\n   // Initialize engine\n   useEffect(() => {\n     const sessionId = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString();\n@@ -797,6 +830,62 @@ export default function App() {\n     setCommentsAligned(prev => !prev);\n   }, []);\n \n+  // @@@ Handle localStorage migration\n+  const handleMigrateData = useCallback(async () => {\n+    setIsMigrating(true);\n+    try {\n+      // Export all localStorage data\n+      const migrationData = {\n+        currentSession: localStorage.getItem('ink_memory_state'),\n+        calendarEntries: localStorage.getItem('calendarEntries'),\n+        dailyPictures: localStorage.getItem('dailyPictures'),\n+        voiceCustomizations: localStorage.getItem('voice-configs'),\n+        metaPrompt: localStorage.getItem('meta-prompt'),\n+        stateConfig: localStorage.getItem('state-config'),\n+        selectedState: localStorage.getItem('selected-state'),\n+        analysisReports: localStorage.getItem('analysisReports'),\n+        oldDocument: localStorage.getItem('document')\n+      };\n+\n+      // Call backend migration endpoint\n+      const result = await importLocalData(migrationData);\n+\n+      console.log('âœ… Migration complete:', result.imported);\n+\n+      // Mark migration as complete\n+      localStorage.setItem('migration_completed', 'true');\n+\n+      // Clear old localStorage data (keep auth token and migration flag)\n+      const keysToKeep = ['auth_token', 'migration_completed'];\n+      const allKeys = Object.keys(localStorage);\n+      allKeys.forEach(key => {\n+        if (!keysToKeep.includes(key)) {\n+          localStorage.removeItem(key);\n+        }\n+      });\n+\n+      setShowMigrationDialog(false);\n+\n+      // Show success message\n+      alert(`Migration successful! Imported:\\n- ${result.imported.sessions} sessions\\n- ${result.imported.pictures} pictures\\n- ${result.imported.preferences} preferences\\n- ${result.imported.reports} reports`);\n+    } catch (error: any) {\n+      console.error('Migration failed:', error);\n+      alert(`Migration failed: ${error.message}\\n\\nYou can try again later from Settings.`);\n+    } finally {\n+      setIsMigrating(false);\n+    }\n+  }, []);\n+\n+  const handleSkipMigration = useCallback(() => {\n+    localStorage.setItem('migration_completed', 'true');\n+    setShowMigrationDialog(false);\n+  }, []);\n+\n+  const handleAuthSuccess = useCallback(() => {\n+    // After successful login/register, check for migration\n+    // This is handled by the useEffect hook above\n+  }, []);\n+\n   // @@@ Comment interaction handlers\n   const handleCommentStar = useCallback((commentId: string) => {\n     if (!engineRef.current) return;\n@@ -1067,6 +1156,49 @@ export default function App() {\n     return <div style={{ whiteSpace: 'pre-wrap' }}>{elements}</div>;\n   };\n \n+  // @@@ Show loading state while checking auth\n+  if (isLoading) {\n+    return (\n+      <div style={{\n+        display: 'flex',\n+        alignItems: 'center',\n+        justifyContent: 'center',\n+        height: '100vh',\n+        fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+        fontSize: '18px',\n+        color: '#666'\n+      }}>\n+        Loading...\n+      </div>\n+    );\n+  }\n+\n+  // @@@ Show auth screen if not authenticated\n+  if (!isAuthenticated) {\n+    return (\n+      <div style={{\n+        display: 'flex',\n+        alignItems: 'center',\n+        justifyContent: 'center',\n+        minHeight: '100vh',\n+        background: 'linear-gradient(135deg, #f5f0e8 0%, #e8dcc8 100%)',\n+        padding: '20px'\n+      }}>\n+        {authScreen === 'login' ? (\n+          <LoginForm\n+            onSuccess={handleAuthSuccess}\n+            onSwitchToRegister={() => setAuthScreen('register')}\n+          />\n+        ) : (\n+          <RegisterForm\n+            onSuccess={handleAuthSuccess}\n+            onSwitchToLogin={() => setAuthScreen('login')}\n+          />\n+        )}\n+      </div>\n+    );\n+  }\n+\n   if (!state || !engineRef.current) {\n     return <div>Loading...</div>;\n   }\n@@ -1079,6 +1211,106 @@ export default function App() {\n \n   return (\n     <>\n+      {/* @@@ Migration dialog */}\n+      {showMigrationDialog && (\n+        <div style={{\n+          position: 'fixed',\n+          top: 0,\n+          left: 0,\n+          right: 0,\n+          bottom: 0,\n+          backgroundColor: 'rgba(0, 0, 0, 0.7)',\n+          display: 'flex',\n+          alignItems: 'center',\n+          justifyContent: 'center',\n+          zIndex: 10000,\n+          padding: '20px'\n+        }}>\n+          <div style={{\n+            backgroundColor: '#fffef9',\n+            border: '2px solid #d0c4b0',\n+            borderRadius: '12px',\n+            padding: '32px',\n+            maxWidth: '500px',\n+            boxShadow: '0 8px 24px rgba(0, 0, 0, 0.3)',\n+            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+          }}>\n+            <h2 style={{\n+              margin: '0 0 16px 0',\n+              fontSize: '24px',\n+              color: '#333',\n+              fontWeight: 600\n+            }}>\n+              Migrate Your Data?\n+            </h2>\n+            <p style={{\n+              margin: '0 0 24px 0',\n+              fontSize: '16px',\n+              lineHeight: '1.6',\n+              color: '#555'\n+            }}>\n+              We found data in your browser. Would you like to migrate it to your account?\n+              This will move all your sessions, pictures, and preferences to the cloud.\n+            </p>\n+            <div style={{\n+              display: 'flex',\n+              gap: '12px',\n+              justifyContent: 'space-between'\n+            }}>\n+              <button\n+                onClick={handleMigrateData}\n+                disabled={isMigrating}\n+                style={{\n+                  flex: 1,\n+                  padding: '12px 20px',\n+                  border: 'none',\n+                  background: isMigrating ? '#ccc' : '#4a90e2',\n+                  borderRadius: '6px',\n+                  cursor: isMigrating ? 'not-allowed' : 'pointer',\n+                  fontSize: '16px',\n+                  fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+                  color: '#fff',\n+                  fontWeight: 600,\n+                  transition: 'all 0.2s'\n+                }}\n+                onMouseEnter={(e) => {\n+                  if (!isMigrating) e.currentTarget.style.backgroundColor = '#357abd';\n+                }}\n+                onMouseLeave={(e) => {\n+                  if (!isMigrating) e.currentTarget.style.backgroundColor = '#4a90e2';\n+                }}\n+              >\n+                {isMigrating ? 'Migrating...' : 'Migrate Data'}\n+              </button>\n+              <button\n+                onClick={handleSkipMigration}\n+                disabled={isMigrating}\n+                style={{\n+                  flex: 1,\n+                  padding: '12px 20px',\n+                  border: '1px solid #d0c4b0',\n+                  background: '#fff',\n+                  borderRadius: '6px',\n+                  cursor: isMigrating ? 'not-allowed' : 'pointer',\n+                  fontSize: '16px',\n+                  fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+                  color: '#666',\n+                  transition: 'all 0.2s'\n+                }}\n+                onMouseEnter={(e) => {\n+                  if (!isMigrating) e.currentTarget.style.backgroundColor = '#f5f5f5';\n+                }}\n+                onMouseLeave={(e) => {\n+                  if (!isMigrating) e.currentTarget.style.backgroundColor = '#fff';\n+                }}\n+              >\n+                Skip\n+              </button>\n+            </div>\n+          </div>\n+        </div>\n+      )}\n+\n       {/* @@@ Hide sidebar on mobile */}\n       {!isMobile && <LeftSidebar currentView={currentView} onViewChange={setCurrentView} />}\n "
    },
    {
      "sha": "9cec8c7a9e4843c52c37325d97588cb6cd3b8950",
      "filename": "frontend/src/api/voiceApi.ts",
      "status": "modified",
      "additions": 223,
      "deletions": 0,
      "changes": 223,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fapi%2FvoiceApi.ts?ref=1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "patch": "@@ -5,6 +5,20 @@\n // nginx proxies /ink-and-memory/api/* to backend (8765)\n const API_BASE = '/ink-and-memory';\n \n+/**\n+ * Get auth headers for authenticated requests\n+ */\n+function getAuthHeaders(): HeadersInit {\n+  const token = localStorage.getItem('auth_token');\n+  if (!token) {\n+    throw new Error('Not authenticated');\n+  }\n+  return {\n+    'Content-Type': 'application/json',\n+    'Authorization': `Bearer ${token}`\n+  };\n+}\n+\n /**\n  * Get default voices from backend\n  */\n@@ -203,3 +217,212 @@ export async function generateDailyPicture(allNotes: string): Promise<{ image_ba\n \n   throw new Error('Image generation failed - no image in response');\n }\n+\n+// ========== Authenticated Endpoints (require login) ==========\n+\n+/**\n+ * Import localStorage data to database (one-time migration)\n+ */\n+export async function importLocalData(data: {\n+  currentSession?: string;\n+  calendarEntries?: string;\n+  dailyPictures?: string;\n+  voiceCustomizations?: string;\n+  metaPrompt?: string;\n+  stateConfig?: string;\n+  selectedState?: string;\n+  analysisReports?: string;\n+  oldDocument?: string;\n+}): Promise<{ success: boolean; imported: any }> {\n+  const response = await fetch(`${API_BASE}/api/import-local-data`, {\n+    method: 'POST',\n+    headers: getAuthHeaders(),\n+    body: JSON.stringify(data)\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Import failed');\n+  }\n+\n+  return await response.json();\n+}\n+\n+/**\n+ * Save session to database\n+ */\n+export async function saveSession(sessionId: string, editorState: any, name?: string): Promise<void> {\n+  const response = await fetch(`${API_BASE}/api/sessions`, {\n+    method: 'POST',\n+    headers: getAuthHeaders(),\n+    body: JSON.stringify({\n+      session_id: sessionId,\n+      editor_state: editorState,\n+      name\n+    })\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Save session failed');\n+  }\n+}\n+\n+/**\n+ * List all sessions\n+ */\n+export async function listSessions(): Promise<any[]> {\n+  const response = await fetch(`${API_BASE}/api/sessions`, {\n+    headers: getAuthHeaders()\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'List sessions failed');\n+  }\n+\n+  const data = await response.json();\n+  return data.sessions;\n+}\n+\n+/**\n+ * Get a specific session\n+ */\n+export async function getSession(sessionId: string): Promise<any> {\n+  const response = await fetch(`${API_BASE}/api/sessions/${sessionId}`, {\n+    headers: getAuthHeaders()\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Get session failed');\n+  }\n+\n+  return await response.json();\n+}\n+\n+/**\n+ * Delete a session\n+ */\n+export async function deleteSession(sessionId: string): Promise<void> {\n+  const response = await fetch(`${API_BASE}/api/sessions/${sessionId}`, {\n+    method: 'DELETE',\n+    headers: getAuthHeaders()\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Delete session failed');\n+  }\n+}\n+\n+/**\n+ * Save daily picture\n+ */\n+export async function saveDailyPicture(date: string, imageBase64: string, prompt: string): Promise<void> {\n+  const response = await fetch(`${API_BASE}/api/pictures`, {\n+    method: 'POST',\n+    headers: getAuthHeaders(),\n+    body: JSON.stringify({\n+      date,\n+      image_base64: imageBase64,\n+      prompt\n+    })\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Save picture failed');\n+  }\n+}\n+\n+/**\n+ * Get daily pictures\n+ */\n+export async function getDailyPictures(limit: number = 30): Promise<any[]> {\n+  const response = await fetch(`${API_BASE}/api/pictures?limit=${limit}`, {\n+    headers: getAuthHeaders()\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Get pictures failed');\n+  }\n+\n+  const data = await response.json();\n+  return data.pictures;\n+}\n+\n+/**\n+ * Save user preferences\n+ */\n+export async function savePreferences(preferences: {\n+  voice_configs?: any;\n+  meta_prompt?: string;\n+  state_config?: any;\n+  selected_state?: string;\n+}): Promise<void> {\n+  const response = await fetch(`${API_BASE}/api/preferences`, {\n+    method: 'POST',\n+    headers: getAuthHeaders(),\n+    body: JSON.stringify(preferences)\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Save preferences failed');\n+  }\n+}\n+\n+/**\n+ * Get user preferences\n+ */\n+export async function getPreferences(): Promise<any> {\n+  const response = await fetch(`${API_BASE}/api/preferences`, {\n+    headers: getAuthHeaders()\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Get preferences failed');\n+  }\n+\n+  return await response.json();\n+}\n+\n+/**\n+ * Save analysis report\n+ */\n+export async function saveAnalysisReport(reportType: string, reportData: any, allNotesText?: string): Promise<void> {\n+  const response = await fetch(`${API_BASE}/api/reports`, {\n+    method: 'POST',\n+    headers: getAuthHeaders(),\n+    body: JSON.stringify({\n+      report_type: reportType,\n+      report_data: reportData,\n+      all_notes_text: allNotesText\n+    })\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Save report failed');\n+  }\n+}\n+\n+/**\n+ * Get analysis reports\n+ */\n+export async function getAnalysisReports(limit: number = 10): Promise<any[]> {\n+  const response = await fetch(`${API_BASE}/api/reports?limit=${limit}`, {\n+    headers: getAuthHeaders()\n+  });\n+\n+  if (!response.ok) {\n+    const error = await response.json();\n+    throw new Error(error.detail || 'Get reports failed');\n+  }\n+\n+  const data = await response.json();\n+  return data.reports;\n+}"
    },
    {
      "sha": "cda1a60f62f2e25dbe1e123606684c564ceb3f75",
      "filename": "frontend/src/components/Auth/LoginForm.tsx",
      "status": "added",
      "additions": 184,
      "deletions": 0,
      "changes": 184,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fcomponents%2FAuth%2FLoginForm.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fcomponents%2FAuth%2FLoginForm.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FAuth%2FLoginForm.tsx?ref=1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "patch": "@@ -0,0 +1,184 @@\n+/**\n+ * Login form component\n+ */\n+\n+import React, { useState } from 'react';\n+import { useAuth } from '../../contexts/AuthContext';\n+\n+interface LoginFormProps {\n+  onSuccess: () => void;\n+  onSwitchToRegister: () => void;\n+}\n+\n+export default function LoginForm({ onSuccess, onSwitchToRegister }: LoginFormProps) {\n+  const { login } = useAuth();\n+  const [email, setEmail] = useState('');\n+  const [password, setPassword] = useState('');\n+  const [error, setError] = useState('');\n+  const [isSubmitting, setIsSubmitting] = useState(false);\n+\n+  const handleSubmit = async (e: React.FormEvent) => {\n+    e.preventDefault();\n+    setError('');\n+    setIsSubmitting(true);\n+\n+    try {\n+      await login(email, password);\n+      onSuccess();\n+    } catch (err: any) {\n+      setError(err.message || 'Login failed');\n+    } finally {\n+      setIsSubmitting(false);\n+    }\n+  };\n+\n+  return (\n+    <div style={{\n+      width: '100%',\n+      maxWidth: '400px',\n+      margin: '0 auto',\n+      padding: '32px',\n+      backgroundColor: '#fffef9',\n+      border: '2px solid #d0c4b0',\n+      borderRadius: '12px',\n+      boxShadow: '0 4px 12px rgba(0,0,0,0.1)',\n+      fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+    }}>\n+      <h2 style={{\n+        margin: '0 0 24px 0',\n+        fontSize: '24px',\n+        fontWeight: 600,\n+        color: '#333',\n+        textAlign: 'center'\n+      }}>\n+        Welcome Back\n+      </h2>\n+\n+      {error && (\n+        <div style={{\n+          padding: '12px',\n+          marginBottom: '16px',\n+          backgroundColor: '#fee',\n+          border: '1px solid #fcc',\n+          borderRadius: '6px',\n+          fontSize: '14px',\n+          color: '#c33'\n+        }}>\n+          {error}\n+        </div>\n+      )}\n+\n+      <form onSubmit={handleSubmit}>\n+        <div style={{ marginBottom: '16px' }}>\n+          <label style={{\n+            display: 'block',\n+            marginBottom: '6px',\n+            fontSize: '14px',\n+            fontWeight: 500,\n+            color: '#555'\n+          }}>\n+            Email\n+          </label>\n+          <input\n+            type=\"email\"\n+            value={email}\n+            onChange={(e) => setEmail(e.target.value)}\n+            required\n+            disabled={isSubmitting}\n+            style={{\n+              width: '100%',\n+              padding: '10px 12px',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: '6px',\n+              fontSize: '15px',\n+              fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+              boxSizing: 'border-box'\n+            }}\n+          />\n+        </div>\n+\n+        <div style={{ marginBottom: '24px' }}>\n+          <label style={{\n+            display: 'block',\n+            marginBottom: '6px',\n+            fontSize: '14px',\n+            fontWeight: 500,\n+            color: '#555'\n+          }}>\n+            Password\n+          </label>\n+          <input\n+            type=\"password\"\n+            value={password}\n+            onChange={(e) => setPassword(e.target.value)}\n+            required\n+            disabled={isSubmitting}\n+            style={{\n+              width: '100%',\n+              padding: '10px 12px',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: '6px',\n+              fontSize: '15px',\n+              fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+              boxSizing: 'border-box'\n+            }}\n+          />\n+        </div>\n+\n+        <button\n+          type=\"submit\"\n+          disabled={isSubmitting}\n+          style={{\n+            width: '100%',\n+            padding: '12px',\n+            border: 'none',\n+            borderRadius: '6px',\n+            backgroundColor: isSubmitting ? '#ccc' : '#4a90e2',\n+            color: 'white',\n+            fontSize: '16px',\n+            fontWeight: 600,\n+            cursor: isSubmitting ? 'not-allowed' : 'pointer',\n+            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+            transition: 'background-color 0.2s'\n+          }}\n+          onMouseEnter={(e) => {\n+            if (!isSubmitting) {\n+              e.currentTarget.style.backgroundColor = '#357abd';\n+            }\n+          }}\n+          onMouseLeave={(e) => {\n+            if (!isSubmitting) {\n+              e.currentTarget.style.backgroundColor = '#4a90e2';\n+            }\n+          }}\n+        >\n+          {isSubmitting ? 'Logging in...' : 'Login'}\n+        </button>\n+      </form>\n+\n+      <div style={{\n+        marginTop: '20px',\n+        textAlign: 'center',\n+        fontSize: '14px',\n+        color: '#666'\n+      }}>\n+        Don't have an account?{' '}\n+        <button\n+          onClick={onSwitchToRegister}\n+          disabled={isSubmitting}\n+          style={{\n+            background: 'none',\n+            border: 'none',\n+            color: '#4a90e2',\n+            cursor: 'pointer',\n+            textDecoration: 'underline',\n+            fontSize: '14px',\n+            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+          }}\n+        >\n+          Register\n+        </button>\n+      </div>\n+    </div>\n+  );\n+}"
    },
    {
      "sha": "9ab307887df5279fd32deb93905e7fecff62614c",
      "filename": "frontend/src/components/Auth/RegisterForm.tsx",
      "status": "added",
      "additions": 225,
      "deletions": 0,
      "changes": 225,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fcomponents%2FAuth%2FRegisterForm.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fcomponents%2FAuth%2FRegisterForm.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FAuth%2FRegisterForm.tsx?ref=1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "patch": "@@ -0,0 +1,225 @@\n+/**\n+ * Registration form component\n+ */\n+\n+import React, { useState } from 'react';\n+import { useAuth } from '../../contexts/AuthContext';\n+\n+interface RegisterFormProps {\n+  onSuccess: () => void;\n+  onSwitchToLogin: () => void;\n+}\n+\n+export default function RegisterForm({ onSuccess, onSwitchToLogin }: RegisterFormProps) {\n+  const { register } = useAuth();\n+  const [email, setEmail] = useState('');\n+  const [password, setPassword] = useState('');\n+  const [displayName, setDisplayName] = useState('');\n+  const [error, setError] = useState('');\n+  const [isSubmitting, setIsSubmitting] = useState(false);\n+\n+  const handleSubmit = async (e: React.FormEvent) => {\n+    e.preventDefault();\n+    setError('');\n+\n+    if (password.length < 6) {\n+      setError('Password must be at least 6 characters');\n+      return;\n+    }\n+\n+    setIsSubmitting(true);\n+\n+    try {\n+      await register(email, password, displayName || undefined);\n+      onSuccess();\n+    } catch (err: any) {\n+      setError(err.message || 'Registration failed');\n+    } finally {\n+      setIsSubmitting(false);\n+    }\n+  };\n+\n+  return (\n+    <div style={{\n+      width: '100%',\n+      maxWidth: '400px',\n+      margin: '0 auto',\n+      padding: '32px',\n+      backgroundColor: '#fffef9',\n+      border: '2px solid #d0c4b0',\n+      borderRadius: '12px',\n+      boxShadow: '0 4px 12px rgba(0,0,0,0.1)',\n+      fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+    }}>\n+      <h2 style={{\n+        margin: '0 0 24px 0',\n+        fontSize: '24px',\n+        fontWeight: 600,\n+        color: '#333',\n+        textAlign: 'center'\n+      }}>\n+        Create Account\n+      </h2>\n+\n+      {error && (\n+        <div style={{\n+          padding: '12px',\n+          marginBottom: '16px',\n+          backgroundColor: '#fee',\n+          border: '1px solid #fcc',\n+          borderRadius: '6px',\n+          fontSize: '14px',\n+          color: '#c33'\n+        }}>\n+          {error}\n+        </div>\n+      )}\n+\n+      <form onSubmit={handleSubmit}>\n+        <div style={{ marginBottom: '16px' }}>\n+          <label style={{\n+            display: 'block',\n+            marginBottom: '6px',\n+            fontSize: '14px',\n+            fontWeight: 500,\n+            color: '#555'\n+          }}>\n+            Email\n+          </label>\n+          <input\n+            type=\"email\"\n+            value={email}\n+            onChange={(e) => setEmail(e.target.value)}\n+            required\n+            disabled={isSubmitting}\n+            style={{\n+              width: '100%',\n+              padding: '10px 12px',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: '6px',\n+              fontSize: '15px',\n+              fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+              boxSizing: 'border-box'\n+            }}\n+          />\n+        </div>\n+\n+        <div style={{ marginBottom: '16px' }}>\n+          <label style={{\n+            display: 'block',\n+            marginBottom: '6px',\n+            fontSize: '14px',\n+            fontWeight: 500,\n+            color: '#555'\n+          }}>\n+            Password\n+          </label>\n+          <input\n+            type=\"password\"\n+            value={password}\n+            onChange={(e) => setPassword(e.target.value)}\n+            required\n+            disabled={isSubmitting}\n+            style={{\n+              width: '100%',\n+              padding: '10px 12px',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: '6px',\n+              fontSize: '15px',\n+              fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+              boxSizing: 'border-box'\n+            }}\n+          />\n+          <div style={{\n+            marginTop: '4px',\n+            fontSize: '12px',\n+            color: '#888'\n+          }}>\n+            At least 6 characters\n+          </div>\n+        </div>\n+\n+        <div style={{ marginBottom: '24px' }}>\n+          <label style={{\n+            display: 'block',\n+            marginBottom: '6px',\n+            fontSize: '14px',\n+            fontWeight: 500,\n+            color: '#555'\n+          }}>\n+            Display Name (Optional)\n+          </label>\n+          <input\n+            type=\"text\"\n+            value={displayName}\n+            onChange={(e) => setDisplayName(e.target.value)}\n+            disabled={isSubmitting}\n+            style={{\n+              width: '100%',\n+              padding: '10px 12px',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: '6px',\n+              fontSize: '15px',\n+              fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+              boxSizing: 'border-box'\n+            }}\n+          />\n+        </div>\n+\n+        <button\n+          type=\"submit\"\n+          disabled={isSubmitting}\n+          style={{\n+            width: '100%',\n+            padding: '12px',\n+            border: 'none',\n+            borderRadius: '6px',\n+            backgroundColor: isSubmitting ? '#ccc' : '#4a90e2',\n+            color: 'white',\n+            fontSize: '16px',\n+            fontWeight: 600,\n+            cursor: isSubmitting ? 'not-allowed' : 'pointer',\n+            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\",\n+            transition: 'background-color 0.2s'\n+          }}\n+          onMouseEnter={(e) => {\n+            if (!isSubmitting) {\n+              e.currentTarget.style.backgroundColor = '#357abd';\n+            }\n+          }}\n+          onMouseLeave={(e) => {\n+            if (!isSubmitting) {\n+              e.currentTarget.style.backgroundColor = '#4a90e2';\n+            }\n+          }}\n+        >\n+          {isSubmitting ? 'Creating account...' : 'Register'}\n+        </button>\n+      </form>\n+\n+      <div style={{\n+        marginTop: '20px',\n+        textAlign: 'center',\n+        fontSize: '14px',\n+        color: '#666'\n+      }}>\n+        Already have an account?{' '}\n+        <button\n+          onClick={onSwitchToLogin}\n+          disabled={isSubmitting}\n+          style={{\n+            background: 'none',\n+            border: 'none',\n+            color: '#4a90e2',\n+            cursor: 'pointer',\n+            textDecoration: 'underline',\n+            fontSize: '14px',\n+            fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+          }}\n+        >\n+          Login\n+        </button>\n+      </div>\n+    </div>\n+  );\n+}"
    },
    {
      "sha": "5425587e21a56e9706b96ba16ece3831f61a0a11",
      "filename": "frontend/src/components/CollectionsView.tsx",
      "status": "modified",
      "additions": 13,
      "deletions": 1,
      "changes": 14,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FCollectionsView.tsx?ref=1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "patch": "@@ -1,6 +1,7 @@\n import { useState, useEffect, useRef } from 'react';\n import type { Commentor } from '../engine/EditorEngine';\n import { findNormalizedPhrase } from '../utils/textNormalize';\n+import { useAuth } from '../contexts/AuthContext';\n \n // @@@ TypeScript interfaces\n interface TimelineDay {\n@@ -184,6 +185,7 @@ function getAllNotesFromSessions(): string {\n \n // @@@ Timeline page - combines pictures and starred comments by date\n function TimelinePage() {\n+  const { isAuthenticated } = useAuth();\n   const [starredComments, setStarredComments] = useState<Commentor[]>([]);\n   const [pictures, setPictures] = useState<Array<{ date: string; base64: string; prompt: string }>>([]);\n   const [generatingForDate, setGeneratingForDate] = useState<string | null>(null);\n@@ -259,6 +261,12 @@ function TimelinePage() {\n   }, []);\n \n   const handleGenerateForDate = async (dateStr: string) => {\n+    // @@@ Block image generation for guests\n+    if (!isAuthenticated) {\n+      alert('Please log in to generate images. Image generation requires authentication.');\n+      return;\n+    }\n+\n     setGeneratingForDate(dateStr);\n \n     try {\n@@ -268,7 +276,7 @@ function TimelinePage() {\n         return;\n       }\n \n-      const { generateDailyPicture } = await import('../api/voiceApi');\n+      const { generateDailyPicture, saveDailyPicture } = await import('../api/voiceApi');\n       const { image_base64, prompt } = await generateDailyPicture(allNotes);\n \n       const newPicture = {\n@@ -277,6 +285,10 @@ function TimelinePage() {\n         prompt: prompt\n       };\n \n+      // @@@ Save to database (requires auth)\n+      const pictureDate = new Date(newPicture.date).toISOString().split('T')[0]; // YYYY-MM-DD format\n+      await saveDailyPicture(pictureDate, image_base64, prompt);\n+\n       // @@@ Overwrite existing picture for this date instead of adding new\n       const normalizedNewDate = formatDate(newPicture.date);\n "
    },
    {
      "sha": "d1b3a32ca15bfd586b00bba2a914f3ebe3558815",
      "filename": "frontend/src/contexts/AuthContext.tsx",
      "status": "added",
      "additions": 144,
      "deletions": 0,
      "changes": 144,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fcontexts%2FAuthContext.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fcontexts%2FAuthContext.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcontexts%2FAuthContext.tsx?ref=1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "patch": "@@ -0,0 +1,144 @@\n+/**\n+ * Authentication context and hooks\n+ *\n+ * Manages JWT token storage, user state, and auth operations\n+ */\n+\n+import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';\n+\n+const API_BASE = '/ink-and-memory';\n+\n+interface User {\n+  id: number;\n+  email: string;\n+  display_name?: string;\n+}\n+\n+interface AuthContextType {\n+  user: User | null;\n+  token: string | null;\n+  isLoading: boolean;\n+  login: (email: string, password: string) => Promise<void>;\n+  register: (email: string, password: string, displayName?: string) => Promise<void>;\n+  logout: () => void;\n+  isAuthenticated: boolean;\n+}\n+\n+const AuthContext = createContext<AuthContextType | undefined>(undefined);\n+\n+export function AuthProvider({ children }: { children: ReactNode }) {\n+  const [user, setUser] = useState<User | null>(null);\n+  const [token, setToken] = useState<string | null>(null);\n+  const [isLoading, setIsLoading] = useState(true);\n+\n+  // Load token from localStorage on mount\n+  useEffect(() => {\n+    const savedToken = localStorage.getItem('auth_token');\n+    if (savedToken) {\n+      // Verify token by fetching user info\n+      fetch(`${API_BASE}/api/me`, {\n+        headers: {\n+          'Authorization': `Bearer ${savedToken}`\n+        }\n+      })\n+        .then(res => {\n+          if (!res.ok) throw new Error('Token invalid');\n+          return res.json();\n+        })\n+        .then(userData => {\n+          setUser(userData);\n+          setToken(savedToken);\n+        })\n+        .catch(() => {\n+          // Token invalid, clear it\n+          localStorage.removeItem('auth_token');\n+        })\n+        .finally(() => {\n+          setIsLoading(false);\n+        });\n+    } else {\n+      setIsLoading(false);\n+    }\n+  }, []);\n+\n+  const login = async (email: string, password: string) => {\n+    const response = await fetch(`${API_BASE}/api/login`, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json'\n+      },\n+      body: JSON.stringify({ email, password })\n+    });\n+\n+    if (!response.ok) {\n+      const error = await response.json();\n+      throw new Error(error.detail || 'Login failed');\n+    }\n+\n+    const data = await response.json();\n+    setUser(data.user);\n+    setToken(data.token);\n+    localStorage.setItem('auth_token', data.token);\n+  };\n+\n+  const register = async (email: string, password: string, displayName?: string) => {\n+    const response = await fetch(`${API_BASE}/api/register`, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json'\n+      },\n+      body: JSON.stringify({\n+        email,\n+        password,\n+        display_name: displayName\n+      })\n+    });\n+\n+    if (!response.ok) {\n+      const error = await response.json();\n+      throw new Error(error.detail || 'Registration failed');\n+    }\n+\n+    const data = await response.json();\n+    setUser(data.user);\n+    setToken(data.token);\n+    localStorage.setItem('auth_token', data.token);\n+  };\n+\n+  const logout = () => {\n+    setUser(null);\n+    setToken(null);\n+    localStorage.removeItem('auth_token');\n+  };\n+\n+  return (\n+    <AuthContext.Provider\n+      value={{\n+        user,\n+        token,\n+        isLoading,\n+        login,\n+        register,\n+        logout,\n+        isAuthenticated: !!user && !!token\n+      }}\n+    >\n+      {children}\n+    </AuthContext.Provider>\n+  );\n+}\n+\n+export function useAuth() {\n+  const context = useContext(AuthContext);\n+  if (context === undefined) {\n+    throw new Error('useAuth must be used within AuthProvider');\n+  }\n+  return context;\n+}\n+\n+/**\n+ * Get current auth token for API calls\n+ */\n+export function getAuthToken(): string | null {\n+  return localStorage.getItem('auth_token');\n+}"
    },
    {
      "sha": "03529f434cf14e9ce01eb440dae21f537fc2fa39",
      "filename": "frontend/src/main.tsx",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fmain.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef/frontend%2Fsrc%2Fmain.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fmain.tsx?ref=1c76021d0a3c7a2c0f4cfa490cb753ffdd5d80ef",
      "patch": "@@ -2,9 +2,12 @@ import { StrictMode } from 'react'\n import { createRoot } from 'react-dom/client'\n import './index.css'\n import App from './App.tsx'\n+import { AuthProvider } from './contexts/AuthContext'\n \n createRoot(document.getElementById('root')!).render(\n   <StrictMode>\n-    <App />\n+    <AuthProvider>\n+      <App />\n+    </AuthProvider>\n   </StrictMode>,\n )"
    }
  ]
}