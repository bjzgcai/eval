{
  "sha": "0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
  "node_id": "C_kwDOP2Zrm9oAKDBiOWM4YTRhOWU0ZDdhMjhlYmMxMmFmOGU5ZjZhYzBmZmJlMWJhM2M",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-17T03:20:38Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-11-17T03:20:38Z"
    },
    "message": "Implement auto-fork system for deck templates\n\n- Add has_local_changes field to track fork modifications\n- Users now automatically get forked copies of system decks on signup/login\n- Remove system deck visibility - users only see their own forked copies\n- Update functions mark content changes (name, description, prompts) as local_changes\n- Preference changes (enabled, order) don't trigger has_local_changes flag\n- Fix database deadlock in auto_fork_system_decks\n- Add deck/voice enable/disable toggle UI\n- Update App.tsx to reload voices after deck/voice updates\n\nBreaking change: Users no longer see system decks directly\nPrepares for future deck store with upstream sync mechanism",
    "tree": {
      "sha": "237e32bacd9f505a42b51bacc8af8be959fac6ac",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/237e32bacd9f505a42b51bacc8af8be959fac6ac"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "dca7234449c4c380dcf332ea6cc9677016a65888",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/dca7234449c4c380dcf332ea6cc9677016a65888",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/dca7234449c4c380dcf332ea6cc9677016a65888"
    }
  ],
  "stats": {
    "total": 207,
    "additions": 173,
    "deletions": 34
  },
  "files": [
    {
      "sha": "8326b41b7b9195a9362b42d2a303804ddf163bb8",
      "filename": "backend/database.py",
      "status": "modified",
      "additions": 77,
      "deletions": 30,
      "changes": 107,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/backend%2Fdatabase.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/backend%2Fdatabase.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fdatabase.py?ref=0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
      "patch": "@@ -144,6 +144,7 @@ def create_tables(db):\n       parent_id TEXT,\n       owner_id INTEGER,\n       enabled BOOLEAN DEFAULT 1,\n+      has_local_changes BOOLEAN DEFAULT 0,\n       order_index INTEGER,\n       created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n       updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n@@ -168,6 +169,7 @@ def create_tables(db):\n       parent_id TEXT,\n       owner_id INTEGER,\n       enabled BOOLEAN DEFAULT 1,\n+      has_local_changes BOOLEAN DEFAULT 0,\n       order_index INTEGER,\n       created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n       updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n@@ -196,11 +198,11 @@ def seed_system_decks():\n \n     # ========== Deck 1: Introspection Deck ==========\n     db.execute(\"\"\"\n-    INSERT INTO decks (id, name, name_zh, name_en, description, description_zh, description_en, icon, color, is_system, enabled, order_index)\n-    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n+    INSERT INTO decks (id, name, name_zh, name_en, description, description_zh, description_en, icon, color, is_system, enabled, has_local_changes, order_index)\n+    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n     \"\"\", ('introspection_deck', '内省卡组', '内省卡组', 'Introspection Deck',\n           '内心对话原型', '内心对话原型', 'Inner dialogue archetypes',\n-          'brain', 'purple', 1, 1, 0))\n+          'brain', 'purple', 1, 1, 0, 0))\n \n     # Import config to get existing voice prompts\n     import config\n@@ -223,17 +225,17 @@ def seed_system_decks():\n \n     for voice_id, name, name_zh, name_en, prompt, icon, color, order in introspection_voices:\n         db.execute(\"\"\"\n-        INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt, icon, color, is_system, enabled, order_index)\n-        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n+        INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt, icon, color, is_system, enabled, has_local_changes, order_index)\n+        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?)\n         \"\"\", (voice_id, 'introspection_deck', name, name_zh, name_en, prompt, icon, color, 1, 1, order))\n \n     # ========== Deck 2: Scholar Deck ==========\n     db.execute(\"\"\"\n-    INSERT INTO decks (id, name, name_zh, name_en, description, description_zh, description_en, icon, color, is_system, enabled, order_index)\n-    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n+    INSERT INTO decks (id, name, name_zh, name_en, description, description_zh, description_en, icon, color, is_system, enabled, has_local_changes, order_index)\n+    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n     \"\"\", ('scholar_deck', '学者卡组', '学者卡组', 'Scholar Deck',\n           '从学术角度分析思考', '从学术角度分析思考', 'Analyze from academic perspectives',\n-          'lightbulb', 'blue', 1, 1, 1))\n+          'lightbulb', 'blue', 1, 1, 0, 1))\n \n     # Scholar voices (placeholder prompts - TODO: write detailed prompts)\n     scholar_voices = [\n@@ -253,17 +255,17 @@ def seed_system_decks():\n \n     for voice_id, name, name_zh, name_en, prompt, icon, color, order in scholar_voices:\n         db.execute(\"\"\"\n-        INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt, icon, color, is_system, enabled, order_index)\n-        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n+        INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt, icon, color, is_system, enabled, has_local_changes, order_index)\n+        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?)\n         \"\"\", (voice_id, 'scholar_deck', name, name_zh, name_en, prompt, icon, color, 1, 1, order))\n \n     # ========== Deck 3: Philosophy Deck ==========\n     db.execute(\"\"\"\n-    INSERT INTO decks (id, name, name_zh, name_en, description, description_zh, description_en, icon, color, is_system, enabled, order_index)\n-    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n+    INSERT INTO decks (id, name, name_zh, name_en, description, description_zh, description_en, icon, color, is_system, enabled, has_local_changes, order_index)\n+    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n     \"\"\", ('philosophy_deck', '哲学卡组', '哲学卡组', 'Philosophy Deck',\n           '不同哲学流派的审视', '不同哲学流派的审视', 'Examine through philosophical lenses',\n-          'cloud', 'purple', 1, 1, 2))\n+          'cloud', 'purple', 1, 1, 0, 2))\n \n     # Philosophy voices (placeholder prompts - TODO: write detailed prompts)\n     philosophy_voices = [\n@@ -279,8 +281,8 @@ def seed_system_decks():\n \n     for voice_id, name, name_zh, name_en, prompt, icon, color, order in philosophy_voices:\n         db.execute(\"\"\"\n-        INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt, icon, color, is_system, enabled, order_index)\n-        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n+        INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt, icon, color, is_system, enabled, has_local_changes, order_index)\n+        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?)\n         \"\"\", (voice_id, 'philosophy_deck', name, name_zh, name_en, prompt, icon, color, 1, 1, order))\n \n     db.commit()\n@@ -291,16 +293,18 @@ def seed_system_decks():\n \n def get_user_decks(user_id: int):\n     \"\"\"\n-    Get all decks visible to user (system decks + user's own decks).\n+    Get all user's own decks (forked from system templates).\n     Returns list of deck dicts with voice counts.\n+\n+    @@@ Users only see their own forked copies, never system decks directly\n     \"\"\"\n     db = get_db()\n     try:\n         rows = db.execute(\"\"\"\n         SELECT d.*, COUNT(v.id) as voice_count\n         FROM decks d\n         LEFT JOIN voices v ON d.id = v.deck_id AND v.enabled = 1\n-        WHERE d.is_system = 1 OR d.owner_id = ?\n+        WHERE d.owner_id = ?\n         GROUP BY d.id\n         ORDER BY d.order_index, d.created_at\n         \"\"\", (user_id,)).fetchall()\n@@ -311,14 +315,16 @@ def get_user_decks(user_id: int):\n def get_deck_with_voices(user_id: int, deck_id: str):\n     \"\"\"\n     Get full deck details with all voices.\n-    Returns None if deck doesn't exist or user doesn't have access.\n+    Returns None if deck doesn't exist or user doesn't own it.\n+\n+    @@@ Users only access their own forked decks\n     \"\"\"\n     db = get_db()\n     try:\n-        # Get deck\n+        # Get deck (must be user's own)\n         deck_row = db.execute(\"\"\"\n         SELECT * FROM decks\n-        WHERE id = ? AND (is_system = 1 OR owner_id = ?)\n+        WHERE id = ? AND owner_id = ?\n         \"\"\", (deck_id, user_id)).fetchone()\n \n         if not deck_row:\n@@ -362,8 +368,8 @@ def create_deck(user_id: int, name: str, description: str = None,\n \n         db.execute(\"\"\"\n         INSERT INTO decks (id, name, name_zh, name_en, description, description_zh, description_en,\n-                          icon, color, is_system, owner_id, enabled, order_index)\n-        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, 1, ?)\n+                          icon, color, is_system, owner_id, enabled, has_local_changes, order_index)\n+        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, 1, 0, ?)\n         \"\"\", (deck_id, name, name_zh, name_en, description, description_zh, description_en,\n               icon, color, user_id, order_index))\n \n@@ -379,6 +385,9 @@ def update_deck(user_id: int, deck_id: str, updates: dict) -> bool:\n \n     Updates dict can contain: name, name_zh, name_en, description, description_zh,\n     description_en, icon, color, enabled, order_index\n+\n+    @@@ Content changes (name, description, icon, color) → has_local_changes = 1\n+    @@@ Preference changes (enabled, order_index) → don't affect has_local_changes\n     \"\"\"\n     db = get_db()\n     try:\n@@ -394,6 +403,8 @@ def update_deck(user_id: int, deck_id: str, updates: dict) -> bool:\n         # Build update query\n         allowed_fields = ['name', 'name_zh', 'name_en', 'description', 'description_zh',\n                          'description_en', 'icon', 'color', 'enabled', 'order_index']\n+        content_fields = ['name', 'name_zh', 'name_en', 'description', 'description_zh',\n+                         'description_en', 'icon', 'color']\n \n         update_fields = []\n         params = []\n@@ -405,6 +416,11 @@ def update_deck(user_id: int, deck_id: str, updates: dict) -> bool:\n         if not update_fields:\n             return True  # No updates\n \n+        # @@@ Mark as locally changed if content fields are modified\n+        has_content_change = any(field in updates for field in content_fields)\n+        if has_content_change:\n+            update_fields.append(\"has_local_changes = 1\")\n+\n         update_fields.append(\"updated_at = CURRENT_TIMESTAMP\")\n         params.append(deck_id)\n \n@@ -440,9 +456,30 @@ def delete_deck(user_id: int, deck_id: str) -> bool:\n     finally:\n         db.close()\n \n+def auto_fork_system_decks(user_id: int):\n+    \"\"\"\n+    Auto-fork all system decks for a new user.\n+    Called on user registration/first login.\n+    \"\"\"\n+    # @@@ Get deck list then close connection BEFORE forking (avoid deadlock)\n+    db = get_db()\n+    try:\n+        system_decks = db.execute(\n+            \"SELECT id FROM decks WHERE is_system = 1 ORDER BY order_index\"\n+        ).fetchall()\n+        deck_ids = [deck['id'] for deck in system_decks]\n+    finally:\n+        db.close()\n+\n+    # Fork each deck (each fork opens its own connection)\n+    for deck_id in deck_ids:\n+        fork_deck(user_id, deck_id)\n+\n+    print(f\"✅ Auto-forked {len(deck_ids)} system decks for user {user_id}\")\n+\n def fork_deck(user_id: int, deck_id: str) -> str:\n     \"\"\"\n-    Fork a deck (usually system deck) to create user's own copy.\n+    Fork a deck to create user's own copy.\n     Copies deck + all voices. Returns new deck_id.\n     \"\"\"\n     import uuid\n@@ -457,11 +494,11 @@ def fork_deck(user_id: int, deck_id: str) -> str:\n         # Create new deck ID\n         new_deck_id = str(uuid.uuid4())\n \n-        # Copy deck\n+        # Copy deck (has_local_changes = 0 initially, synced with parent)\n         db.execute(\"\"\"\n         INSERT INTO decks (id, name, name_zh, name_en, description, description_zh, description_en,\n-                          icon, color, is_system, parent_id, owner_id, enabled, order_index)\n-        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, 1, ?)\n+                          icon, color, is_system, parent_id, owner_id, enabled, has_local_changes, order_index)\n+        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, 1, 0, ?)\n         \"\"\", (new_deck_id,\n               source_deck['name'],\n               source_deck['name_zh'],\n@@ -485,8 +522,8 @@ def fork_deck(user_id: int, deck_id: str) -> str:\n             new_voice_id = str(uuid.uuid4())\n             db.execute(\"\"\"\n             INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt,\n-                              icon, color, is_system, parent_id, owner_id, enabled, order_index)\n-            VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, 1, ?)\n+                              icon, color, is_system, parent_id, owner_id, enabled, has_local_changes, order_index)\n+            VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, 1, 0, ?)\n             \"\"\", (new_voice_id,\n                   new_deck_id,\n                   voice['name'],\n@@ -539,8 +576,8 @@ def create_voice(user_id: int, deck_id: str, name: str, system_prompt: str,\n \n         db.execute(\"\"\"\n         INSERT INTO voices (id, deck_id, name, name_zh, name_en, system_prompt,\n-                           icon, color, is_system, owner_id, enabled, order_index)\n-        VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, ?, 1, ?)\n+                           icon, color, is_system, owner_id, enabled, has_local_changes, order_index)\n+        VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, ?, 1, 0, ?)\n         \"\"\", (voice_id, deck_id, name, name_zh, name_en, system_prompt,\n               icon, color, user_id, order_index))\n \n@@ -556,6 +593,9 @@ def update_voice(user_id: int, voice_id: str, updates: dict) -> bool:\n \n     Updates dict can contain: name, name_zh, name_en, system_prompt,\n     icon, color, enabled, order_index\n+\n+    @@@ Content changes (name, system_prompt, icon, color) → has_local_changes = 1\n+    @@@ Preference changes (enabled, order_index) → don't affect has_local_changes\n     \"\"\"\n     db = get_db()\n     try:\n@@ -571,6 +611,8 @@ def update_voice(user_id: int, voice_id: str, updates: dict) -> bool:\n         # Build update query\n         allowed_fields = ['name', 'name_zh', 'name_en', 'system_prompt',\n                          'icon', 'color', 'enabled', 'order_index']\n+        content_fields = ['name', 'name_zh', 'name_en', 'system_prompt',\n+                         'icon', 'color']\n \n         update_fields = []\n         params = []\n@@ -582,6 +624,11 @@ def update_voice(user_id: int, voice_id: str, updates: dict) -> bool:\n         if not update_fields:\n             return True  # No updates\n \n+        # @@@ Mark as locally changed if content fields are modified\n+        has_content_change = any(field in updates for field in content_fields)\n+        if has_content_change:\n+            update_fields.append(\"has_local_changes = 1\")\n+\n         update_fields.append(\"updated_at = CURRENT_TIMESTAMP\")\n         params.append(voice_id)\n "
    },
    {
      "sha": "4a2d3e9d388ac1bdf6818b9631eacd5f70c0e11d",
      "filename": "backend/server.py",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/backend%2Fserver.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/backend%2Fserver.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
      "patch": "@@ -739,6 +739,9 @@ def register(request: RegisterRequest):\n     except ValueError as e:\n         raise HTTPException(status_code=400, detail=str(e))\n \n+    # @@@ Auto-fork all system decks for new user\n+    database.auto_fork_system_decks(user_id)\n+\n     # Generate token\n     token = auth.create_access_token(user_id, request.email)\n \n@@ -767,6 +770,11 @@ def login(request: LoginRequest):\n     if not auth.verify_password(request.password, user['password_hash']):\n         raise HTTPException(status_code=401, detail=\"Invalid email or password\")\n \n+    # @@@ Auto-fork system decks if user has no decks yet (handles existing users)\n+    user_decks = database.get_user_decks(user['id'])\n+    if len(user_decks) == 0:\n+        database.auto_fork_system_decks(user['id'])\n+\n     # Generate token\n     token = auth.create_access_token(user['id'], user['email'])\n "
    },
    {
      "sha": "ae7c8002be1a07bd4133a3a681cbacdadae256b9",
      "filename": "frontend/src/App.tsx",
      "status": "modified",
      "additions": 11,
      "deletions": 3,
      "changes": 14,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/frontend%2Fsrc%2FApp.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/frontend%2Fsrc%2FApp.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
      "patch": "@@ -2311,9 +2311,17 @@ export default function App() {\n           display: 'flex',\n           overflow: 'hidden'\n         }}>\n-          <DeckManager onUpdate={() => {\n-            // Reload voice configs when decks/voices are updated\n-            console.log('Deck system updated, reloading...');\n+          <DeckManager onUpdate={async () => {\n+            // @@@ Reload voice configs from deck system\n+            console.log('Deck system updated, reloading voices...');\n+            const updatedVoices = await loadVoicesFromDecks();\n+            setVoiceConfigs(updatedVoices);\n+\n+            if (engineRef.current) {\n+              engineRef.current.setVoiceConfigs(updatedVoices);\n+            }\n+\n+            console.log(`✅ Loaded ${Object.keys(updatedVoices).length} enabled voices`);\n           }} />\n         </div>\n       )}"
    },
    {
      "sha": "f33003efc3a0c1360964be4a4ab2ed48f5469c4b",
      "filename": "frontend/src/components/DeckManager.tsx",
      "status": "modified",
      "additions": 77,
      "deletions": 1,
      "changes": 78,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FDeckManager.tsx?ref=0b9c8a4a9e4d7a28ebc12af8e9f6ac0ffbe1ba3c",
      "patch": "@@ -124,6 +124,16 @@ export default function DeckManager({ onUpdate }: Props) {\n     }\n   }\n \n+  async function handleToggleDeck(deckId: string, currentEnabled: boolean) {\n+    try {\n+      await updateDeck(deckId, { enabled: !currentEnabled });\n+      await loadDecks();\n+      onUpdate?.();\n+    } catch (err: any) {\n+      alert(`Failed to toggle deck: ${err.message}`);\n+    }\n+  }\n+\n   async function handleDeleteDeck(deckId: string) {\n     if (!confirm('Delete this deck and all its voices?')) return;\n \n@@ -136,6 +146,16 @@ export default function DeckManager({ onUpdate }: Props) {\n     }\n   }\n \n+  async function handleToggleVoice(voiceId: string, currentEnabled: boolean) {\n+    try {\n+      await updateVoice(voiceId, { enabled: !currentEnabled });\n+      await loadDecks();\n+      onUpdate?.();\n+    } catch (err: any) {\n+      alert(`Failed to toggle voice: ${err.message}`);\n+    }\n+  }\n+\n   async function handleUpdateVoice(voiceId: string, data: Partial<Voice>) {\n     try {\n       await updateVoice(voiceId, data);\n@@ -331,7 +351,35 @@ export default function DeckManager({ onUpdate }: Props) {\n                   </div>\n \n                   {/* Actions */}\n-                  <div style={{ display: 'flex', gap: 8 }} onClick={(e) => e.stopPropagation()}>\n+                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }} onClick={(e) => e.stopPropagation()}>\n+                    {/* @@@ Deck-level toggle switch */}\n+                    <div\n+                      onClick={() => handleToggleDeck(deck.id, deck.enabled)}\n+                      style={{\n+                        width: 50,\n+                        height: 26,\n+                        borderRadius: 13,\n+                        background: deck.enabled ? colorHex : '#ccc',\n+                        position: 'relative',\n+                        cursor: 'pointer',\n+                        transition: 'background 0.3s',\n+                        flexShrink: 0\n+                      }}\n+                      title={deck.enabled ? 'Disable deck' : 'Enable deck'}\n+                    >\n+                      <div style={{\n+                        position: 'absolute',\n+                        top: 3,\n+                        left: deck.enabled ? 26 : 3,\n+                        width: 20,\n+                        height: 20,\n+                        borderRadius: 10,\n+                        background: '#fff',\n+                        transition: 'left 0.3s',\n+                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)'\n+                      }} />\n+                    </div>\n+\n                     {isSystem ? (\n                       <button\n                         onClick={() => handleForkDeck(deck.id)}\n@@ -442,6 +490,34 @@ export default function DeckManager({ onUpdate }: Props) {\n                                 </div>\n                               </div>\n \n+                              {/* @@@ Voice-level toggle switch */}\n+                              <div\n+                                onClick={() => handleToggleVoice(voice.id, voice.enabled)}\n+                                style={{\n+                                  width: 40,\n+                                  height: 22,\n+                                  borderRadius: 11,\n+                                  background: voice.enabled ? voiceColor : '#ccc',\n+                                  position: 'relative',\n+                                  cursor: 'pointer',\n+                                  transition: 'background 0.3s',\n+                                  flexShrink: 0\n+                                }}\n+                                title={voice.enabled ? 'Disable voice' : 'Enable voice'}\n+                              >\n+                                <div style={{\n+                                  position: 'absolute',\n+                                  top: 3,\n+                                  left: voice.enabled ? 21 : 3,\n+                                  width: 16,\n+                                  height: 16,\n+                                  borderRadius: 8,\n+                                  background: '#fff',\n+                                  transition: 'left 0.3s',\n+                                  boxShadow: '0 2px 4px rgba(0,0,0,0.2)'\n+                                }} />\n+                              </div>\n+\n                               {!isSystem && (\n                                 <button\n                                   onClick={() => handleDeleteVoice(voice.id)}"
    }
  ]
}