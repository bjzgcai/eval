{
  "sha": "3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
  "node_id": "C_kwDOP2Zrm9oAKDNiNGEyYjhkZWIyNzUyMjc4Zjg5MDNkN2YwYzIzZDNmODFiYjljNDU",
  "commit": {
    "author": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-10-26T12:26:54Z"
    },
    "committer": {
      "name": "lexicalmathical",
      "email": "lexicalmathical@gmail.com",
      "date": "2025-10-26T12:26:54Z"
    },
    "message": "Add meta prompt system and state-based emotional context\n\nThis commit introduces a comprehensive prompt hierarchy system and multiple UX improvements:\n\n**Meta Prompt System:**\n- Add global meta prompt that applies to all voice personas\n- Integrate with existing import/export/use-default system\n- Thread meta prompt through chat and comment analysis flows\n- Default emphasizes mental well-being over pure role-playing\n\n**State Chooser System:**\n- Add emotional state selection widget (default: happy, ok, unhappy)\n- Implement three-tier prompt hierarchy: Meta ‚Üí State ‚Üí Voice\n- Add persistent but collapsible state chooser UI\n- Store selected state in localStorage for session continuity\n- Allow full configuration of states in settings pane\n\n**Settings Page Reorganization:**\n- Restructure settings with fixed header and scrollable content\n- Add three sections: Meta Prompt, User States, Voice Personas\n- Implement unified import/export including all three systems\n- Add auto-scroll to bottom when adding new voice\n\n**UI/UX Improvements:**\n- Add subtle pulse animation to chat send button when processing\n- Fix dropdown auto-scroll to follow keyboard navigation\n- Remove dropdown bottom-to-top cycling behavior\n- Fix scroll jump bug using manual position calculation\n\n**Backend Integration:**\n- Thread state_prompt through server.py and stateless_analyzer.py\n- Add debugging logs for meta_prompt and state_prompt\n- Update both chat_with_voice and analyze_text endpoints\n\n**Reactivity Fixes:**\n- Fix useCallback dependency arrays to include selectedState and stateConfig\n- Ensure state changes immediately affect existing chat widgets\n\nFiles modified:\n- Backend: server.py, stateless_analyzer.py\n- Frontend: App.tsx, voiceApi.ts, VoiceSettings.tsx, EditorEngine.ts\n- Frontend: AgentDropdown.tsx, ChatWidgetUI.tsx, voice.ts, voiceStorage.ts\n- New: StateChooser.tsx\n\nü§ñ Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>",
    "tree": {
      "sha": "9bf7b2551446e75eabe5a61097c4eb5d4d99265b",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/trees/9bf7b2551446e75eabe5a61097c4eb5d4d99265b"
    },
    "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/git/commits/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null,
      "verified_at": null
    }
  },
  "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
  "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
  "comments_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "a4eb52998c60b0de1bbf875423f681091b5eb39a",
      "url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/commits/a4eb52998c60b0de1bbf875423f681091b5eb39a",
      "html_url": "https://github.com/shuxueshuxue/ink-and-memory/commit/a4eb52998c60b0de1bbf875423f681091b5eb39a"
    }
  ],
  "stats": {
    "total": 711,
    "additions": 674,
    "deletions": 37
  },
  "files": [
    {
      "sha": "6e6549fb5d6e82a258f5b162f4375ea45d3dd56d",
      "filename": "backend/server.py",
      "status": "modified",
      "additions": 30,
      "deletions": 5,
      "changes": 35,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/backend%2Fserver.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/backend%2Fserver.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fserver.py?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -15,11 +15,13 @@\n         \"voice_config\": {\"type\": \"dict\"},\n         \"conversation_history\": {\"type\": \"list\"},\n         \"user_message\": {\"type\": \"str\"},\n-        \"original_text\": {\"type\": \"str\"}\n+        \"original_text\": {\"type\": \"str\"},\n+        \"meta_prompt\": {\"type\": \"str\"},\n+        \"state_prompt\": {\"type\": \"str\"}\n     },\n     category=\"Chat\"\n )\n-def chat_with_voice(voice_name: str, voice_config: dict, conversation_history: list, user_message: str, original_text: str = \"\"):\n+def chat_with_voice(voice_name: str, voice_config: dict, conversation_history: list, user_message: str, original_text: str = \"\", meta_prompt: str = \"\", state_prompt: str = \"\"):\n     \"\"\"\n     Chat with a specific voice persona.\n \n@@ -29,6 +31,7 @@ def chat_with_voice(voice_name: str, voice_config: dict, conversation_history: l\n         conversation_history: Previous messages in the conversation\n         user_message: The user's new message\n         original_text: The user's original writing text\n+        meta_prompt: Additional instructions that apply to all voices\n \n     Returns:\n         Dictionary with assistant's response\n@@ -38,6 +41,8 @@ def chat_with_voice(voice_name: str, voice_config: dict, conversation_history: l\n     print(f\"   Voice: {voice_name}\")\n     print(f\"   User message: {user_message}\")\n     print(f\"   History length: {len(conversation_history)}\")\n+    print(f\"   Meta prompt: {repr(meta_prompt)[:100]}\")\n+    print(f\"   State prompt: {repr(state_prompt)[:100]}\")\n     print(f\"{'='*60}\\n\")\n \n     agent = PolyAgent(id=f\"voice-chat-{voice_name.lower()}\")\n@@ -66,6 +71,20 @@ def chat_with_voice(voice_name: str, voice_config: dict, conversation_history: l\n \n Your initial comment was about this text. Keep this context in mind when responding to the user's questions.\"\"\"\n \n+    # Add meta prompt if available\n+    if meta_prompt and meta_prompt.strip():\n+        system_prompt += f\"\"\"\n+\n+Additional instructions:\n+{meta_prompt.strip()}\"\"\"\n+\n+    # @@@ Add state prompt if available (between meta and voice-specific)\n+    if state_prompt and state_prompt.strip():\n+        system_prompt += f\"\"\"\n+\n+User's current state:\n+{state_prompt.strip()}\"\"\"\n+\n     # Build full prompt with conversation history\n     prompt = system_prompt + \"\\n\\nConversation history:\\n\"\n \n@@ -99,11 +118,13 @@ def chat_with_voice(voice_name: str, voice_config: dict, conversation_history: l\n         \"text\": {\"type\": \"str\"},\n         \"session_id\": {\"type\": \"str\"},\n         \"voices\": {\"type\": \"dict\"},\n-        \"applied_comments\": {\"type\": \"list\"}\n+        \"applied_comments\": {\"type\": \"list\"},\n+        \"meta_prompt\": {\"type\": \"str\"},\n+        \"state_prompt\": {\"type\": \"str\"}\n     },\n     category=\"Analysis\"\n )\n-def analyze_text(text: str, session_id: str, voices: dict = None, applied_comments: list = None):\n+def analyze_text(text: str, session_id: str, voices: dict = None, applied_comments: list = None, meta_prompt: str = \"\", state_prompt: str = \"\"):\n     \"\"\"\n     Stateless analysis - returns ONE new comment based on text and applied comments.\n \n@@ -112,6 +133,8 @@ def analyze_text(text: str, session_id: str, voices: dict = None, applied_commen\n         session_id: Session ID (for future use)\n         voices: Voice configuration\n         applied_comments: List of already applied comments (to avoid duplicates)\n+        meta_prompt: Additional instructions that apply to all voices\n+        state_prompt: User's current emotional state prompt\n \n     Returns:\n         Dictionary with single new voice (or empty list)\n@@ -120,12 +143,14 @@ def analyze_text(text: str, session_id: str, voices: dict = None, applied_commen\n     print(f\"üéØ Stateless analyze_text() called\")\n     print(f\"   Text: {text[:100]}...\")\n     print(f\"   Applied comments: {len(applied_comments or [])}\")\n+    print(f\"   Meta prompt: {repr(meta_prompt)[:100]}\")\n+    print(f\"   State prompt: {repr(state_prompt)[:100]}\")\n     print(f\"{'='*60}\\n\")\n \n     agent = PolyAgent(id=\"voice-analyzer\")\n \n     # Get voices from stateless analyzer\n-    result = analyze_stateless(agent, text, applied_comments or [], voices)\n+    result = analyze_stateless(agent, text, applied_comments or [], voices, meta_prompt, state_prompt)\n \n     print(f\"‚úÖ Returning {result['new_voices_added']} new voice(s)\")\n "
    },
    {
      "sha": "8a9c71f5c8ff676b8cc5d6313e642a615d8fbfd1",
      "filename": "backend/stateless_analyzer.py",
      "status": "modified",
      "additions": 17,
      "deletions": 1,
      "changes": 18,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/backend%2Fstateless_analyzer.py",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/backend%2Fstateless_analyzer.py",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/backend%2Fstateless_analyzer.py?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -16,7 +16,7 @@ class VoiceTrigger(BaseModel):\n class SingleVoiceAnalysis(BaseModel):\n     voice: Optional[VoiceTrigger] = Field(description=\"Single voice trigger, or None if nothing to comment\")\n \n-def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict], voices: dict = None) -> dict:\n+def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict], voices: dict = None, meta_prompt: str = \"\", state_prompt: str = \"\") -> dict:\n     \"\"\"\n     Stateless analysis - receives applied comments, returns ONE new comment.\n \n@@ -25,6 +25,8 @@ def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict],\n         text: Text to analyze (completed sentences only)\n         applied_comments: List of already applied comments (to avoid duplicates)\n         voices: Voice configuration\n+        meta_prompt: Additional instructions that apply to all voices\n+        state_prompt: User's current emotional state prompt\n \n     Returns:\n         Dict with single new voice (or empty list if none)\n@@ -76,6 +78,20 @@ def analyze_stateless(agent: PolyAgent, text: str, applied_comments: List[dict],\n - Only comment on complete sentences (ending with .!?„ÄÇÔºÅÔºü)\n - Write in the SAME LANGUAGE as the text\"\"\"\n \n+    # @@@ Add meta prompt if available\n+    if meta_prompt and meta_prompt.strip():\n+        prompt += f\"\"\"\n+\n+Additional instructions:\n+{meta_prompt.strip()}\"\"\"\n+\n+    # @@@ Add state prompt if available\n+    if state_prompt and state_prompt.strip():\n+        prompt += f\"\"\"\n+\n+User's current state:\n+{state_prompt.strip()}\"\"\"\n+\n     print(\"ü§ñ Calling LLM for one new comment...\")\n \n     result = agent.run("
    },
    {
      "sha": "f88cf6f6df0e6c98aaac2465e7340a8a03da3269",
      "filename": "frontend/src/App.tsx",
      "status": "modified",
      "additions": 53,
      "deletions": 5,
      "changes": 58,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2FApp.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2FApp.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2FApp.tsx?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -17,8 +17,9 @@ import AnalysisView from './components/AnalysisView';\n import AboutView from './components/AboutView';\n import AgentDropdown from './components/AgentDropdown';\n import ChatWidgetUI from './components/ChatWidgetUI';\n+import StateChooser from './components/StateChooser';\n import type { VoiceConfig } from './types/voice';\n-import { getVoices } from './utils/voiceStorage';\n+import { getVoices, getMetaPrompt, getStateConfig } from './utils/voiceStorage';\n import { getDefaultVoices, chatWithVoice } from './api/voiceApi';\n \n // @@@ Left Toolbar Component - floating toolbelt within left margin\n@@ -265,6 +266,12 @@ export default function App() {\n   // @@@ Warning dialog state\n   const [showWarning, setShowWarning] = useState(false);\n \n+  // @@@ State chooser\n+  const [selectedState, setSelectedState] = useState<string | null>(\n+    () => localStorage.getItem('selected-state')\n+  );\n+  const [stateConfig, setStateConfig] = useState(() => getStateConfig());\n+\n   // @@@ Per-cell textarea refs for positioning and style calculations\n   const textareaRefs = useRef<Map<string, HTMLTextAreaElement>>(new Map());\n   const containerRef = useRef<HTMLDivElement>(null);\n@@ -326,6 +333,13 @@ export default function App() {\n     }\n   }, [voiceConfigs]);\n \n+  // @@@ Reload state config when returning to writing view\n+  useEffect(() => {\n+    if (currentView === 'writing') {\n+      setStateConfig(getStateConfig());\n+    }\n+  }, [currentView]);\n+\n   // Initialize engine\n   useEffect(() => {\n     const sessionId = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString();\n@@ -584,6 +598,13 @@ export default function App() {\n       return next;\n     });\n \n+    // @@@ Auto-resize textarea to prevent internal scrolling\n+    const textarea = textareaRefs.current.get(cellId);\n+    if (textarea) {\n+      textarea.style.height = 'auto';\n+      textarea.style.height = textarea.scrollHeight + 'px';\n+    }\n+\n     // Close dropdown if @ was deleted in the trigger cell\n     if (dropdownVisible && dropdownTriggerCellId === cellId) {\n       if (!newText.includes('@')) {\n@@ -646,9 +667,15 @@ export default function App() {\n \n   const confirmStartFresh = useCallback(() => {\n     localStorage.removeItem('ink_memory_state');\n+    localStorage.removeItem('selected-state');\n     window.location.reload();\n   }, []);\n \n+  const handleStateChoose = useCallback((stateId: string) => {\n+    setSelectedState(stateId);\n+    localStorage.setItem('selected-state', stateId);\n+  }, []);\n+\n   // @@@ Insert @ character at the end of last text cell\n   const handleInsertAgent = useCallback(() => {\n     if (!state || !engineRef.current) return;\n@@ -770,12 +797,18 @@ export default function App() {\n         .join('');\n \n       // Call backend - use voiceConfig.name as the voice name for the prompt\n+      const metaPrompt = getMetaPrompt();\n+      const statePrompt = selectedState && stateConfig.states[selectedState]\n+        ? stateConfig.states[selectedState].prompt\n+        : '';\n       const response = await chatWithVoice(\n         widgetData.voiceConfig.name,  // Use the display name, not the key\n         widgetData.voiceConfig,\n         chatWidget.getConversationHistory().slice(0, -1), // Exclude last message (just added)\n         message,\n-        allText\n+        allText,\n+        metaPrompt,\n+        statePrompt\n       );\n \n       // Add assistant response\n@@ -792,7 +825,7 @@ export default function App() {\n         return next;\n       });\n     }\n-  }, [state]);\n+  }, [state, selectedState, stateConfig]);\n \n   // @@@ Handle deleting chat widget\n   const handleChatDelete = useCallback((widgetId: string) => {\n@@ -935,6 +968,15 @@ export default function App() {\n                   position: 'relative',\n                   maxWidth: '600px'\n                 }}>\n+                  {/* State chooser widget - always shown, collapses when state selected */}\n+                  <div style={{ marginBottom: 24 }}>\n+                    <StateChooser\n+                      stateConfig={stateConfig}\n+                      selectedState={selectedState}\n+                      onChoose={handleStateChoose}\n+                    />\n+                  </div>\n+\n                   {/* Render cells sequentially with per-cell highlights */}\n                   {state.cells.map((cell, idx) => {\n                     if (cell.type === 'text') {\n@@ -972,6 +1014,9 @@ export default function App() {\n                                   refsReadyTriggered.current = true;\n                                   setRefsReady(prev => prev + 1);\n                                 }\n+                                // @@@ Force height to match scrollHeight to prevent internal scrolling\n+                                el.style.height = 'auto';\n+                                el.style.height = el.scrollHeight + 'px';\n                               } else {\n                                 textareaRefs.current.delete(cell.id);\n                               }\n@@ -986,7 +1031,6 @@ export default function App() {\n                             onKeyUp={(e) => handleCursorChange(cell.id, e)}\n                             onKeyDown={(e) => handleKeyDown(cell.id, e)}\n                             placeholder={idx === 0 ? \"Start writing...\" : \"Continue writing...\"}\n-                            rows={lineCount}\n                             style={{\n                               width: '100%',\n                               border: 'none',\n@@ -1002,7 +1046,11 @@ export default function App() {\n                               zIndex: 1,\n                               marginBottom: '0px',\n                               overflow: 'hidden',\n-                              minHeight: '32px'\n+                              overflowWrap: 'break-word',\n+                              wordWrap: 'break-word',\n+                              whiteSpace: 'pre-wrap',\n+                              minHeight: '32px',\n+                              height: 'auto'\n                             }}\n                           />\n                         </div>"
    },
    {
      "sha": "a87d719558ff00c2c44468955190c7e40f7f7c4e",
      "filename": "frontend/src/api/voiceApi.ts",
      "status": "modified",
      "additions": 10,
      "deletions": 6,
      "changes": 16,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fapi%2FvoiceApi.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fapi%2FvoiceApi.ts?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -40,14 +40,14 @@ interface StatusResponse {\n /**\n  * Trigger voice analysis session\n  */\n-export async function triggerAnalysis(text: string, sessionId: string, voices?: any, appliedComments?: any[]): Promise<string> {\n+export async function triggerAnalysis(text: string, sessionId: string, voices?: any, appliedComments?: any[], metaPrompt?: string, statePrompt?: string): Promise<string> {\n   console.log('üì§ Sending trigger request...');\n   const response = await fetch(`${API_BASE}/api/trigger`, {\n     method: 'POST',\n     headers: { 'Content-Type': 'application/json' },\n     body: JSON.stringify({\n       session_id: 'analyze_text',\n-      params: { text, session_id: sessionId, voices, applied_comments: appliedComments || [] }\n+      params: { text, session_id: sessionId, voices, applied_comments: appliedComments || [], meta_prompt: metaPrompt || '', state_prompt: statePrompt || '' }\n     })\n   });\n \n@@ -99,8 +99,8 @@ export async function getAnalysisResult(exec_id: string): Promise<StatusResponse\n /**\n  * Analyze text and return voices with metadata (all-in-one)\n  */\n-export async function analyzeText(text: string, sessionId: string, voices?: any, appliedComments?: any[]) {\n-  const exec_id = await triggerAnalysis(text, sessionId, voices, appliedComments);\n+export async function analyzeText(text: string, sessionId: string, voices?: any, appliedComments?: any[], metaPrompt?: string, statePrompt?: string) {\n+  const exec_id = await triggerAnalysis(text, sessionId, voices, appliedComments, metaPrompt, statePrompt);\n   const result = await getAnalysisResult(exec_id);\n   // @@@ Return both voices and new_voices_added for energy refund mechanism\n   return {\n@@ -117,7 +117,9 @@ export async function chatWithVoice(\n   voiceConfig: any,\n   conversationHistory: Array<{ role: string; content: string }>,\n   userMessage: string,\n-  originalText?: string\n+  originalText?: string,\n+  metaPrompt?: string,\n+  statePrompt?: string\n ): Promise<string> {\n   console.log('üí¨ Sending chat request to backend...');\n \n@@ -132,7 +134,9 @@ export async function chatWithVoice(\n         voice_config: voiceConfig,\n         conversation_history: conversationHistory,\n         user_message: userMessage,\n-        original_text: originalText || ''\n+        original_text: originalText || '',\n+        meta_prompt: metaPrompt || '',\n+        state_prompt: statePrompt || ''\n       }\n     })\n   });"
    },
    {
      "sha": "be6a89e0f509d9f2627b39805158e5ebc7926175",
      "filename": "frontend/src/components/AgentDropdown.tsx",
      "status": "modified",
      "additions": 38,
      "deletions": 2,
      "changes": 40,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fcomponents%2FAgentDropdown.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fcomponents%2FAgentDropdown.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FAgentDropdown.tsx?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -31,6 +31,8 @@ interface AgentDropdownProps {\n export default function AgentDropdown({ voices, position, onSelect, onClose }: AgentDropdownProps) {\n   const enabledVoices = Object.entries(voices).filter(([_, cfg]) => cfg.enabled);\n   const [selectedIndex, setSelectedIndex] = React.useState(0);\n+  const containerRef = React.useRef<HTMLDivElement>(null);\n+  const itemRefs = React.useRef<Map<number, HTMLDivElement>>(new Map());\n \n   // Keyboard navigation\n   React.useEffect(() => {\n@@ -40,10 +42,10 @@ export default function AgentDropdown({ voices, position, onSelect, onClose }: A\n         onClose();\n       } else if (e.key === 'ArrowDown') {\n         e.preventDefault();\n-        setSelectedIndex(prev => (prev + 1) % enabledVoices.length);\n+        setSelectedIndex(prev => Math.min(prev + 1, enabledVoices.length - 1));\n       } else if (e.key === 'ArrowUp') {\n         e.preventDefault();\n-        setSelectedIndex(prev => (prev - 1 + enabledVoices.length) % enabledVoices.length);\n+        setSelectedIndex(prev => Math.max(prev - 1, 0));\n       } else if (e.key === 'Enter') {\n         e.preventDefault();\n         const [name, cfg] = enabledVoices[selectedIndex];\n@@ -54,6 +56,32 @@ export default function AgentDropdown({ voices, position, onSelect, onClose }: A\n     return () => document.removeEventListener('keydown', handleKeyDown);\n   }, [onClose, enabledVoices, selectedIndex, onSelect]);\n \n+  // @@@ Auto-scroll to selected item\n+  React.useEffect(() => {\n+    const selectedItem = itemRefs.current.get(selectedIndex);\n+    const container = containerRef.current;\n+\n+    if (selectedItem && container) {\n+      const itemRect = selectedItem.getBoundingClientRect();\n+      const containerRect = container.getBoundingClientRect();\n+\n+      // Calculate positions relative to container\n+      const itemTop = selectedItem.offsetTop;\n+      const itemBottom = itemTop + selectedItem.offsetHeight;\n+      const containerScrollTop = container.scrollTop;\n+      const containerHeight = container.clientHeight;\n+\n+      // Only scroll if item is not fully visible\n+      if (itemTop < containerScrollTop) {\n+        // Item is above visible area - scroll up\n+        container.scrollTop = itemTop;\n+      } else if (itemBottom > containerScrollTop + containerHeight) {\n+        // Item is below visible area - scroll down\n+        container.scrollTop = itemBottom - containerHeight;\n+      }\n+    }\n+  }, [selectedIndex]);\n+\n   if (enabledVoices.length === 0) {\n     return (\n       <div style={{\n@@ -77,6 +105,7 @@ export default function AgentDropdown({ voices, position, onSelect, onClose }: A\n \n   return (\n     <div\n+      ref={containerRef}\n       style={{\n         position: 'fixed',\n         left: `${position.x}px`,\n@@ -98,6 +127,13 @@ export default function AgentDropdown({ voices, position, onSelect, onClose }: A\n         return (\n           <div\n             key={name}\n+            ref={(el) => {\n+              if (el) {\n+                itemRefs.current.set(idx, el);\n+              } else {\n+                itemRefs.current.delete(idx);\n+              }\n+            }}\n             onClick={() => onSelect(name, cfg)}\n             onMouseEnter={() => setSelectedIndex(idx)}\n             style={{"
    },
    {
      "sha": "9b268acdb1570194b5e7885a06c71fcb59cd23d4",
      "filename": "frontend/src/components/ChatWidgetUI.tsx",
      "status": "modified",
      "additions": 22,
      "deletions": 1,
      "changes": 23,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fcomponents%2FChatWidgetUI.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fcomponents%2FChatWidgetUI.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FChatWidgetUI.tsx?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -5,6 +5,26 @@ import {\n   FaFistRaised, FaLightbulb, FaShieldAlt, FaWind, FaFire, FaCompass\n } from 'react-icons/fa';\n \n+// @@@ Inject CSS keyframes for button pulse animation\n+if (typeof document !== 'undefined') {\n+  const styleId = 'chat-widget-pulse-animation';\n+  if (!document.getElementById(styleId)) {\n+    const style = document.createElement('style');\n+    style.id = styleId;\n+    style.textContent = `\n+      @keyframes pulse {\n+        0%, 100% {\n+          opacity: 0.5;\n+        }\n+        50% {\n+          opacity: 1;\n+        }\n+      }\n+    `;\n+    document.head.appendChild(style);\n+  }\n+}\n+\n const iconMap = {\n   brain: FaBrain,\n   heart: FaHeart,\n@@ -243,7 +263,8 @@ export default function ChatWidgetUI({ data, onSendMessage, onDelete, isProcessi\n             fontWeight: 500,\n             cursor: isProcessing || !inputValue.trim() ? 'not-allowed' : 'pointer',\n             transition: 'all 0.2s',\n-            fontFamily: 'system-ui'\n+            fontFamily: 'system-ui',\n+            animation: isProcessing ? 'pulse 1.5s ease-in-out infinite' : 'none'\n           }}\n           onMouseEnter={(e) => {\n             if (!isProcessing && inputValue.trim()) {"
    },
    {
      "sha": "d254a030ba084c8fc501ffe47ac73a39f8d6c7d2",
      "filename": "frontend/src/components/StateChooser.tsx",
      "status": "added",
      "additions": 143,
      "deletions": 0,
      "changes": 143,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fcomponents%2FStateChooser.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fcomponents%2FStateChooser.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FStateChooser.tsx?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -0,0 +1,143 @@\n+import { useState } from 'react';\n+import type { StateConfig } from '../types/voice';\n+\n+interface Props {\n+  stateConfig: StateConfig;\n+  selectedState: string | null;\n+  onChoose: (stateId: string) => void;\n+}\n+\n+export default function StateChooser({ stateConfig, selectedState, onChoose }: Props) {\n+  const [isExpanded, setIsExpanded] = useState(!selectedState);\n+\n+  const selectedStateData = selectedState ? stateConfig.states[selectedState] : null;\n+\n+  return (\n+    <div style={{\n+      padding: '16px 20px',\n+      background: 'linear-gradient(135deg, #fffef9 0%, #f8f0e6 100%)',\n+      border: '1px solid #d0c4b0',\n+      borderRadius: 8,\n+      boxShadow: '0 1px 4px rgba(0,0,0,0.08)',\n+      fontFamily: \"'Excalifont', 'Xiaolai', 'Georgia', serif\"\n+    }}>\n+      {/* Compact view when state is selected */}\n+      {selectedStateData && !isExpanded ? (\n+        <div style={{\n+          display: 'flex',\n+          alignItems: 'center',\n+          justifyContent: 'space-between',\n+          gap: 12\n+        }}>\n+          <div style={{\n+            display: 'flex',\n+            alignItems: 'center',\n+            gap: 12,\n+            flex: 1\n+          }}>\n+            <span style={{\n+              fontSize: 13,\n+              color: '#666',\n+              fontWeight: 500\n+            }}>\n+              Current state:\n+            </span>\n+            <span style={{\n+              fontSize: 14,\n+              fontWeight: 600,\n+              color: '#333',\n+              padding: '4px 12px',\n+              background: '#fff',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: 4\n+            }}>\n+              {selectedStateData.name}\n+            </span>\n+          </div>\n+          <button\n+            onClick={() => setIsExpanded(true)}\n+            style={{\n+              padding: '6px 14px',\n+              fontSize: 12,\n+              fontWeight: 500,\n+              border: '1px solid #d0c4b0',\n+              background: '#fff',\n+              borderRadius: 4,\n+              cursor: 'pointer',\n+              transition: 'all 0.2s',\n+              color: '#333'\n+            }}\n+            onMouseEnter={(e) => {\n+              e.currentTarget.style.background = '#f0f0f0';\n+            }}\n+            onMouseLeave={(e) => {\n+              e.currentTarget.style.background = '#fff';\n+            }}\n+          >\n+            Change\n+          </button>\n+        </div>\n+      ) : (\n+        /* Expanded view - choose state */\n+        <>\n+          <p style={{\n+            margin: '0 0 16px 0',\n+            fontSize: 15,\n+            color: '#333',\n+            textAlign: 'center',\n+            lineHeight: 1.5,\n+            fontWeight: 500\n+          }}>\n+            {stateConfig.greeting}\n+          </p>\n+          <div style={{\n+            display: 'flex',\n+            gap: 10,\n+            justifyContent: 'center',\n+            flexWrap: 'wrap'\n+          }}>\n+            {Object.entries(stateConfig.states).map(([id, state]) => {\n+              const isSelected = id === selectedState;\n+              return (\n+                <button\n+                  key={id}\n+                  onClick={() => {\n+                    onChoose(id);\n+                    setIsExpanded(false);\n+                  }}\n+                  style={{\n+                    padding: '10px 20px',\n+                    fontSize: 14,\n+                    fontWeight: isSelected ? 600 : 500,\n+                    border: isSelected ? '2px solid #666' : '1px solid #d0c4b0',\n+                    background: isSelected ? '#fff' : '#fff',\n+                    borderRadius: 6,\n+                    cursor: 'pointer',\n+                    transition: 'all 0.2s',\n+                    minWidth: '90px',\n+                    color: '#333',\n+                    boxShadow: isSelected ? '0 2px 6px rgba(0,0,0,0.12)' : 'none'\n+                  }}\n+                  onMouseEnter={(e) => {\n+                    if (!isSelected) {\n+                      e.currentTarget.style.background = '#f8f0e6';\n+                      e.currentTarget.style.borderColor = '#999';\n+                    }\n+                  }}\n+                  onMouseLeave={(e) => {\n+                    if (!isSelected) {\n+                      e.currentTarget.style.background = '#fff';\n+                      e.currentTarget.style.borderColor = '#d0c4b0';\n+                    }\n+                  }}\n+                >\n+                  {state.name}\n+                </button>\n+              );\n+            })}\n+          </div>\n+        </>\n+      )}\n+    </div>\n+  );\n+}"
    },
    {
      "sha": "96dd03e1ffb7b6a93c6739f8a27568b753d6ab62",
      "filename": "frontend/src/components/VoiceSettings.tsx",
      "status": "modified",
      "additions": 301,
      "deletions": 15,
      "changes": 316,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fcomponents%2FVoiceSettings.tsx",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fcomponents%2FVoiceSettings.tsx",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fcomponents%2FVoiceSettings.tsx?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -1,6 +1,6 @@\n-import { useState, useEffect } from 'react';\n-import type { VoiceConfig } from '../types/voice';\n-import { getVoices, saveVoices, clearVoices } from '../utils/voiceStorage';\n+import { useState, useEffect, useRef } from 'react';\n+import type { VoiceConfig, StateConfig, UserState } from '../types/voice';\n+import { getVoices, saveVoices, clearVoices, getMetaPrompt, saveMetaPrompt, getStateConfig, saveStateConfig } from '../utils/voiceStorage';\n \n // @@@ Display mappings (text name ‚Üí visual)\n const COLORS = {\n@@ -24,7 +24,10 @@ interface Props {\n \n export default function VoiceSettings({ defaultVoices, onSave }: Props) {\n   const [voices, setVoices] = useState<Record<string, VoiceConfig>>({});\n+  const [metaPrompt, setMetaPrompt] = useState<string>('');\n+  const [stateConfig, setStateConfig] = useState<StateConfig>(getStateConfig());\n   const [saveStatus, setSaveStatus] = useState<'idle' | 'saved'>('idle');\n+  const scrollContainerRef = useRef<HTMLDivElement>(null);\n \n   // @@@ Sync with defaultVoices prop (handles async fetch + Use Default button)\n   useEffect(() => {\n@@ -34,8 +37,15 @@ export default function VoiceSettings({ defaultVoices, onSave }: Props) {\n     }\n   }, [defaultVoices]);\n \n+  // @@@ Load meta prompt from localStorage\n+  useEffect(() => {\n+    setMetaPrompt(getMetaPrompt());\n+  }, []);\n+\n   const handleSave = () => {\n     saveVoices(voices);\n+    saveMetaPrompt(metaPrompt);\n+    saveStateConfig(stateConfig);\n     onSave(voices);\n     setSaveStatus('saved');\n     setTimeout(() => setSaveStatus('idle'), 2000);\n@@ -46,10 +56,14 @@ export default function VoiceSettings({ defaultVoices, onSave }: Props) {\n     console.log('Current voices:', voices);\n     console.log('Default voices:', defaultVoices);\n     clearVoices();\n+    localStorage.removeItem('meta-prompt');\n+    localStorage.removeItem('state-config');\n     // Deep copy to force React to re-render\n     const freshDefaults = JSON.parse(JSON.stringify(defaultVoices));\n     console.log('Fresh defaults:', freshDefaults);\n     setVoices(freshDefaults);\n+    setMetaPrompt(getMetaPrompt());\n+    setStateConfig(getStateConfig());\n     onSave(freshDefaults);\n   };\n \n@@ -65,6 +79,16 @@ export default function VoiceSettings({ defaultVoices, onSave }: Props) {\n         color: 'blue'\n       }\n     });\n+\n+    // Scroll to bottom after adding\n+    setTimeout(() => {\n+      if (scrollContainerRef.current) {\n+        scrollContainerRef.current.scrollTo({\n+          top: scrollContainerRef.current.scrollHeight,\n+          behavior: 'smooth'\n+        });\n+      }\n+    }, 100);\n   };\n \n   const handleDelete = (id: string) => {\n@@ -82,7 +106,13 @@ export default function VoiceSettings({ defaultVoices, onSave }: Props) {\n   };\n \n   const handleExport = () => {\n-    const blob = new Blob([JSON.stringify(voices, null, 2)], { type: 'application/json' });\n+    // @@@ Export voices, meta prompt, and state config\n+    const data = {\n+      voices,\n+      metaPrompt,\n+      stateConfig\n+    };\n+    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n     const url = URL.createObjectURL(blob);\n     const a = document.createElement('a');\n     a.href = url;\n@@ -99,41 +129,296 @@ export default function VoiceSettings({ defaultVoices, onSave }: Props) {\n       if (file) {\n         file.text().then(text => {\n           const imported = JSON.parse(text);\n-          setVoices(imported);\n-          saveVoices(imported);\n-          onSave(imported);\n+          // @@@ Support old format (just voices) and new format (voices + metaPrompt + stateConfig)\n+          const importedVoices = imported.voices || imported;\n+          const importedMetaPrompt = imported.metaPrompt || '';\n+          const importedStateConfig = imported.stateConfig || getStateConfig();\n+          setVoices(importedVoices);\n+          setMetaPrompt(importedMetaPrompt);\n+          setStateConfig(importedStateConfig);\n+          saveVoices(importedVoices);\n+          saveMetaPrompt(importedMetaPrompt);\n+          saveStateConfig(importedStateConfig);\n+          onSave(importedVoices);\n         });\n       }\n     };\n     input.click();\n   };\n \n+  const handleAddState = () => {\n+    const newId = `state_${Date.now()}`;\n+    setStateConfig({\n+      ...stateConfig,\n+      states: {\n+        ...stateConfig.states,\n+        [newId]: { name: 'New State', prompt: '' }\n+      }\n+    });\n+  };\n+\n+  const handleDeleteState = (id: string) => {\n+    const { [id]: _, ...rest } = stateConfig.states;\n+    setStateConfig({ ...stateConfig, states: rest });\n+  };\n+\n+  const handleUpdateState = (id: string, field: keyof UserState, value: string) => {\n+    setStateConfig({\n+      ...stateConfig,\n+      states: {\n+        ...stateConfig.states,\n+        [id]: { ...stateConfig.states[id], [field]: value }\n+      }\n+    });\n+  };\n+\n   return (\n     <div style={{ flex: 1, display: 'flex', flexDirection: 'column', background: '#f8f0e6', overflow: 'hidden' }}>\n-      <div style={{ padding: '20px 32px', background: '#f8f0e6', flexShrink: 0 }}>\n-        <div style={{ display: 'flex', gap: 8 }}>\n-          <button onClick={handleAdd} style={{ padding: '6px 12px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer' }}>+ Add</button>\n-          <button onClick={handleImport} style={{ padding: '6px 12px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer' }}>Import</button>\n-          <button onClick={handleExport} style={{ padding: '6px 12px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer' }}>Export</button>\n-          <button onClick={handleDefault} style={{ padding: '6px 12px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer' }}>Use Default</button>\n+      {/* Fixed Header - Function Bar */}\n+      <div style={{\n+        padding: '16px 24px',\n+        background: '#fff',\n+        borderBottom: '2px solid #d0c4b0',\n+        boxShadow: '0 2px 4px rgba(0,0,0,0.05)',\n+        flexShrink: 0\n+      }}>\n+        <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\n+          <button onClick={handleAdd} style={{ padding: '8px 16px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer', fontSize: 13 }}>+ Add Voice</button>\n+          <button onClick={handleImport} style={{ padding: '8px 16px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer', fontSize: 13 }}>Import</button>\n+          <button onClick={handleExport} style={{ padding: '8px 16px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer', fontSize: 13 }}>Export</button>\n+          <button onClick={handleDefault} style={{ padding: '8px 16px', border: '1px solid #ccc', background: '#fffef9', borderRadius: 4, cursor: 'pointer', fontSize: 13 }}>Use Default</button>\n+          <div style={{ flex: 1 }} />\n           <button\n             onClick={handleSave}\n             style={{\n-              padding: '6px 12px',\n+              padding: '8px 20px',\n               border: saveStatus === 'saved' ? '1px solid #27ae60' : '1px solid #666',\n               background: saveStatus === 'saved' ? '#27ae60' : '#333',\n               color: '#fff',\n               borderRadius: 4,\n               cursor: 'pointer',\n               fontWeight: 'bold',\n+              fontSize: 13,\n               transition: 'all 0.3s'\n             }}\n           >\n             {saveStatus === 'saved' ? '‚úì Saved!' : 'Save'}\n           </button>\n         </div>\n       </div>\n-      <div style={{ flex: 1, overflowY: 'auto', padding: 32, display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 20, alignContent: 'start', background: '#f8f0e6' }}>\n+\n+      {/* Scrollable Content Area */}\n+      <div ref={scrollContainerRef} style={{ flex: 1, overflowY: 'auto', padding: '24px', background: '#f8f0e6' }}>\n+        {/* Meta Prompt Section */}\n+        <div style={{\n+          marginBottom: 24,\n+          padding: 20,\n+          background: '#fffef9',\n+          border: '1px solid #d0c4b0',\n+          borderRadius: 6,\n+          boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n+        }}>\n+          <h3 style={{\n+            margin: '0 0 12px 0',\n+            fontSize: 15,\n+            fontWeight: 600,\n+            color: '#333',\n+            letterSpacing: '-0.01em'\n+          }}>\n+            Meta Prompt\n+          </h3>\n+          <p style={{\n+            margin: '0 0 12px 0',\n+            fontSize: 12,\n+            color: '#666',\n+            lineHeight: 1.5\n+          }}>\n+            Global instructions applied to all voice personas (affects both comments and chat)\n+          </p>\n+          <textarea\n+            value={metaPrompt}\n+            onChange={e => setMetaPrompt(e.target.value)}\n+            placeholder=\"e.g., Be honest and pragmatic. Prioritize mental well-being over theatrical commentary...\"\n+            style={{\n+              width: '100%',\n+              minHeight: 100,\n+              padding: 12,\n+              fontSize: 13,\n+              fontFamily: 'monospace',\n+              border: '1px solid #d0c4b0',\n+              borderRadius: 4,\n+              background: '#fff',\n+              resize: 'vertical',\n+              boxSizing: 'border-box',\n+              lineHeight: 1.6\n+            }}\n+          />\n+        </div>\n+\n+        {/* User States Section */}\n+        <div style={{\n+          marginBottom: 24,\n+          padding: 20,\n+          background: '#fffef9',\n+          border: '1px solid #d0c4b0',\n+          borderRadius: 6,\n+          boxShadow: '0 1px 3px rgba(0,0,0,0.08)'\n+        }}>\n+          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n+            <h3 style={{\n+              margin: 0,\n+              fontSize: 15,\n+              fontWeight: 600,\n+              color: '#333',\n+              letterSpacing: '-0.01em'\n+            }}>\n+              User States\n+            </h3>\n+            <button\n+              onClick={handleAddState}\n+              style={{\n+                padding: '4px 12px',\n+                fontSize: 12,\n+                border: '1px solid #d0c4b0',\n+                background: '#fff',\n+                borderRadius: 4,\n+                cursor: 'pointer'\n+              }}\n+            >\n+              + Add State\n+            </button>\n+          </div>\n+          <p style={{\n+            margin: '0 0 16px 0',\n+            fontSize: 12,\n+            color: '#666',\n+            lineHeight: 1.5\n+          }}>\n+            Configure states shown at startup, each with a specific prompt context\n+          </p>\n+\n+          {/* Greeting */}\n+          <div style={{ marginBottom: 16 }}>\n+            <label style={{\n+              display: 'block',\n+              fontSize: 12,\n+              fontWeight: 600,\n+              color: '#333',\n+              marginBottom: 6\n+            }}>\n+              Greeting Message\n+            </label>\n+            <input\n+              type=\"text\"\n+              value={stateConfig.greeting}\n+              onChange={e => setStateConfig({ ...stateConfig, greeting: e.target.value })}\n+              placeholder=\"e.g., How are you feeling today?\"\n+              style={{\n+                width: '100%',\n+                padding: 8,\n+                fontSize: 13,\n+                border: '1px solid #d0c4b0',\n+                borderRadius: 4,\n+                background: '#fff',\n+                boxSizing: 'border-box'\n+              }}\n+            />\n+          </div>\n+\n+          {/* States */}\n+          <div style={{ display: 'grid', gap: 12 }}>\n+            {Object.entries(stateConfig.states).map(([id, state]) => (\n+              <div key={id} style={{\n+                padding: 12,\n+                background: '#f8f0e6',\n+                border: '1px solid #d0c4b0',\n+                borderRadius: 4,\n+                position: 'relative'\n+              }}>\n+                <button\n+                  onClick={() => handleDeleteState(id)}\n+                  style={{\n+                    position: 'absolute',\n+                    top: 8,\n+                    right: 8,\n+                    background: 'none',\n+                    border: 'none',\n+                    cursor: 'pointer',\n+                    fontSize: 14\n+                  }}\n+                  title=\"Delete\"\n+                >\n+                  üóëÔ∏è\n+                </button>\n+\n+                <div style={{ marginBottom: 8 }}>\n+                  <label style={{\n+                    display: 'block',\n+                    fontSize: 11,\n+                    fontWeight: 600,\n+                    color: '#666',\n+                    marginBottom: 4\n+                  }}>\n+                    State Name (shown to user)\n+                  </label>\n+                  <input\n+                    type=\"text\"\n+                    value={state.name}\n+                    onChange={e => handleUpdateState(id, 'name', e.target.value)}\n+                    placeholder=\"e.g., Happy\"\n+                    style={{\n+                      width: '100%',\n+                      padding: 6,\n+                      fontSize: 13,\n+                      border: '1px solid #d0c4b0',\n+                      borderRadius: 4,\n+                      background: '#fff',\n+                      boxSizing: 'border-box'\n+                    }}\n+                  />\n+                </div>\n+\n+                <div>\n+                  <label style={{\n+                    display: 'block',\n+                    fontSize: 11,\n+                    fontWeight: 600,\n+                    color: '#666',\n+                    marginBottom: 4\n+                  }}>\n+                    State Prompt (added to voice context)\n+                  </label>\n+                  <textarea\n+                    value={state.prompt}\n+                    onChange={e => handleUpdateState(id, 'prompt', e.target.value)}\n+                    placeholder=\"e.g., The user is feeling positive and energized...\"\n+                    style={{\n+                      width: '100%',\n+                      minHeight: 60,\n+                      padding: 8,\n+                      fontSize: 12,\n+                      fontFamily: 'monospace',\n+                      border: '1px solid #d0c4b0',\n+                      borderRadius: 4,\n+                      background: '#fff',\n+                      resize: 'vertical',\n+                      boxSizing: 'border-box',\n+                      lineHeight: 1.4\n+                    }}\n+                  />\n+                </div>\n+              </div>\n+            ))}\n+          </div>\n+        </div>\n+\n+        {/* Voice Personas Grid */}\n+        <div style={{\n+          display: 'grid',\n+          gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))',\n+          gap: 20,\n+          alignContent: 'start'\n+        }}>\n         {Object.entries(voices).map(([id, voice]) => (\n           <div key={id} style={{ padding: 12, border: '1px solid #d0c4b0', borderRadius: 4, position: 'relative', background: '#fffef9' }}>\n             <button\n@@ -190,6 +475,7 @@ export default function VoiceSettings({ defaultVoices, onSave }: Props) {\n             />\n           </div>\n         ))}\n+        </div>\n       </div>\n     </div>\n   );"
    },
    {
      "sha": "4bbadd2ea2603003feaeb888ac86db52a138d96b",
      "filename": "frontend/src/engine/EditorEngine.ts",
      "status": "modified",
      "additions": 11,
      "deletions": 1,
      "changes": 12,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fengine%2FEditorEngine.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Fengine%2FEditorEngine.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Fengine%2FEditorEngine.ts?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -260,6 +260,7 @@ export class EditorEngine {\n     try {\n       // Call backend (returns ONLY ONE comment at a time)\n       const { analyzeText } = await import('../api/voiceApi');\n+      const { getMetaPrompt, getStateConfig } = await import('../utils/voiceStorage');\n \n       // Convert voiceConfigs to backend format\n       const backendVoices: Record<string, any> = {};\n@@ -276,7 +277,16 @@ export class EditorEngine {\n \n       // Send only APPLIED commentors to backend\n       const appliedCommentors = this.state.commentors.filter(c => c.appliedAt);\n-      const result = await analyzeText(text, this.state.sessionId, backendVoices, appliedCommentors);\n+      const metaPrompt = getMetaPrompt();\n+\n+      // Get state prompt from localStorage\n+      const selectedState = localStorage.getItem('selected-state');\n+      const stateConfig = getStateConfig();\n+      const statePrompt = selectedState && stateConfig.states[selectedState]\n+        ? stateConfig.states[selectedState].prompt\n+        : '';\n+\n+      const result = await analyzeText(text, this.state.sessionId, backendVoices, appliedCommentors, metaPrompt, statePrompt);\n \n       // Backend returns at most ONE voice\n       if (result.voices.length > 0) {"
    },
    {
      "sha": "cee2487df923571f58e94c73a7c34b871cd4f2b2",
      "filename": "frontend/src/types/voice.ts",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Ftypes%2Fvoice.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Ftypes%2Fvoice.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Ftypes%2Fvoice.ts?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -5,3 +5,13 @@ export interface VoiceConfig {\n   icon: string;\n   color: string;\n }\n+\n+export interface UserState {\n+  name: string;\n+  prompt: string;\n+}\n+\n+export interface StateConfig {\n+  greeting: string;\n+  states: Record<string, UserState>;\n+}"
    },
    {
      "sha": "209f53a69d0a74638f9441f71363de1aa289aa37",
      "filename": "frontend/src/utils/voiceStorage.ts",
      "status": "modified",
      "additions": 39,
      "deletions": 1,
      "changes": 40,
      "blob_url": "https://github.com/shuxueshuxue/ink-and-memory/blob/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Futils%2FvoiceStorage.ts",
      "raw_url": "https://github.com/shuxueshuxue/ink-and-memory/raw/3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45/frontend%2Fsrc%2Futils%2FvoiceStorage.ts",
      "contents_url": "https://api.github.com/repos/shuxueshuxue/ink-and-memory/contents/frontend%2Fsrc%2Futils%2FvoiceStorage.ts?ref=3b4a2b8deb2752278f8903d7f0c23d3f81bb9c45",
      "patch": "@@ -1,6 +1,30 @@\n-import type { VoiceConfig } from '../types/voice';\n+import type { VoiceConfig, StateConfig } from '../types/voice';\n \n const KEY = 'voice-customizations';\n+const META_PROMPT_KEY = 'meta-prompt';\n+const STATE_CONFIG_KEY = 'state-config';\n+\n+// @@@ Default meta prompt: honest, pragmatic advice over role-playing fluff\n+const DEFAULT_META_PROMPT = `Be honest and pragmatic. This is not actual Disco Elysium - prioritize the user's mental well-being and genuine insight over pure role-playing. Offer constructive perspectives that help with real thinking and writing, not just theatrical commentary.`;\n+\n+// @@@ Default state configuration\n+const DEFAULT_STATE_CONFIG: StateConfig = {\n+  greeting: \"How are you feeling today?\",\n+  states: {\n+    happy: {\n+      name: \"Happy\",\n+      prompt: \"The user is feeling positive and energized. Encourage creative exploration and bold ideas.\"\n+    },\n+    ok: {\n+      name: \"OK\",\n+      prompt: \"The user is feeling neutral. Provide balanced, steady guidance.\"\n+    },\n+    unhappy: {\n+      name: \"Unhappy\",\n+      prompt: \"The user is feeling down. Be gentle, supportive, and focus on small wins.\"\n+    }\n+  }\n+};\n \n export const getVoices = (): Record<string, VoiceConfig> | null =>\n   JSON.parse(localStorage.getItem(KEY) || 'null');\n@@ -9,3 +33,17 @@ export const saveVoices = (voices: Record<string, VoiceConfig>) =>\n   localStorage.setItem(KEY, JSON.stringify(voices));\n \n export const clearVoices = () => localStorage.removeItem(KEY);\n+\n+export const getMetaPrompt = (): string =>\n+  localStorage.getItem(META_PROMPT_KEY) || DEFAULT_META_PROMPT;\n+\n+export const saveMetaPrompt = (prompt: string) =>\n+  localStorage.setItem(META_PROMPT_KEY, prompt);\n+\n+export const getStateConfig = (): StateConfig => {\n+  const stored = localStorage.getItem(STATE_CONFIG_KEY);\n+  return stored ? JSON.parse(stored) : DEFAULT_STATE_CONFIG;\n+};\n+\n+export const saveStateConfig = (config: StateConfig) =>\n+  localStorage.setItem(STATE_CONFIG_KEY, JSON.stringify(config));"
    }
  ]
}